var log={debug:(...args)=>{const isDev=typeof window!=="undefined"&&window.__TAURI__&&!window.__TAURI__.__currentWindow?.label?.includes("app.");if(isDev){console.log(...args)}},info:(...args)=>{console.log(...args)},warn:(...args)=>{console.warn(...args)},error:(...args)=>{console.error(...args)}};class SiteRegistry{static instance;adapters=new Map;currentAdapter=null;constructor(){}static getInstance(){if(!SiteRegistry.instance){SiteRegistry.instance=new SiteRegistry}return SiteRegistry.instance}register(adapter){this.adapters.set(adapter.id,adapter)}registerAll(adapters){adapters.forEach((adapter)=>this.register(adapter))}getCurrentAdapter(){if(this.currentAdapter){const adapter=this.currentAdapter;if(adapter.matchesCurrentDomain&&adapter.matchesCurrentDomain()){return adapter}}for(const adapter of this.adapters.values()){if(adapter.matchesCurrentDomain&&adapter.matchesCurrentDomain()){this.currentAdapter=adapter;return adapter}}this.currentAdapter=null;log.warn("[SiteRegistry] No matching adapter found for current site");return null}getAdapter(id){return this.adapters.get(id)}getAllAdapters(){return Array.from(this.adapters.values())}isReaderPage(){const adapter=this.getCurrentAdapter();return adapter?adapter.isReaderPage():false}isHomePage(){const adapter=this.getCurrentAdapter();return adapter?adapter.isHomePage():false}getReaderMenuItems(){const adapter=this.getCurrentAdapter();if(adapter&&adapter.getReaderMenuItems){return adapter.getReaderMenuItems()}return["reader_wide","hide_toolbar","auto_flip"]}}var getSiteRegistry=()=>SiteRegistry.getInstance();class BaseSiteAdapter{matchesCurrentDomain(){const hostname=window.location.hostname;const domains=Array.isArray(this.domain)?this.domain:[this.domain];return domains.some((domain)=>hostname===domain||hostname.endsWith(`.${domain}`))}matchesPath(pattern){const pathname=window.location.pathname;const href=window.location.href;if(typeof pattern==="string"){return pathname.includes(pattern)||href.includes(pattern)}else{return pattern.test(pathname)||pattern.test(href)}}triggerKey(key){const event=new KeyboardEvent("keydown",{key,code:key==="Right"?"ArrowRight":key==="Left"?"ArrowLeft":key,keyCode:key==="Right"?39:key==="Left"?37:0,bubbles:true,cancelable:true});document.dispatchEvent(event)}clickElement(selector){const element=document.querySelector(selector);if(element){element.click();return true}return false}}class EventBusImpl{listeners=new Map;eventHistory=new Map;MAX_HISTORY=10;currentModuleId=null;setModuleContext(moduleId){this.currentModuleId=moduleId}clearModuleContext(){this.currentModuleId=null}on(event,callback,options={}){const{once=false,signal,moduleId=null}=options;if(signal?.aborted){console.debug(`[EventBus] Signal already aborted, skip subscription: ${event}`);return()=>{}}let eventListeners=this.listeners.get(event);if(!eventListeners){eventListeners=new Set;this.listeners.set(event,eventListeners)}const wrapper={callback,once,moduleId};for(const existing of eventListeners){if(existing.callback===callback){console.debug(`[EventBus] 监听器已存在，跳过: ${event}`);return()=>this.off(event,callback)}}eventListeners.add(wrapper);if(signal){signal.addEventListener("abort",()=>{this.off(event,callback)},{once:true})}return()=>this.off(event,callback)}onWithHistory(event,callback,options={}){const{once=false}=options;const history2=this.eventHistory.get(event);let historyReplayed=false;if(history2&&history2.length>0){const latest=history2[history2.length-1];console.debug(`[EventBus] 回放历史事件: ${event}`,latest.data);try{callback(latest.data);historyReplayed=true}catch(error){console.error(`[EventBus] 历史回放时回调执行出错:`,error)}}if(once&&historyReplayed){console.debug(`[EventBus] once + onWithHistory 且历史已回放，跳过订阅: ${event}`);return()=>{}}const unsubscribe=this.on(event,callback,options);return unsubscribe}once(event,callback){return this.on(event,callback,{once:true})}off(event,callback){const eventListeners=this.listeners.get(event);if(!eventListeners)return;for(const wrapper of eventListeners){if(wrapper.callback===callback){eventListeners.delete(wrapper);break}}if(eventListeners.size===0){this.listeners.delete(event)}}emit(event,data){console.debug(`[EventBus] 触发事件: ${event}`,data);this.recordHistory(event,data);const eventListeners=this.listeners.get(event);if(!eventListeners||eventListeners.size===0){console.debug(`[EventBus] 事件 ${event} 没有监听器`);return}const listeners=Array.from(eventListeners);for(const wrapper of listeners){try{wrapper.callback(data);if(wrapper.once){eventListeners.delete(wrapper)}}catch(error){console.error(`[EventBus] 事件 ${event} 的监听器执行出错:`,error)}}}recordHistory(event,data){let history2=this.eventHistory.get(event);if(!history2){history2=[];this.eventHistory.set(event,history2)}history2.push({data,timestamp:Date.now()});if(history2.length>this.MAX_HISTORY){history2.shift()}}getLatestEvent(event){const history2=this.eventHistory.get(event);if(!history2||history2.length===0){return null}return history2[history2.length-1].data}getEventHistory(event){const history2=this.eventHistory.get(event);return history2?[...history2]:[]}cleanup(moduleId){let cleaned=0;for(const[event,listeners]of this.listeners){for(const wrapper of listeners){if(wrapper.moduleId===moduleId){listeners.delete(wrapper);cleaned++}}if(listeners.size===0){this.listeners.delete(event)}}if(cleaned>0){console.debug(`[EventBus] 清理模块 ${moduleId} 的 ${cleaned} 个监听器`)}}clearHistory(event){if(event){this.eventHistory.delete(event)}else{this.eventHistory.clear()}}getListenerCount(){let count=0;for(const listeners of this.listeners.values()){count+=listeners.size}return count}getStats(){const stats={};for(const[event,listeners]of this.listeners){stats[event]=listeners.size}return stats}getKnownEvents(){return Array.from(this.eventHistory.keys())}}var EventBus=new EventBusImpl;var Events={ROUTE_CHANGED:"ipc:route-changed",CHAPTER_CHANGED:"ipc:chapter-changed",TITLE_CHANGED:"ipc:title-changed",PROGRESS_UPDATED:"wxrd:progress-updated",PAGE_TURN_DIRECTION:"wxrd:page-turn-direction",DOUBLE_COLUMN_CHANGED:"wxrd:double-column-changed",SETTINGS_UPDATED:"settings-updated",TAURI_WINDOW_EVENT:"tauri://window-event"};var nextManagerId=0;class BaseManager{moduleId;destroyed=false;abortController=null;constructor(){const className=this.constructor.name;this.moduleId=`${className}_${++nextManagerId}`;this.abortController=new AbortController}on(event,callback,options){if(this.destroyed){console.warn(`[${this.moduleId}] 尝试在已销毁的模块上订阅事件: ${event}`);return()=>{}}return EventBus.on(event,callback,{...options,signal:this.abortController?.signal,moduleId:this.moduleId})}onWithHistory(event,callback){if(this.destroyed){console.warn(`[${this.moduleId}] 尝试在已销毁的模块上订阅事件: ${event}`);return()=>{}}return EventBus.onWithHistory(event,callback,{signal:this.abortController?.signal,moduleId:this.moduleId})}once(event,callback){return this.on(event,callback,{once:true})}emit(event,data){if(this.destroyed){console.warn(`[${this.moduleId}] 尝试在已销毁的模块上触发事件: ${event}`);return}EventBus.emit(event,data)}destroy(){if(this.destroyed){console.warn(`[${this.moduleId}] 模块已销毁，重复调用 destroy()`);return}if(this.abortController){this.abortController.abort();this.abortController=null}EventBus.cleanup(this.moduleId);this.destroyed=true}isDestroyed(){return this.destroyed}}class ProgressTracker extends BaseManager{bookInfoCache=new Map;currentBookId=null;currentChapterIdx=0;currentProgress=0;turningPages=0;isInitializing=false;lastEventPriority=1;lastEventTime=0;EVENT_DEBOUNCE_MS=100;pendingDirection=null;lastPageDirection=null;lastDirectionTime=0;pageDirectionTimer=null;DIRECTION_DEBOUNCE_MS=500;domReadyHandler=null;keydownHandler=null;constructor(){super();this.init()}init(){this.onWithHistory(Events.ROUTE_CHANGED,(e)=>{if(e.isReader){const bookId=this.extractBookIdFromUrl(e.url);if(bookId){if(this.currentBookId!==bookId){this.onEnterReaderPage(bookId)}}}});this.on(Events.CHAPTER_CHANGED,(e)=>{if(this.currentBookId){this.onChapterChange(this.currentBookId,e.url)}});this.on(Events.PAGE_TURN_DIRECTION,(data)=>{const pageDirection=data.direction==="forward"?1:-1;this.recordPageDirection(pageDirection)});this.domReadyHandler=()=>{this.checkCurrentPage()};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",this.domReadyHandler,{once:true})}else{this.domReadyHandler()}this.initPageTurnMonitor()}checkCurrentPage(){const currentUrl=window.location.href;if(window.location.pathname.includes("/web/reader/")){const bookId=this.extractBookIdFromUrl(currentUrl);if(bookId){this.onEnterReaderPage(bookId)}}}async onEnterReaderPage(bookId){if(!this.shouldExecuteEvent(3)){return}if(!bookId){console.error("[ProgressTracker] bookId 为空，无法初始化");return}if(this.isInitializing){return}this.isInitializing=true;try{const chapterInfos=await this.fetchAndCacheChapterInfo(bookId);if(!chapterInfos){console.warn("[ProgressTracker] 无法获取章节信息");return}const readInfo=await this.fetchReadInfo(bookId);if(!readInfo||readInfo.chapterIdx===undefined||readInfo.chapterOffset===undefined){console.warn("[ProgressTracker] 无法获取初始阅读进度");return}this.currentBookId=bookId;this.currentChapterIdx=readInfo.chapterIdx;const currentChapterInfo=chapterInfos.find((ch)=>ch.chapterIdx===readInfo.chapterIdx);if(!currentChapterInfo){console.warn(`[ProgressTracker] 找不到当前章节信息，chapterIdx=${readInfo.chapterIdx}`);return}const initialProgressPercent=Math.floor(readInfo.chapterOffset/currentChapterInfo.maxOffset*100);this.currentProgress=initialProgressPercent;this.turningPages=Math.floor(currentChapterInfo.maxPages*(initialProgressPercent/100));this.updateProgressBar(this.currentProgress)}finally{this.isInitializing=false}}async onChapterChange(bookId,newUrl){if(!this.shouldExecuteEvent(2)){return}if(!bookId){console.warn("[ProgressTracker] 无法获取 bookId，跳过章节切换处理");return}const chapterInfos=this.bookInfoCache.get(bookId);if(!chapterInfos){console.warn("[ProgressTracker] 无章节信息缓存，无法处理章节切换");return}const DIRECTION_VALID_MS=1e4;const now=Date.now();const isDirectionValid=this.lastPageDirection!==null&&now-this.lastDirectionTime<DIRECTION_VALID_MS;if(!isDirectionValid){await this.reinitializeAfterJump(bookId);return}const isForward=this.lastPageDirection===1;const oldChapterIdx=this.currentChapterIdx;await this.applyCorrectionAlgorithm(bookId,oldChapterIdx,isForward);let newChapterIdx;if(isForward){newChapterIdx=oldChapterIdx+1}else{newChapterIdx=oldChapterIdx-1}const newChapterInfo=chapterInfos.find((ch)=>ch.chapterIdx===newChapterIdx);if(!newChapterInfo){console.warn(`[ProgressTracker] 找不到新章节信息: chapterIdx=${newChapterIdx}`);return}this.currentChapterIdx=newChapterIdx;if(isForward){this.turningPages=0;this.currentProgress=0}else{this.turningPages=newChapterInfo.maxPages;this.currentProgress=100}this.updateProgressBar(this.currentProgress);this.lastPageDirection=null;this.pendingDirection=null;if(this.pageDirectionTimer){clearTimeout(this.pageDirectionTimer);this.pageDirectionTimer=null}}async reinitializeAfterJump(bookId){const chapterInfos=this.bookInfoCache.get(bookId);if(!chapterInfos){console.warn("[ProgressTracker] 无章节缓存，无法匹配");return}await this.waitForTitleUpdate();const pageTitle=document.title;let matchedChapter=null;for(const chapter of chapterInfos){if(pageTitle.includes(chapter.title)){matchedChapter=chapter;break}}if(!matchedChapter){console.warn("[ProgressTracker] 无法从 Title 匹配章节");return}this.currentChapterIdx=matchedChapter.chapterIdx;this.turningPages=0;this.currentProgress=0;this.updateProgressBar(this.currentProgress)}async waitForTitleUpdate(){return new Promise((resolve)=>{let attempts=0;const maxAttempts=10;const checkTitle=()=>{attempts++;if(document.title.includes(" - ")||attempts>=maxAttempts){resolve()}else{setTimeout(checkTitle,100)}};checkTitle()})}async applyCorrectionAlgorithm(bookId,oldChapterIdx,isForward){const chapterInfos=this.bookInfoCache.get(bookId);if(!chapterInfos){return}const oldChapterInfo=chapterInfos.find((ch)=>ch.chapterIdx===oldChapterIdx);if(!oldChapterInfo){return}console.log(`[ProgressTracker] 修正算法检查 (${isForward?"正读":"倒读"}): turningPages=${this.turningPages}, maxPages=${oldChapterInfo.maxPages}`);if(oldChapterInfo.maxPages<6){console.log("[ProgressTracker] 章节页数 < 6，跳过修正");return}let actualMaxPages;if(isForward){actualMaxPages=this.turningPages}else{actualMaxPages=oldChapterInfo.maxPages-this.turningPages}const difference=Math.abs(actualMaxPages-oldChapterInfo.maxPages);const ratio=difference/oldChapterInfo.maxPages;if(ratio>0.2){const scale=actualMaxPages/oldChapterInfo.maxPages;let modifiedCount=0;for(const chapter of chapterInfos){const newMaxPages=Math.floor(chapter.maxPages*scale);if(newMaxPages!==chapter.maxPages&&newMaxPages>0){chapter.maxPages=newMaxPages;modifiedCount++}}const percentage=(modifiedCount/chapterInfos.length*100).toFixed(1);console.log(`[ProgressTracker] 修正完成: ${percentage}% 章节已修正 (${modifiedCount}/${chapterInfos.length}), 比例=${scale.toFixed(3)}`)}}lastPageTurnTime=0;pageTurnMonitorInitialized=false;initPageTurnMonitor(){if(this.pageTurnMonitorInitialized){return}this.pageTurnMonitorInitialized=true;this.keydownHandler=(e)=>{if(e.key==="ArrowRight"){console.log("[ProgressTracker] 键盘右键 → 记录向前方向");this.recordPageDirection(1)}else if(e.key==="ArrowLeft"){console.log("[ProgressTracker] 键盘左键 → 记录向后方向");this.recordPageDirection(-1)}};window.addEventListener("keydown",this.keydownHandler)}recordPageDirection(direction){this.pendingDirection=direction;if(this.pageDirectionTimer){clearTimeout(this.pageDirectionTimer)}this.pageDirectionTimer=setTimeout(()=>{if(this.pendingDirection!==null){this.lastPageDirection=this.pendingDirection;this.lastDirectionTime=Date.now();this.pendingDirection=null}this.processPageTurn()},this.DIRECTION_DEBOUNCE_MS)}handlePageTurn(){}processPageTurn(){if(!this.shouldExecuteEvent(1)){return}if(this.lastPageDirection===null){return}if(this.lastPageDirection===1){this.turningPages++}else{this.turningPages--}this.updateProgressFromTurningPages();console.log(`[ProgressTracker] 翻页: direction=${this.lastPageDirection===1?"向前":"向回"}, `+`turningPages=${this.turningPages}, progress=${this.currentProgress}%`)}updateProgressFromTurningPages(){const chapterInfos=this.bookInfoCache.get(this.currentBookId);if(!chapterInfos){return}const currentChapterInfo=chapterInfos.find((ch)=>ch.chapterIdx===this.currentChapterIdx);if(!currentChapterInfo){return}const newProgress=Math.round(this.turningPages/currentChapterInfo.maxPages*100);this.currentProgress=newProgress;this.updateProgressBar(this.currentProgress)}shouldExecuteEvent(priority){const now=Date.now();if(now-this.lastEventTime<this.EVENT_DEBOUNCE_MS){if(priority<this.lastEventPriority){console.log(`[ProgressTracker] 事件被抑制：优先级=${priority}, 上次优先级=${this.lastEventPriority}`);return false}}this.lastEventPriority=priority;this.lastEventTime=now;return true}extractBookIdFromUrl(url){const match=url.match(/\/web\/reader\/([^/]+)/);if(!match){console.warn("[ProgressTracker] 无法从 URL 提取 bookId:",url);return null}return this.getNumericBookId()}getNumericBookId(){const jsonLdScript=document.querySelector('script[type="application/ld+json"]');if(jsonLdScript&&jsonLdScript.textContent){try{const data=JSON.parse(jsonLdScript.textContent);if(data["@Id"]){return String(data["@Id"])}}catch(e){}}if(window.bookId){return String(window.bookId)}return null}async fetchAndCacheChapterInfo(bookId){if(this.bookInfoCache.has(bookId)){console.log(`[ProgressTracker] 从缓存读取章节信息，bookId: ${bookId}`);return this.bookInfoCache.get(bookId)}const cookies=document.cookie;const hasVid=cookies.includes("wr_vid")||cookies.includes("wr_localvid");if(!hasVid){console.log("[ProgressTracker] 用户未登录，跳过获取章节信息");return null}try{console.log(`[ProgressTracker] 从 API 获取章节信息，bookId: ${bookId}`);const response=await fetch("https://weread.qq.com/web/book/chapterInfos",{method:"POST",credentials:"include",headers:{Accept:"application/json, text/plain, */*","Accept-Language":"zh-CN,zh;q=0.9","Content-Type":"application/json"},body:JSON.stringify({bookIds:[bookId],syncKeys:[0],teenmode:0})});if(!response.ok){console.warn(`[ProgressTracker] 章节信息 API 请求失败: ${response.status}`);return null}const data=await response.json();if(data.errCode&&data.errCode!==0){console.warn(`[ProgressTracker] 章节信息 API 错误: ${data.errCode}`);return null}if(data.data&&data.data[0]){const rawChapters=data.data[0].updated||[];const chapterInfos=rawChapters.map((ch)=>{const maxOffset=ch.wordCount*1.5+1000;const maxPages=Math.floor(maxOffset/800);return{chapterIdx:ch.chapterIdx,title:ch.title||"",wordCount:ch.wordCount,maxOffset,maxPages}});this.bookInfoCache.set(bookId,chapterInfos);console.log(`[ProgressTracker] 成功缓存 ${chapterInfos.length} 个章节信息`);return chapterInfos}return null}catch(error){console.error("[ProgressTracker] 获取章节信息失败:",error);return null}}async fetchReadInfo(bookId){try{const response=await fetch(`https://weread.qq.com/web/book/getProgress?bookId=${bookId}&_=${Date.now()}`,{method:"GET",credentials:"include",headers:{Accept:"application/json, text/plain, */*","Accept-Language":"zh-CN,zh;q=0.9"}});if(!response.ok){return null}const data=await response.json();if(data.errCode&&data.errCode!==0){return null}if(data.book){return{chapterIdx:data.book.chapterIdx,chapterOffset:data.book.chapterOffset}}return null}catch(error){console.error("[ProgressTracker] 获取阅读进度失败:",error);return null}}updateProgressBar(progress){console.log(`[ProgressTracker] 发送进度更新事件: ${progress}%`);this.emit(Events.PROGRESS_UPDATED,{progress})}getCurrentProgress(){return this.currentProgress}destroy(){if(this.pageDirectionTimer){clearTimeout(this.pageDirectionTimer);this.pageDirectionTimer=null}if(this.domReadyHandler){document.removeEventListener("DOMContentLoaded",this.domReadyHandler);this.domReadyHandler=null}if(this.keydownHandler){window.removeEventListener("keydown",this.keydownHandler);this.keydownHandler=null}super.destroy()}}class WeReadAdapter extends BaseSiteAdapter{id="weread";name="微信读书";domain="weread.qq.com";progressTracker=null;pageTurnMonitorInitialized=false;lastPageTurnTime=0;keydownHandler=null;nextBtnHandler=null;prevBtnHandler=null;constructor(){super();this.progressTracker=new ProgressTracker}isReaderPage(){return this.matchesPath("/web/reader/")}isHomePage(){const pathname=window.location.pathname;return pathname==="/"||pathname==="/web"||pathname.startsWith("/web/shelf")}getWideModeCSS(wide){if(wide){return`
        /* 微信读书 - 宽屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 96% !important;
          max-width: calc(100vw - 224px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 80px) !important;
        }
      `}else{return`
        /* 微信读书 - 窄屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 80% !important;
          max-width: calc(100vw - 424px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(40% + 40px) !important;
        }
      `}}getToolbarCSS(hide){if(hide){return`
        /* 微信读书 - 隐藏工具栏 */
        .readerControls {
          display: none !important;
        }
        .readerTopBar,
        .app_content,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 124px) !important;
        }
      `}else{return`
        /* 微信读书 - 显示工具栏 */
        .readerControls {
          display: block !important;
        }
        .readerTopBar,
        .app_content,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 224px) !important;
        }
      `}}getNavbarCSS(hide){if(hide){return`
        /* 微信读书 - 隐藏导航栏 */
        .readerTopBar,
        .renderTarget_pager {
          display: none !important;
        }
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          margin-top: 24px !important;
          height: calc(100% - 48px) !important;
        }
      `}else{return`
        /* 微信读书 - 显示导航栏 */
        .readerTopBar,
        .renderTarget_pager {
          display: flex !important;
        }
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          margin-top: 72px !important;
          height: calc(100% - 132px) !important;
        }
      `}}getDarkThemeCSS(){return`
      html, body {
        background-color: #222222 !important;
      }
    `}getLightThemeCSS(){return`
      html, body {
        background-color: #ffffff !important;
      }
    `}initPageTurnMonitor(){if(this.pageTurnMonitorInitialized){return}this.pageTurnMonitorInitialized=true;this.keydownHandler=(e)=>{if(e.key==="ArrowRight"||e.key==="ArrowLeft"){this.handlePageTurn()}};window.addEventListener("keydown",this.keydownHandler);const addButtonListener=()=>{const nextBtn=document.querySelector(".renderTarget_pager_button_right");const prevBtn=document.querySelector(".renderTarget_pager_button");if(nextBtn&&!this.nextBtnHandler){this.nextBtnHandler=()=>this.handlePageTurn();nextBtn.addEventListener("click",this.nextBtnHandler)}if(prevBtn&&!this.prevBtnHandler){this.prevBtnHandler=()=>this.handlePageTurn();prevBtn.addEventListener("click",this.prevBtnHandler)}};if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",addButtonListener,{once:true})}else{addButtonListener()}}destroy(){if(this.keydownHandler){window.removeEventListener("keydown",this.keydownHandler);this.keydownHandler=null}if(this.nextBtnHandler){const nextBtn=document.querySelector(".renderTarget_pager_button_right");if(nextBtn){nextBtn.removeEventListener("click",this.nextBtnHandler)}this.nextBtnHandler=null}if(this.prevBtnHandler){const prevBtn=document.querySelector(".renderTarget_pager_button");if(prevBtn){prevBtn.removeEventListener("click",this.prevBtnHandler)}this.prevBtnHandler=null}if(this.progressTracker){this.progressTracker.destroy();this.progressTracker=null}}handlePageTurn(){const now=Date.now();if(now-this.lastPageTurnTime<500){return}this.lastPageTurnTime=now}async nextPage(){this.triggerKey("Right");this.handlePageTurn()}async prevPage(){this.triggerKey("Left");this.handlePageTurn()}isDoubleColumn(){return!!document.querySelector(".wr_horizontalReader")}isAtBottom(){if(this.isDoubleColumn()){return false}const totalHeight=document.documentElement.scrollHeight;const currentPos=window.innerHeight+window.scrollY;return currentPos>=totalHeight-300}getChapterProgress(){if(!this.progressTracker){return 0}return this.progressTracker.getCurrentProgress()}extractNumericBookId(){const jsonLdScript=document.querySelector('script[type="application/ld+json"]');if(jsonLdScript&&jsonLdScript.textContent){try{const data=JSON.parse(jsonLdScript.textContent);if(data["@Id"]){return data["@Id"]}}catch(e){}}if(window.bookId){return String(window.bookId)}const urlMatch=window.location.pathname.match(/\/web\/reader\/([^/]+)/);if(urlMatch){return urlMatch[1]}return null}getNextChapterSelector(){return".readerFooter_button"}clickNextChapter(){const nextButton=document.querySelector(this.getNextChapterSelector());if(nextButton){nextButton.click()}}getReaderMenuItems(){return["reader_wide","hide_toolbar","auto_flip"]}}var adapters=[WeReadAdapter];var createAdapterInstances=()=>{return adapters.map((AdapterClass)=>new AdapterClass)};class SiteContext{registry;_cachedIsDoubleColumn=null;doubleColumnListeners=new Set;doubleColumnObserver=null;observerInitialized=false;static instance=null;constructor(){this.registry=getSiteRegistry();this.initDoubleColumnObserver()}static getInstance(){if(!SiteContext.instance){SiteContext.instance=new SiteContext}return SiteContext.instance}initDoubleColumnObserver(){log.info("[SiteContext] initDoubleColumnObserver: starting initialization");if(this.observerInitialized){log.info("[SiteContext] initDoubleColumnObserver: already initialized, skipping");return}const startObserving=()=>{const oldValue=this._cachedIsDoubleColumn;const newValue=this.detectDoubleColumn();if(oldValue!==newValue){this._cachedIsDoubleColumn=newValue;this.notifyDoubleColumnChange(newValue);log.info("[SiteContext] Double column mode changed:",newValue)}};const initObserver=()=>{if(this.observerInitialized){return}this.observerInitialized=true;log.info("[SiteContext] initObserver: MutationObserver initialized");const observer=new MutationObserver(()=>{startObserving()});observer.observe(document.body,{childList:true,subtree:true,attributes:true,attributeFilter:["class"]});this.doubleColumnObserver=observer;const initialValue=this.detectDoubleColumn();this._cachedIsDoubleColumn=initialValue;log.info("[SiteContext] Initial double column value:",initialValue)};if(document.readyState==="loading"){log.info("[SiteContext] initDoubleColumnObserver: readyState is loading, waiting for DOMContentLoaded");document.addEventListener("DOMContentLoaded",initObserver)}else if(document.body){log.info("[SiteContext] initDoubleColumnObserver: DOM ready and body exists, calling initObserver immediately");initObserver()}else{log.info("[SiteContext] initDoubleColumnObserver: DOM ready but body missing, waiting for DOMContentLoaded");document.addEventListener("DOMContentLoaded",initObserver)}}detectDoubleColumn(){const adapter=this.currentAdapter;if(!adapter){return false}if(adapter.id==="weread"){const element=document.querySelector(".wr_horizontalReader");return!!element}if(adapter.isDoubleColumn){return adapter.isDoubleColumn()}return false}notifyDoubleColumnChange(isDoubleColumn){log.info("[SiteContext] notifyDoubleColumnChange: notifying",this.doubleColumnListeners.size,"listeners, isDoubleColumn=",isDoubleColumn);this.doubleColumnListeners.forEach((listener)=>{try{listener(isDoubleColumn)}catch(e){log.error("[SiteContext] Error in double column listener:",e)}})}onDoubleColumnChange(callback){this.doubleColumnListeners.add(callback);if(this._cachedIsDoubleColumn!==null){try{callback(this._cachedIsDoubleColumn)}catch(e){log.error("[SiteContext] Error in immediate double column callback:",e)}}requestAnimationFrame(()=>{setTimeout(()=>{const currentValue=this.isDoubleColumn;try{callback(currentValue)}catch(e){log.error("[SiteContext] Error in delayed double column callback:",e)}},400)});return()=>{this.doubleColumnListeners.delete(callback)}}get currentAdapter(){return this.registry.getCurrentAdapter()}get isReaderPage(){return this.registry.isReaderPage()}get isHomePage(){return this.registry.isHomePage()}get isDoubleColumn(){if(this._cachedIsDoubleColumn!==null){return this._cachedIsDoubleColumn}const value=this.detectDoubleColumn();this._cachedIsDoubleColumn=value;return value}get siteId(){const adapter=this.currentAdapter;return adapter?.id||"unknown"}}var createSiteContext=()=>{return SiteContext.getInstance()};var invoke=(cmd,args)=>{if(window.__TAURI__){return window.__TAURI__.core.invoke(cmd,args)}else{log.warn(`[Tauri] Invoke '${cmd}' failed: API not found`);return Promise.resolve({})}};var listen=(event,handler)=>{if(window.__TAURI__){return window.__TAURI__.event.listen(event,handler)}log.warn(`[Tauri] Listen '${event}' failed: API not found`);return Promise.resolve(()=>{})};var waitForTauri=()=>{return new Promise((resolve)=>{if(window.__TAURI__){resolve();return}const check=setInterval(()=>{if(window.__TAURI__){clearInterval(check);resolve()}},10);setTimeout(()=>{clearInterval(check);resolve()},2000)})};var waitForTauriReady=async()=>{await waitForTauri();const maxAttempts=100;const delay=50;for(let i=0;i<maxAttempts;i++){try{await invoke("get_app_name");log.debug(`[Tauri] IPC ready after ${i*delay}ms`);return}catch(e){if(i<maxAttempts-1){await new Promise((r)=>setTimeout(r,delay))}}}log.warn(`[Tauri] IPC not ready after ${maxAttempts*delay}ms, continuing anyway`)};var logToFile=(message)=>{if(window.__TAURI__){invoke("log_to_file",{message}).catch(()=>{})}else{log.debug(message)}};class OptimisticLock{data;version;constructor(initialData,initialVersion=0){this.data=initialData;this.version=initialVersion;this.data._version=this.version}getData(){return{...this.data}}getVersion(){return this.version}tryUpdate(partialUpdate){const newVersion=this.version+1;const newData={...this.data,...partialUpdate,_version:newVersion};this.data=newData;this.version=newVersion;return{success:true,version:newVersion,data:this.getData()}}loadFromExternal(externalData,externalVersion){if(externalVersion>=this.version){this.data={...externalData,_version:externalVersion};this.version=externalVersion;return true}return false}isStale(externalVersion){return externalVersion>this.version}forceSet(data,version){this.data={...data,_version:version};this.version=version}}class SettingsStore{static instance;lock=null;listeners=new Set;initialized=false;constructor(){}static migrateOldSettings(loaded){const isOldFormat="readerWide"in loaded||"hideToolbar"in loaded||"autoFlip"in loaded;if(!isOldFormat){return loaded}log.info("[SettingsStore] Detected old settings format, migrating to new structure...");const migratedSiteSettings={readerWide:loaded.readerWide,hideToolbar:loaded.hideToolbar,lastReaderUrl:loaded.lastReaderUrl,scrollPosition:loaded.scrollPosition,readingProgress:loaded.readingProgress,autoFlip:loaded.autoFlip};const migrated={_version:loaded._version||0,global:{zoom:loaded.zoom,autoUpdate:loaded.autoUpdate,lastPage:loaded.lastPage},sites:{weread:migratedSiteSettings}};log.info("[SettingsStore] Migration complete");return migrated}static getInstance(){if(!SettingsStore.instance){SettingsStore.instance=new SettingsStore}return SettingsStore.instance}async init(){if(this.initialized)return;try{const loaded=await invoke("get_settings")||{};const migrated=SettingsStore.migrateOldSettings(loaded);const loadedVersion=migrated._version||0;const initialSettings={_version:loadedVersion,global:{zoom:0.75,autoUpdate:true,lastPage:true,...migrated.global},sites:migrated.sites||{}};this.lock=new OptimisticLock(initialSettings,loadedVersion);log.debug("[SettingsStore] Initialized optimistic lock with version:",loadedVersion)}catch(e){log.error("SettingsStore: Failed to load settings",e);const fallbackSettings={_version:0,global:{zoom:0.75,autoUpdate:true,lastPage:true},sites:{}};this.lock=new OptimisticLock(fallbackSettings,0)}listen("settings-updated",async()=>{if(!this.lock)return;const newSettings=await invoke("get_settings")||{};const backendVersion=newSettings._version||0;log.debug("[SettingsStore] Received settings-updated event, backend version:",backendVersion,"local version:",this.lock.getVersion());const loaded=this.lock.loadFromExternal(newSettings,backendVersion);if(loaded){log.debug("[SettingsStore] Loaded newer version from backend:",backendVersion);this.notify()}else{log.debug("[SettingsStore] Ignoring older version from backend:",backendVersion,"<",this.lock.getVersion())}});this.initialized=true;this.notify()}get(){const rawSettings=this.lock?this.lock.getData():{};const siteId=createSiteContext().siteId;const siteSettings=rawSettings.sites?.[siteId]||{};return{...rawSettings,...rawSettings.global,...siteSettings}}getGlobal(){const rawSettings=this.lock?this.lock.getData():{};return rawSettings.global||{}}getSite(siteId){const rawSettings=this.lock?this.lock.getData():{};return rawSettings.sites?.[siteId]||{}}async updateGlobal(partial){const current=this.get();await this.update({global:{...current.global,...partial}})}async updateSite(siteId,partial){const current=this.get();await this.update({sites:{...current.sites,[siteId]:{...current.sites?.[siteId],...partial}}})}getCurrentSiteSettings(){return this.getSite("weread")}async updateCurrentSite(partial){return this.updateSite("weread",partial)}async update(partial){if(!this.lock){log.error("[SettingsStore] Lock not initialized");return}const{_version,...partialWithoutVersion}=partial;const globalFields=["zoom","autoUpdate","lastPage"];const siteFields=["readerWide","hideToolbar","lastReaderUrl","scrollPosition","readingProgress","autoFlip"];const current=this.lock.getData();let needsUpdate=false;let updatedSettings={...current};if("global"in partialWithoutVersion){updatedSettings.global={...current.global,...partialWithoutVersion.global};needsUpdate=true}if("sites"in partialWithoutVersion){updatedSettings.sites={...current.sites,...partialWithoutVersion.sites};needsUpdate=true}const flatUpdates={};for(const key in partialWithoutVersion){if(key!=="global"&&key!=="sites"){flatUpdates[key]=partialWithoutVersion[key]}}if(Object.keys(flatUpdates).length>0){const globalUpdates={};const siteUpdates={};for(const key in flatUpdates){if(globalFields.includes(key)){globalUpdates[key]=flatUpdates[key]}else if(siteFields.includes(key)){siteUpdates[key]=flatUpdates[key]}}if(Object.keys(globalUpdates).length>0){updatedSettings.global={...current.global,...globalUpdates};needsUpdate=true}if(Object.keys(siteUpdates).length>0){const siteId=createSiteContext().siteId;updatedSettings.sites={...current.sites,[siteId]:{...current.sites?.[siteId],...siteUpdates}};needsUpdate=true}}if(!needsUpdate)return;const result=this.lock.tryUpdate(updatedSettings);log.debug("[SettingsStore] Update: version",result.version-1,"->",result.version,"partial:",partialWithoutVersion);this.notify();const cleanSettings={_version:result.version,global:result.data.global,sites:result.data.sites};try{await invoke("save_settings",{settings:cleanSettings,version:result.version});log.debug("[SettingsStore] Saved successfully with version:",result.version)}catch(e){log.error("[SettingsStore] Failed to save settings",e);this.lock.forceSet(result.data,result.version-1);this.notify()}}subscribe(listener){this.listeners.add(listener);if(this.initialized&&this.lock){listener(this.get())}return()=>this.listeners.delete(listener)}notify(){if(!this.lock)return;const current=this.get();this.listeners.forEach((l)=>l(current))}}var settingsStore=SettingsStore.getInstance();var RESTORED_KEY="__wxrd_scroll_restored";class ScrollState{static isRestorationComplete(){return!!window[RESTORED_KEY]}static markRestorationComplete(){if(!this.isRestorationComplete()){log.debug("[ScrollState] Restoration marked as complete - unlocking save/auto-scroll");window[RESTORED_KEY]=true}}static async waitForRestoration(timeoutMs=2000){if(this.isRestorationComplete())return;return new Promise((resolve)=>{const start=Date.now();const check=()=>{if(this.isRestorationComplete()){resolve();return}if(Date.now()-start>timeoutMs){log.warn(`[ScrollState] Timeout waiting for restoration (${timeoutMs}ms)`);resolve();return}setTimeout(check,100)};check()})}}class IPCManager extends BaseManager{siteContext;currentIsReader=false;lastSavedReaderUrl="";lastSavedScrollY=0;scrollSaveTimer=null;safetyTimeout=null;originalPushState=null;originalReplaceState=null;titleObserver=null;checkRouteHandler=null;constructor(){super();this.siteContext=createSiteContext();this.init()}async init(){await settingsStore.init();this.safetyTimeout=setTimeout(()=>{if(!ScrollState.isRestorationComplete()){log.warn("[IPCManager] Force enabling scroll save after timeout");ScrollState.markRestorationComplete()}},1e4);this.monitorRoute();this.monitorTitle();this.monitorScroll()}monitorRoute(){this.checkRouteHandler=this.createRouteHandler();window.addEventListener("popstate",this.checkRouteHandler);this.originalPushState=history.pushState;history.pushState=(...args)=>{const result=this.originalPushState.apply(history,args);this.checkRouteHandler();return result};this.originalReplaceState=history.replaceState;history.replaceState=(...args)=>{const result=this.originalReplaceState.apply(history,args);this.checkRouteHandler();return result};this.checkRouteHandler()}createRouteHandler=()=>{let lastUrl=window.location.href;let lastIsReader=this.siteContext.isReaderPage;let lastTitle=document.title;return()=>{const currentUrl=window.location.href;const pathname=window.location.pathname;const isReader=this.siteContext.isReaderPage;const currentTitle=document.title;const routeChanged=lastIsReader!==isReader;lastIsReader=isReader;this.currentIsReader=isReader;const urlChanged=lastUrl!==currentUrl;const titleChanged=lastTitle!==currentTitle;const chapterChanged=isReader&&(urlChanged||titleChanged);this.handleLastPageSaving(isReader,currentUrl);if(routeChanged){const eventData={isReader,url:currentUrl,pathname};this.emit(Events.ROUTE_CHANGED,eventData);window.dispatchEvent(new CustomEvent("ipc:route-changed",{detail:eventData}));window.dispatchEvent(new CustomEvent("wxrd:route-changed",{detail:eventData}))}if(chapterChanged){const eventData={url:currentUrl,pathname};this.emit(Events.CHAPTER_CHANGED,eventData);window.dispatchEvent(new CustomEvent("ipc:chapter-changed",{detail:eventData}))}lastUrl=currentUrl;lastTitle=currentTitle}};handleLastPageSaving(isReader,currentUrl){const settings=settingsStore.get();if(settings.lastPage&&isReader){if(settings.lastReaderUrl!==currentUrl){settingsStore.update({lastReaderUrl:currentUrl})}}}monitorTitle(){const target=document.querySelector("title");if(!target)return;const dispatch=()=>{if(document.title?.trim()){const eventData={title:document.title};this.emit(Events.TITLE_CHANGED,eventData);window.dispatchEvent(new CustomEvent("ipc:title-changed",{detail:eventData}));if(this.checkRouteHandler){this.checkRouteHandler()}}};this.titleObserver=new MutationObserver(dispatch);this.titleObserver.observe(target,{childList:true,characterData:true,subtree:true});dispatch()}monitorScroll(){const scrollHandler=()=>{if(!this.currentIsReader)return;const settings=settingsStore.get();if(!settings.lastPage)return;if(this.siteContext.isDoubleColumn)return;if(!ScrollState.isRestorationComplete())return;const scrollY=window.scrollY;if(Math.abs(scrollY-this.lastSavedScrollY)<50)return;if(this.scrollSaveTimer){clearTimeout(this.scrollSaveTimer)}this.scrollSaveTimer=setTimeout(()=>{this.lastSavedScrollY=scrollY;const currentUrl=window.location.href;const currentProgress=settingsStore.get().readingProgress||{};settingsStore.update({scrollPosition:scrollY,readingProgress:{...currentProgress,[currentUrl]:scrollY}})},500)};window.addEventListener("scroll",scrollHandler,{passive:true})}destroy(){if(this.scrollSaveTimer){clearTimeout(this.scrollSaveTimer);this.scrollSaveTimer=null}if(this.safetyTimeout){clearTimeout(this.safetyTimeout);this.safetyTimeout=null}if(this.originalPushState){history.pushState=this.originalPushState;this.originalPushState=null}if(this.originalReplaceState){history.replaceState=this.originalReplaceState;this.originalReplaceState=null}if(this.titleObserver){this.titleObserver.disconnect();this.titleObserver=null}super.destroy()}}var RESTORE_FLAG_KEY="wxrd_has_restored";class AppManager{appName="艾特阅读";siteContext;pagehideHandler=null;visibilitychangeHandler=null;constructor(){this.siteContext=createSiteContext();this.init()}async init(){await waitForTauri();try{this.appName=await invoke("get_app_name")||"艾特阅读"}catch(e){log.error("Failed to get app name:",e)}await settingsStore.init();this.pagehideHandler=()=>{this.clearAutoFlipOnExit()};this.visibilitychangeHandler=()=>{if(document.visibilityState==="hidden"){this.clearAutoFlipOnExit()}};window.addEventListener("pagehide",this.pagehideHandler);document.addEventListener("visibilitychange",this.visibilitychangeHandler);await this.restoreLastPage();this.restoreScrollPosition()}clearAutoFlipOnExit(){const settings=settingsStore.get();if(settings.autoFlip?.active){log.debug("[AppManager] Clearing autoFlip.active on exit");logToFile("[AppManager] Clearing autoFlip.active on exit");settingsStore.update({autoFlip:{active:false,interval:settings.autoFlip.interval||15,keepAwake:settings.autoFlip.keepAwake!==false}})}}async restoreLastPage(){const sessionFlag=sessionStorage.getItem(RESTORE_FLAG_KEY);if(sessionFlag==="true"){return}const settings=settingsStore.get();const isReader=this.siteContext.isReaderPage;if(!isReader&&settings.lastPage&&settings.lastReaderUrl){const navMsg=`[AppManager] Restoring last page: ${settings.lastReaderUrl}`;logToFile(navMsg);log.debug("[AppManager] Restoring last page:",settings.lastReaderUrl);sessionStorage.setItem(RESTORE_FLAG_KEY,"true");window.location.href=settings.lastReaderUrl}else{sessionStorage.setItem(RESTORE_FLAG_KEY,"true")}}restoreScrollPosition(){if(ScrollState.isRestorationComplete()){return}const settings=settingsStore.get();const isReader=this.siteContext.isReaderPage;const currentUrl=window.location.href;const progressMap=settings.readingProgress||{};const targetScroll=progressMap[currentUrl]??settings.scrollPosition;if(!isReader||!settings.lastPage||targetScroll===undefined||targetScroll===null){ScrollState.markRestorationComplete();return}if(this.siteContext.isDoubleColumn){ScrollState.markRestorationComplete();return}log.debug("[AppManager] Planning to restore scroll position:",targetScroll,"for URL:",currentUrl);logToFile(`[AppManager] Planning to restore scroll position: ${targetScroll} for URL: ${currentUrl}`);let attempts=0;const maxAttempts=50;let lastHeight=0;const chaseScroll=()=>{try{const currentHeight=document.documentElement.scrollHeight;const viewportHeight=window.innerHeight;const requiredHeight=targetScroll+viewportHeight;if(currentHeight>lastHeight){attempts=0;lastHeight=currentHeight}else{attempts++}if(currentHeight>=requiredHeight){log.debug(`[AppManager] Height sufficient (${currentHeight} >= ${requiredHeight}), restoring to ${targetScroll}`);window.scrollTo({top:targetScroll,behavior:"instant"});ScrollState.markRestorationComplete();return}if(attempts<maxAttempts){window.scrollTo({top:currentHeight,behavior:"instant"});document.dispatchEvent(new Event("scroll"));try{document.dispatchEvent(new WheelEvent("wheel",{deltaY:100,bubbles:true}))}catch(e){}setTimeout(chaseScroll,100)}else{log.debug("[AppManager] Max restore attempts reached (stuck), giving up.");window.scrollTo({top:targetScroll,behavior:"instant"});ScrollState.markRestorationComplete()}}catch(e){log.error("[AppManager] Error during scroll restoration:",e);ScrollState.markRestorationComplete()}};setTimeout(chaseScroll,500)}destroy(){if(this.pagehideHandler){window.removeEventListener("pagehide",this.pagehideHandler);this.pagehideHandler=null}if(this.visibilitychangeHandler){document.removeEventListener("visibilitychange",this.visibilitychangeHandler);this.visibilitychangeHandler=null}}}function injectCSS(id,cssContent){let style=document.getElementById(id);if(!style){style=document.createElement("style");style.id=id;if(document.head){document.head.appendChild(style)}else if(document.documentElement){document.documentElement.appendChild(style)}else{const observer=new MutationObserver((mutations)=>{for(const mutation of mutations){if(mutation.addedNodes.length>0){if(document.head){document.head.appendChild(style);observer.disconnect();return}else if(document.documentElement){document.documentElement.appendChild(style);observer.disconnect();return}}}});observer.observe(document,{childList:true})}}style.innerHTML=cssContent}function removeCSS(id){const style=document.getElementById(id);if(style){style.remove()}}class CursorHider{mouseHideTimer=null;isMouseHidden=false;isScrollingOrSwiping=false;scrollLockTimer=null;lastScreenX=0;lastScreenY=0;siteContext;timerStarted=false;enabled=false;onMouseMove=null;onMouseDown=null;constructor(siteContext){this.siteContext=siteContext}setEnabled(enabled){this.enabled=enabled;if(enabled){if(!this.onMouseMove){this.init()}this.resetTimer()}else{this.showCursor();if(this.mouseHideTimer){window.clearTimeout(this.mouseHideTimer);this.mouseHideTimer=null}}log.debug(`[CursorHider] 隐藏光标功能: ${enabled?"启用":"禁用"}`)}toggle(){this.setEnabled(!this.enabled)}init(){const resetTimer=()=>{if(this.isMouseHidden){this.showCursor()}if(this.mouseHideTimer){window.clearTimeout(this.mouseHideTimer);this.mouseHideTimer=null}if(this.enabled&&this.siteContext.isReaderPage){this.mouseHideTimer=window.setTimeout(()=>{this.hideCursor()},3000);this.timerStarted=true}};this.resetTimer=resetTimer;let lastMoveTime=0;this.onMouseMove=(e)=>{if(this.isScrollingOrSwiping)return;const diffX=Math.abs(e.screenX-this.lastScreenX);const diffY=Math.abs(e.screenY-this.lastScreenY);if(diffX<15&&diffY<15){return}this.lastScreenX=e.screenX;this.lastScreenY=e.screenY;const now=Date.now();if(now-lastMoveTime>200){lastMoveTime=now;if(!this.timerStarted){this.timerStarted=true}resetTimer()}};this.onMouseDown=resetTimer;document.addEventListener("mousemove",this.onMouseMove,false);document.addEventListener("mousedown",this.onMouseDown,false)}resetTimer(){if(!this.enabled)return;if(this.isMouseHidden){this.showCursor()}if(this.mouseHideTimer){window.clearTimeout(this.mouseHideTimer);this.mouseHideTimer=null}if(this.siteContext.isReaderPage){this.mouseHideTimer=window.setTimeout(()=>{this.hideCursor()},3000);this.timerStarted=true}}setScrollLock(duration=200){this.isScrollingOrSwiping=true;if(this.scrollLockTimer){clearTimeout(this.scrollLockTimer)}this.scrollLockTimer=window.setTimeout(()=>{this.isScrollingOrSwiping=false},duration)}hideCursor(){if(this.isMouseHidden)return;if(!this.siteContext.isReaderPage)return;log.debug("[CursorHider] Hiding cursor");document.documentElement.classList.add("wxrd-hide-cursor");injectCSS("wxrd-cursor-hide",`
      html.wxrd-hide-cursor,
      html.wxrd-hide-cursor * {
        cursor: none !important;
      }
    `);this.isMouseHidden=true}showCursor(){if(!this.isMouseHidden)return;log.debug("[CursorHider] Showing cursor");document.documentElement.classList.remove("wxrd-hide-cursor");removeCSS("wxrd-cursor-hide");this.isMouseHidden=false}destroy(){this.showCursor();this.enabled=false;if(this.mouseHideTimer){window.clearTimeout(this.mouseHideTimer);this.mouseHideTimer=null}if(this.scrollLockTimer){window.clearTimeout(this.scrollLockTimer);this.scrollLockTimer=null}if(this.onMouseMove){document.removeEventListener("mousemove",this.onMouseMove,false)}if(this.onMouseDown){document.removeEventListener("mousedown",this.onMouseDown,false)}}}class SwipeHandler{swipeAccumulator=0;swipeResetTimer=null;swipeCooldown=false;siteContext;onScrollLock;handler;constructor(siteContext,onScrollLock){this.siteContext=siteContext;this.onScrollLock=onScrollLock;this.handler=(e)=>{this.onScrollLock();this.handleWheel(e)};this.init()}init(){window.addEventListener("wheel",this.handler,{passive:false,capture:true})}handleWheel(e){if(!this.siteContext.isReaderPage)return;if(!this.siteContext.isDoubleColumn)return;const adapter=this.siteContext.currentAdapter;if(!adapter)return;const deltaX=e.deltaX;const deltaY=e.deltaY;const isHorizontal=Math.abs(deltaX)>Math.abs(deltaY);if(isHorizontal){e.preventDefault()}else{return}if(this.swipeCooldown)return;if(Math.abs(deltaX)<2)return;this.swipeAccumulator+=deltaX;if(this.swipeResetTimer){clearTimeout(this.swipeResetTimer)}this.swipeResetTimer=setTimeout(()=>{this.swipeAccumulator=0},250);const THRESHOLD=50;if(this.swipeAccumulator>=THRESHOLD){log.debug("[SwipeHandler] Swipe left detected, next page");EventBus.emit(Events.PAGE_TURN_DIRECTION,{direction:"forward"});adapter.nextPage();this.swipeAccumulator=0;this.startCooldown()}else if(this.swipeAccumulator<=-THRESHOLD){log.debug("[SwipeHandler] Swipe right detected, prev page");EventBus.emit(Events.PAGE_TURN_DIRECTION,{direction:"backward"});adapter.prevPage();this.swipeAccumulator=0;this.startCooldown()}}startCooldown(){this.swipeCooldown=true;setTimeout(()=>{this.swipeCooldown=false;this.swipeAccumulator=0},800)}destroy(){if(this.swipeResetTimer){clearTimeout(this.swipeResetTimer);this.swipeResetTimer=null}window.removeEventListener("wheel",this.handler,{capture:true})}}class AutoFlipper{isActive=false;intervalSeconds=30;keepAwake=false;doubleTimer=null;singleRafId=null;lastFrameTime=0;lastScrollTime=0;accumulatedMove=0;countdown=30;originalTitle=null;appName="艾特阅读";elapsedTime=0;siteContext;bottomTriggered=false;onScrollLock;generation=0;constructor(siteContext,onScrollLock){this.siteContext=siteContext;this.onScrollLock=onScrollLock;this.initAppName()}async initAppName(){try{this.appName=await invoke("get_app_name")||"艾特阅读"}catch(e){this.appName="艾特阅读"}}updateState(settings){const autoFlip=settings.autoFlip||{active:false,interval:15,keepAwake:true};const newActive=!!autoFlip.active;const newInterval=autoFlip.interval>0?autoFlip.interval:15;const newKeepAwake=!!autoFlip.keepAwake;if(!newActive){if(this.isActive){this.stopAll();this.isActive=false}}else{if(!this.isActive||this.intervalSeconds!==newInterval||this.keepAwake!==newKeepAwake){if(this.isActive)this.stopAll();this.isActive=true;this.intervalSeconds=newInterval;this.keepAwake=newKeepAwake;this.start()}}}stopAll(){this.isActive=false;this.generation++;if(this.doubleTimer){clearInterval(this.doubleTimer);this.doubleTimer=null}if(this.singleRafId){cancelAnimationFrame(this.singleRafId);this.singleRafId=null}if(this.originalTitle){document.title=this.originalTitle;this.originalTitle=null}this.elapsedTime=0}start(){const adapter=this.siteContext.currentAdapter;if(!adapter){log.warn("[AutoFlipper] No adapter found");return}if(this.siteContext.isDoubleColumn){this.startDoubleColumnLogic(adapter)}else{this.startSingleColumnLogic(adapter)}}startDoubleColumnLogic(adapter){if(this.doubleTimer)return;if(this.singleRafId){cancelAnimationFrame(this.singleRafId);this.singleRafId=null}this.countdown=this.intervalSeconds;if(!this.originalTitle)this.originalTitle=document.title;this.doubleTimer=setInterval(()=>{if(!this.siteContext.isDoubleColumn){this.stopAll();this.startSingleColumnLogic(adapter);return}if(document.hidden&&!this.keepAwake)return;this.countdown--;document.title=`${this.appName} - 自动翻页 - ${this.countdown} 秒`;if(this.countdown<=0){this.onScrollLock();adapter.nextPage();this.countdown=this.intervalSeconds}},1000)}startSingleColumnLogic(adapter){if(this.singleRafId)return;if(this.doubleTimer){clearInterval(this.doubleTimer);this.doubleTimer=null}if(!ScrollState.isRestorationComplete()){setTimeout(()=>{if(this.isActive){this.startSingleColumnLogic(adapter)}},200);return}this.countdown=this.intervalSeconds;this.elapsedTime=0;if(!this.originalTitle)this.originalTitle=document.title;this.lastFrameTime=performance.now();this.lastScrollTime=performance.now();const currentGen=this.generation;this.singleRafId=requestAnimationFrame((time)=>this.singleColumnLoop(time,adapter,currentGen))}singleColumnLoop(time,adapter,gen){if(gen!==this.generation){return}if(!this.isActive){this.singleRafId=null;return}if(this.siteContext.isDoubleColumn){this.stopAll();this.startDoubleColumnLogic(adapter);return}let deltaTime=time-this.lastFrameTime;this.lastFrameTime=time;if(deltaTime>100){deltaTime=16;this.accumulatedMove=0}else if(deltaTime>50){deltaTime=50}this.elapsedTime+=deltaTime;if(this.elapsedTime>=1000){const scrollY=window.scrollY;const totalHeight=document.documentElement.scrollHeight;const viewportHeight=window.innerHeight;const maxScroll=Math.max(1,totalHeight-viewportHeight);const percentage=Math.min(100,Math.max(0,Math.round(scrollY/maxScroll*1000)/10));this.elapsedTime-=1000;document.title=`${this.appName} - 自动翻页 - 已读 ${percentage}%`}if(document.hidden&&!this.keepAwake){this.singleRafId=requestAnimationFrame((t)=>this.singleColumnLoop(t,adapter,gen));return}const timeSinceLastScroll=time-this.lastScrollTime;if(timeSinceLastScroll<30){this.singleRafId=requestAnimationFrame((t)=>this.singleColumnLoop(t,adapter,gen));return}this.lastScrollTime=time;const screenHeight=window.innerHeight;const validInterval=this.intervalSeconds>0?this.intervalSeconds:30;const speed=screenHeight/(validInterval*1000);const move=speed*timeSinceLastScroll;this.accumulatedMove+=move;if(this.accumulatedMove>=1){this.onScrollLock();const pixelsToScroll=Math.floor(this.accumulatedMove);window.scrollBy(0,pixelsToScroll);this.accumulatedMove-=pixelsToScroll;const isAtBottom=adapter.isAtBottom();if(isAtBottom&&!this.bottomTriggered){log.debug("[AutoFlipper] Reached bottom, triggering next page");this.bottomTriggered=true;adapter.nextPage();if(adapter.clickNextChapter){adapter.clickNextChapter()}if(this.singleRafId){cancelAnimationFrame(this.singleRafId);this.singleRafId=null}setTimeout(()=>{this.bottomTriggered=false;if(this.isActive&&this.generation===gen){this.startSingleColumnLogic(adapter)}},1e4);return}else if(!isAtBottom){this.bottomTriggered=false}}this.singleRafId=requestAnimationFrame((t)=>this.singleColumnLoop(t,adapter,gen))}}class ProgressBar extends BaseManager{siteContext;progressBarElement=null;isVisible=false;latestProgress=0;constructor(siteContext){super();this.siteContext=siteContext;this.init()}init(){console.log("[ProgressBar] Initializing, subscribing to PROGRESS_UPDATED with onWithHistory");this.onWithHistory(Events.PROGRESS_UPDATED,(data)=>{console.log(`[ProgressBar] 收到进度更新事件: ${data.progress}%`);this.latestProgress=data.progress;if(this.isVisible){const existsInDom=document.getElementById("wxrd-progress-bar-container");if(!existsInDom){console.log("[ProgressBar] 进度条元素丢失（可能被微信读书清理），重新创建");this.progressBarElement=null;this.show()}else if(this.progressBarElement){this.progressBarElement.style.width=`${data.progress}%`;console.log(`[ProgressBar] 进度条更新: ${data.progress}%`)}}});this.on(Events.CHAPTER_CHANGED,()=>{console.log("[ProgressBar] 章节切换，延迟重建进度条");if(this.isVisible){setTimeout(()=>{if(!document.getElementById("wxrd-progress-bar-container")){console.log("[ProgressBar] 章节切换后进度条丢失，重新创建");this.show()}},200)}});console.log("[ProgressBar] Subscription complete, latestProgress:",this.latestProgress)}setVisibility(shouldShow){if(shouldShow&&!this.isVisible){this.show()}else if(!shouldShow&&this.isVisible){this.hide()}}show(){const container=document.querySelector(".renderTargetContainer");if(!container){console.warn("[ProgressBar] .renderTargetContainer not found");return}console.log("[ProgressBar] .renderTargetContainer found:",container);const existingContainer=document.getElementById("wxrd-progress-bar-container");if(existingContainer){existingContainer.remove();console.log("[ProgressBar] 移除已存在的进度条容器")}this.progressBarElement=null;const progressContainer=document.createElement("div");progressContainer.id="wxrd-progress-bar-container";progressContainer.style.cssText=`
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 16px;
      background-color: rgba(0, 0, 0, 0.05);
      overflow: hidden;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      z-index: 9999;
    `;const progressBar=document.createElement("div");progressBar.id="wxrd-progress-bar";progressBar.style.cssText=`
      height: 100%;
      width: ${this.latestProgress}%;
      background-color: #349f66;
      transition: width 0.3s ease;
    `;progressContainer.appendChild(progressBar);container.appendChild(progressContainer);this.progressBarElement=progressBar;this.isVisible=true;console.log("[ProgressBar] 进度条已添加到 DOM，容器:",progressContainer);console.log("[ProgressBar] 进度条元素:",progressBar);setTimeout(()=>{const stillExists=document.getElementById("wxrd-progress-bar-container");if(!stillExists){console.error("[ProgressBar] 进度条在创建后立即被删除了！")}else{console.log("[ProgressBar] 进度条仍然存在于 DOM 中")}},100);log.info(`[ProgressBar] Progress bar shown with ${this.latestProgress}% progress`)}hide(){const container=document.querySelector("#wxrd-progress-bar-container");if(container){container.remove()}this.progressBarElement=null;this.isVisible=false;log.info("[ProgressBar] Progress bar hidden")}destroy(){this.hide();super.destroy()}}class TurnerManager{cursorHider;swipeHandler;autoFlipper;progressBar;siteContext;routeChangedHandler=null;constructor(){this.siteContext=createSiteContext();this.cursorHider=new CursorHider(this.siteContext);const onScrollLock=(duration)=>{this.cursorHider.setScrollLock(duration)};this.swipeHandler=new SwipeHandler(this.siteContext,onScrollLock);this.autoFlipper=new AutoFlipper(this.siteContext,onScrollLock);this.progressBar=new ProgressBar(this.siteContext);this.init()}init(){settingsStore.subscribe((settings)=>{this.updateState(settings)});this.siteContext.onDoubleColumnChange((isDoubleColumn)=>{this.updateProgressBarVisibility()});this.routeChangedHandler=(e)=>{const isReader=e.detail.isReader;if(!isReader){const currentSettings=settingsStore.get();if(currentSettings.autoFlip?.active){this.autoFlipper.stopAll();settingsStore.update({autoFlip:{...currentSettings.autoFlip,active:false}})}}};window.addEventListener("ipc:route-changed",this.routeChangedHandler)}updateState(settings){this.autoFlipper.updateState(settings);this.cursorHider.setEnabled(!!settings.hideCursor);this.updateProgressBarVisibility()}updateProgressBarVisibility(){const settings=settingsStore.get();const isDoubleColumn=this.siteContext.isDoubleColumn;const hideNavbar=settings.hideNavbar===true;const shouldShowProgressBar=isDoubleColumn&&hideNavbar;this.progressBar.setVisibility(shouldShowProgressBar)}destroy(){if(this.routeChangedHandler){window.removeEventListener("ipc:route-changed",this.routeChangedHandler);this.routeChangedHandler=null}this.cursorHider.destroy();this.swipeHandler.destroy();this.autoFlipper.stopAll();this.progressBar.destroy()}}class MenuManager{isReader=false;initialized=false;siteContext;routeChangedHandler=null;legacyRouteChangedHandler=null;titleChangedHandler=null;unlistenMenuAction=null;constructor(){this.siteContext=createSiteContext();this.init()}async init(){this.unlistenMenuAction=await listen("menu-action",(event)=>{this.handleMenuAction(event.payload)});this.routeChangedHandler=(e)=>{this.isReader=e.detail.isReader;this.updateMenuEnabledStatus("route-changed")};this.legacyRouteChangedHandler=(e)=>{this.isReader=e.detail.isReader;this.updateMenuEnabledStatus("route-changed-legacy")};this.titleChangedHandler=(e)=>{this.updateWindowTitle(e.detail.title)};window.addEventListener("ipc:route-changed",this.routeChangedHandler);window.addEventListener("wxrd:route-changed",this.legacyRouteChangedHandler);window.addEventListener("ipc:title-changed",this.titleChangedHandler);listen("menu-rebuilt",()=>{log.info("[MenuManager] Menu rebuilt, resyncing state");this.syncMenuState()});this.siteContext.onDoubleColumnChange(async(isDoubleColumn)=>{await this.updateMenuEnabledStatus("double-column-change")});await waitForTauriReady();this.isReader=this.siteContext.isReaderPage;this.initialized=true;settingsStore.subscribe(async(settings)=>{if(settings.zoom!==undefined){try{await invoke("set_zoom",{value:settings.zoom})}catch(e){log.error("[MenuManager] set_zoom failed:",e)}}await this.syncMenuState(settings)});await this.syncMenuState()}checkIsReader(){return this.siteContext.isReaderPage}async updateMenuEnabledStatus(source="unknown"){if(!window.__TAURI__)return;const isReader=this.checkIsReader();try{await invoke("set_menu_item_enabled",{id:"reader_wide",enabled:isReader});await invoke("set_menu_item_enabled",{id:"hide_cursor",enabled:isReader});await invoke("set_menu_item_enabled",{id:"hide_toolbar",enabled:isReader});await invoke("set_menu_item_enabled",{id:"hide_navbar",enabled:isReader});await invoke("set_menu_item_enabled",{id:"auto_flip",enabled:isReader});await invoke("set_menu_item_enabled",{id:"zoom_in",enabled:true});await invoke("set_menu_item_enabled",{id:"zoom_out",enabled:true});await invoke("set_menu_item_enabled",{id:"zoom_reset",enabled:true})}catch(e){log.error("[MenuManager] Error updating menu enabled status:",e)}}async updateWindowTitle(title){if(!window.__TAURI__)return;try{await invoke("set_title",{title})}catch(e){log.error("[MenuManager] Error setting window title:",e)}}async syncMenuState(settings=settingsStore.get()){if(!this.initialized)return;const wideState=!!settings.readerWide;const toolbarState=!!settings.hideToolbar;const navbarState=!!settings.hideNavbar;const autoFlipState=!!settings.autoFlip?.active;if(settings.zoom!==undefined){try{await invoke("set_zoom",{value:settings.zoom})}catch(e){log.error("[MenuManager] set_zoom failed:",e)}}await this.updateMenuEnabledStatus("sync-menu-state");try{await invoke("update_menu_state",{id:"reader_wide",state:wideState});await invoke("update_menu_state",{id:"hide_cursor",state:!!settings.hideCursor});await invoke("update_menu_state",{id:"hide_toolbar",state:toolbarState});await invoke("update_menu_state",{id:"hide_navbar",state:navbarState});await invoke("update_menu_state",{id:"auto_flip",state:autoFlipState})}catch(e){log.error("[MenuManager] Error updating menu state:",e)}}handleMenuAction(action){const settings=settingsStore.get();const siteId=this.siteContext.siteId;log.debug("[MenuManager] Handling action:",action,"siteId:",siteId);switch(action){case"reader_wide":{const newValue=!settings.readerWide;const updates={readerWide:newValue};if(!newValue&&settings.hideToolbar){updates.hideToolbar=false}if(siteId!=="unknown"){settingsStore.updateSite(siteId,updates)}else{settingsStore.update(updates)}}break;case"hide_toolbar":{if(siteId!=="unknown"){settingsStore.updateSite(siteId,{hideToolbar:!settings.hideToolbar})}else{settingsStore.update({hideToolbar:!settings.hideToolbar})}}break;case"hide_navbar":{if(siteId!=="unknown"){settingsStore.updateSite(siteId,{hideNavbar:!settings.hideNavbar})}else{settingsStore.update({hideNavbar:!settings.hideNavbar})}}break;case"hide_cursor":{settingsStore.updateGlobal({hideCursor:!settings.hideCursor})}break;case"auto_flip":{const currentAutoFlip=settings.autoFlip||{active:false,interval:15,keepAwake:true};const newActive=!currentAutoFlip.active;const updates={autoFlip:{...currentAutoFlip,active:newActive}};if(siteId!=="unknown"){settingsStore.updateSite(siteId,updates)}else{settingsStore.update(updates)}}break;case"zoom_in":{const zoomLevels=[0.5,0.67,0.75,0.8,0.9,1,1.1,1.25,1.5,1.75,2];const current=settings.zoom||0.75;let nextZoom=zoomLevels[zoomLevels.length-1];for(const level of zoomLevels){if(level>current){nextZoom=level;break}}settingsStore.updateGlobal({zoom:nextZoom})}break;case"zoom_out":{const zoomLevels=[0.5,0.67,0.75,0.8,0.9,1,1.1,1.25,1.5,1.75,2];const current=settings.zoom||0.75;let nextZoom=zoomLevels[0];for(let i=zoomLevels.length-1;i>=0;i--){if(zoomLevels[i]<current){nextZoom=zoomLevels[i];break}}settingsStore.updateGlobal({zoom:nextZoom})}break;case"zoom_reset":settingsStore.updateGlobal({zoom:1});break}}destroy(){if(this.routeChangedHandler){window.removeEventListener("ipc:route-changed",this.routeChangedHandler);this.routeChangedHandler=null}if(this.legacyRouteChangedHandler){window.removeEventListener("wxrd:route-changed",this.legacyRouteChangedHandler);this.legacyRouteChangedHandler=null}if(this.titleChangedHandler){window.removeEventListener("ipc:title-changed",this.titleChangedHandler);this.titleChangedHandler=null}if(this.unlistenMenuAction){this.unlistenMenuAction();this.unlistenMenuAction=null}}}class ThemeManager{clickHandler=null;darkModeQuery=null;darkModeChangeHandler=null;constructor(){this.init()}initLinks(){window.open=function(url,target,features){if(url){window.location.href=url.toString()}return null};this.clickHandler=(e)=>{const target=e.target;const link=target.closest("a");if(link&&link.target==="_blank"){link.target="_self"}};document.addEventListener("click",this.clickHandler,true)}shouldEnableDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}applyTheme(isDark){const isIframe=window.self!==window.top;const cssContent=`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `;const cssRoot=`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    `;const finalCss=isIframe?cssContent:cssRoot+cssContent;const id="wxrd-dark-mode-filter";if(isDark){injectCSS(id,finalCss)}else{removeCSS(id)}}initDarkMode(){this.applyTheme(this.shouldEnableDarkMode());this.darkModeQuery=window.matchMedia("(prefers-color-scheme: dark)");this.darkModeChangeHandler=(e)=>{this.applyTheme(e.matches)};this.darkModeQuery.addEventListener("change",this.darkModeChangeHandler)}init(){this.initLinks();this.initDarkMode()}destroy(){if(this.clickHandler){document.removeEventListener("click",this.clickHandler,true);this.clickHandler=null}if(this.darkModeQuery&&this.darkModeChangeHandler){this.darkModeQuery.removeEventListener("change",this.darkModeChangeHandler);this.darkModeQuery=null;this.darkModeChangeHandler=null}removeCSS("wxrd-dark-mode-filter")}}class StyleManager{isWide=false;isHideToolbar=false;isHideNavbar=false;isReader=false;siteContext;routeChangedHandler=null;legacyRouteChangedHandler=null;darkModeQuery=null;darkModeHandler=null;constructor(){this.siteContext=createSiteContext();this.init()}async init(){this.isReader=this.siteContext.isReaderPage;if(!this.isReader){log.debug("[StyleManager] Starting on non-reader page, clearing any leftover reader styles");this.clearReaderStyles()}this.handleTheme();settingsStore.subscribe(()=>{this.updateStyles(settingsStore.get())});this.updateStyles(settingsStore.get());this.routeChangedHandler=(e)=>{const wasReader=this.isReader;this.isReader=e.detail.isReader;if(wasReader&&!this.isReader){log.debug("[StyleManager] Leaving reader page, clearing reader styles");this.clearReaderStyles()}if(!wasReader&&this.isReader){log.debug("[StyleManager] Entering reader page, applying styles");this.applyStyles()}};this.legacyRouteChangedHandler=(e)=>{const wasReader=this.isReader;this.isReader=e.detail.isReader;if(wasReader&&!this.isReader){log.debug("[StyleManager] Leaving reader page, clearing reader styles");this.clearReaderStyles()}};window.addEventListener("ipc:route-changed",this.routeChangedHandler);window.addEventListener("wxrd:route-changed",this.legacyRouteChangedHandler);this.siteContext.onDoubleColumnChange((isDoubleColumn)=>{log.debug("[StyleManager] Double column mode changed from SiteContext:",isDoubleColumn);this.applyStyles()})}handleTheme(){this.darkModeHandler=(e)=>{const adapter=this.siteContext.currentAdapter;if(adapter&&adapter.getDarkThemeCSS&&adapter.getLightThemeCSS){const css=e.matches?adapter.getDarkThemeCSS():adapter.getLightThemeCSS();injectCSS("wxrd-base-bg",css)}else{const defaultCSS=e.matches?"html, body { background-color: #222222 !important; }":"html, body { background-color: #ffffff !important; }";injectCSS("wxrd-base-bg",defaultCSS)}};this.darkModeQuery=window.matchMedia("(prefers-color-scheme: dark)");this.darkModeHandler(this.darkModeQuery);this.darkModeQuery.addEventListener("change",this.darkModeHandler)}updateStyles(settings){const newIsWide=!!settings.readerWide;const newIsHideToolbar=!!settings.hideToolbar;const newIsHideNavbar=!!settings.hideNavbar;if(newIsWide!==this.isWide||newIsHideToolbar!==this.isHideToolbar||newIsHideNavbar!==this.isHideNavbar){this.isWide=newIsWide;this.isHideToolbar=newIsHideToolbar;this.isHideNavbar=newIsHideNavbar;this.applyStyles()}}applyStyles(){if(!this.isReader){return}const adapter=this.siteContext.currentAdapter;const isDoubleColumn=this.siteContext.isDoubleColumn;log.debug("[StyleManager] Applying styles. isDoubleColumn:",isDoubleColumn);if(adapter){const wideCSS=adapter.getWideModeCSS(this.isWide);const toolbarCSS=adapter.getToolbarCSS(this.isHideToolbar);const navbarCSS=isDoubleColumn&&adapter.getNavbarCSS?adapter.getNavbarCSS(this.isHideNavbar):"";injectCSS("wxrd-wide-mode",wideCSS);injectCSS("wxrd-hide-toolbar",toolbarCSS);injectCSS("wxrd-hide-navbar",navbarCSS)}else{log.warn("[StyleManager] No adapter found, styles not applied")}window.dispatchEvent(new Event("resize"))}clearReaderStyles(){removeCSS("wxrd-wide-mode");removeCSS("wxrd-hide-toolbar");removeCSS("wxrd-hide-navbar")}destroy(){if(this.routeChangedHandler){window.removeEventListener("ipc:route-changed",this.routeChangedHandler);this.routeChangedHandler=null}if(this.legacyRouteChangedHandler){window.removeEventListener("wxrd:route-changed",this.legacyRouteChangedHandler);this.legacyRouteChangedHandler=null}if(this.darkModeQuery&&this.darkModeHandler){this.darkModeQuery.removeEventListener("change",this.darkModeHandler);this.darkModeQuery=null;this.darkModeHandler=null}this.clearReaderStyles();removeCSS("wxrd-base-bg")}}(function(){if(window.wxrd_injected){return}window.wxrd_injected=true;try{const siteRegistry=getSiteRegistry();log.info(`[Inject] Starting injection on: ${window.location.href}`);log.info(`[Inject] Hostname: ${window.location.hostname}`);log.info(`[Inject] User Agent: ${navigator.userAgent}`);try{const adapterInstances2=createAdapterInstances();if(!adapterInstances2||adapterInstances2.length===0){log.error("[Inject] No adapters found! Auto-discovery failed.")}else{log.info(`[Inject] Found ${adapterInstances2.length} adapters:`,adapterInstances2.map((a)=>a.id).join(", "));adapterInstances2.forEach((adapter)=>{siteRegistry.register(adapter);const isMatch=adapter.matchesCurrentDomain?adapter.matchesCurrentDomain():false;log.debug(`[Inject] Registered adapter: ${adapter.name} (${adapter.id}) - Match: ${isMatch}`)})}}catch(e){log.error("[Inject] Failed to register adapters",e)}let currentAdapter=siteRegistry.getCurrentAdapter();log.info(`[Inject] Location check - Href: ${window.location.href}, Hostname: ${window.location.hostname}`);if(!currentAdapter){log.warn(`[Inject] No adapter matched hostname '${window.location.hostname}'`);if(window.location.hostname.includes("weread.qq.com")||window.location.href.includes("weread.qq.com")){log.info("[Inject] Hostname contains weread.qq.com, forcing WeRead adapter");const weReadAdapter=adapterInstances.find((a)=>a.id==="weread");if(weReadAdapter){weReadAdapter.matchesCurrentDomain=()=>true;currentAdapter=siteRegistry.getCurrentAdapter()}}}if(currentAdapter){log.info(`[Inject] Detected site: ${currentAdapter.name} (isReader: ${siteRegistry.isReaderPage()})`)}else{log.error("[Inject] FATAL: No matching adapter found for current site. Feature injection will fail.")}const isReader=siteRegistry.isReaderPage();const safeInit=(name,fn)=>{try{fn()}catch(e){log.error(`[Inject] Failed to initialize ${name}`,e)}};safeInit("IPCManager",()=>new IPCManager);safeInit("MenuManager",()=>new MenuManager);safeInit("AppManager",()=>new AppManager);safeInit("TurnerManager",()=>new TurnerManager);if(!isReader){safeInit("ThemeManager",()=>new ThemeManager)}safeInit("StyleManager",()=>new StyleManager);if(currentAdapter&&currentAdapter.id==="weread"){window.testWeReadAPI=()=>currentAdapter.testBookInfo();log.info("[Inject] WeRead API 测试方法已暴露: window.testWeReadAPI()")}}catch(e){console.error("[Inject] Critical error during initialization:",e);log.error("[Inject] Critical initialization error",e)}})();
