var $={debug:(...J)=>{if(typeof window<"u"&&window.__TAURI__&&!window.__TAURI__.__currentWindow?.label?.includes("app."))console.log(...J)},info:(...J)=>{console.log(...J)},warn:(...J)=>{console.warn(...J)},error:(...J)=>{console.error(...J)}};class A{static instance;adapters=new Map;currentAdapter=null;constructor(){}static getInstance(){if(!A.instance)A.instance=new A;return A.instance}register(J){this.adapters.set(J.id,J)}registerAll(J){J.forEach((Q)=>this.register(Q))}getCurrentAdapter(){if(this.currentAdapter){let J=this.currentAdapter;if(J.matchesCurrentDomain&&J.matchesCurrentDomain())return J}for(let J of this.adapters.values())if(J.matchesCurrentDomain&&J.matchesCurrentDomain())return this.currentAdapter=J,J;return this.currentAdapter=null,$.warn("[SiteRegistry] No matching adapter found for current site"),null}getAdapter(J){return this.adapters.get(J)}getAllAdapters(){return Array.from(this.adapters.values())}isReaderPage(){let J=this.getCurrentAdapter();return J?J.isReaderPage():!1}isHomePage(){let J=this.getCurrentAdapter();return J?J.isHomePage():!1}getReaderMenuItems(){let J=this.getCurrentAdapter();if(J&&J.getReaderMenuItems)return J.getReaderMenuItems();return["reader_wide","hide_toolbar","auto_flip"]}}var f=()=>A.getInstance();class I{matchesCurrentDomain(){let J=window.location.hostname;return(Array.isArray(this.domain)?this.domain:[this.domain]).some((Z)=>J===Z||J.endsWith(`.${Z}`))}matchesPath(J){let Q=window.location.pathname,Z=window.location.href;if(typeof J==="string")return Q.includes(J)||Z.includes(J);else return J.test(Q)||J.test(Z)}triggerKey(J){let Q=new KeyboardEvent("keydown",{key:J,code:J==="Right"?"ArrowRight":J==="Left"?"ArrowLeft":J,keyCode:J==="Right"?39:J==="Left"?37:0,bubbles:!0,cancelable:!0});document.dispatchEvent(Q)}clickElement(J){let Q=document.querySelector(J);if(Q)return Q.click(),!0;return!1}}class b extends I{id="weread";name="微信读书";domain="weread.qq.com";isReaderPage(){return this.matchesPath("/web/reader/")}isHomePage(){let J=window.location.pathname;return J==="/"||J==="/web"||J.startsWith("/web/shelf")}getWideModeCSS(J){if(J)return`
        /* 微信读书 - 宽屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 96% !important;
          max-width: calc(100vw - 224px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 80px) !important;
        }
      `;else return`
        /* 微信读书 - 窄屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 80% !important;
          max-width: calc(100vw - 424px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(40% + 40px) !important;
        }
      `}getToolbarCSS(J){if(J)return`
        /* 微信读书 - 隐藏工具栏 */
        .readerControls {
          display: none !important;
        }
        .readerTopBar,
        .app_content,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 124px) !important;
        }
      `;else return`
        /* 微信读书 - 显示工具栏 */
        .readerControls {
          display: block !important;
        }
        .readerTopBar,
        .app_content,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 224px) !important;
        }
      `}getNavbarCSS(J){if(J)return`
        /* 微信读书 - 隐藏导航栏 */
        .readerTopBar,
        .renderTarget_pager {
          display: none !important;
        }
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          margin-top: 24px !important;
          height: calc(100% - 48px) !important;
        }
      `;else return`
        /* 微信读书 - 显示导航栏 */
        .readerTopBar,
        .renderTarget_pager {
          display: flex !important;
        }
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          margin-top: 72px !important;
          height: calc(100% - 132px) !important;
        }
      `}getDarkThemeCSS(){return`
      html, body {
        background-color: #222222 !important;
      }
    `}getLightThemeCSS(){return`
      html, body {
        background-color: #ffffff !important;
      }
    `}nextPage(){this.triggerKey("Right")}prevPage(){this.triggerKey("Left")}isDoubleColumn(){return!!document.querySelector(".wr_horizontalReader")}isAtBottom(){if(this.isDoubleColumn())return this.getChapterProgress()>=99;let J=document.documentElement.scrollHeight;return window.innerHeight+window.scrollY>=J-300}getChapterProgress(){if(!this.isDoubleColumn())return 0;let J=document.querySelector(".renderTargetPageInfo");if(J){let z=J.textContent?.trim();if(z){let P=z.match(/(\d+)\s*[\//]\s*(\d+)/);if(P){let q=parseInt(P[1],10),K=parseInt(P[2],10);if(K>0)return Math.round(q/K*100)}}}let Q=document.querySelector(".readerFooter_pageCurrent"),Z=document.querySelector(".readerFooter_pageTotal");if(Q&&Z){let z=parseInt(Q.textContent||"0",10),P=parseInt(Z.textContent||"1",10);if(P>0)return Math.round(z/P*100)}return 0}getNextChapterSelector(){return".readerFooter_button"}clickNextChapter(){let J=document.querySelector(this.getNextChapterSelector());if(J)J.click()}getReaderMenuItems(){return["reader_wide","hide_toolbar","auto_flip"]}}var d=[b],p=()=>{return d.map((J)=>new J)};class T{registry;_cachedIsDoubleColumn=null;doubleColumnListeners=new Set;doubleColumnObserver=null;observerInitialized=!1;static instance=null;constructor(){this.registry=f(),this.initDoubleColumnObserver()}static getInstance(){if(!T.instance)T.instance=new T;return T.instance}initDoubleColumnObserver(){if($.info("[SiteContext] initDoubleColumnObserver: starting initialization"),this.observerInitialized){$.info("[SiteContext] initDoubleColumnObserver: already initialized, skipping");return}let J=()=>{let Z=this._cachedIsDoubleColumn,z=this.detectDoubleColumn();if(Z!==z)this._cachedIsDoubleColumn=z,this.notifyDoubleColumnChange(z),$.info("[SiteContext] Double column mode changed:",z)},Q=()=>{if(this.observerInitialized)return;this.observerInitialized=!0,$.info("[SiteContext] initObserver: MutationObserver initialized");let Z=new MutationObserver(()=>{J()});Z.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]}),this.doubleColumnObserver=Z;let z=this.detectDoubleColumn();this._cachedIsDoubleColumn=z,$.info("[SiteContext] Initial double column value:",z)};if(document.readyState==="loading")$.info("[SiteContext] initDoubleColumnObserver: readyState is loading, waiting for DOMContentLoaded"),document.addEventListener("DOMContentLoaded",Q);else if(document.body)$.info("[SiteContext] initDoubleColumnObserver: DOM ready and body exists, calling initObserver immediately"),Q();else $.info("[SiteContext] initDoubleColumnObserver: DOM ready but body missing, waiting for DOMContentLoaded"),document.addEventListener("DOMContentLoaded",Q)}detectDoubleColumn(){let J=this.currentAdapter;if(!J)return!1;if(J.id==="weread")return!!document.querySelector(".wr_horizontalReader");if(J.isDoubleColumn)return J.isDoubleColumn();return!1}notifyDoubleColumnChange(J){$.info("[SiteContext] notifyDoubleColumnChange: notifying",this.doubleColumnListeners.size,"listeners, isDoubleColumn=",J),this.doubleColumnListeners.forEach((Q)=>{try{Q(J)}catch(Z){$.error("[SiteContext] Error in double column listener:",Z)}})}onDoubleColumnChange(J){if(this.doubleColumnListeners.add(J),this._cachedIsDoubleColumn!==null)try{J(this._cachedIsDoubleColumn)}catch(Q){$.error("[SiteContext] Error in immediate double column callback:",Q)}return requestAnimationFrame(()=>{setTimeout(()=>{let Q=this.isDoubleColumn;try{J(Q)}catch(Z){$.error("[SiteContext] Error in delayed double column callback:",Z)}},400)}),()=>{this.doubleColumnListeners.delete(J)}}get currentAdapter(){return this.registry.getCurrentAdapter()}get isReaderPage(){return this.registry.isReaderPage()}get isHomePage(){return this.registry.isHomePage()}get isDoubleColumn(){if(this._cachedIsDoubleColumn!==null)return this._cachedIsDoubleColumn;let J=this.detectDoubleColumn();return this._cachedIsDoubleColumn=J,J}get siteId(){return this.currentAdapter?.id||"unknown"}}var W=()=>{return T.getInstance()};var B=(J,Q)=>{if(window.__TAURI__)return window.__TAURI__.core.invoke(J,Q);else return $.warn(`[Tauri] Invoke '${J}' failed: API not found`),Promise.resolve({})},U=(J,Q)=>{if(window.__TAURI__)return window.__TAURI__.event.listen(J,Q);return $.warn(`[Tauri] Listen '${J}' failed: API not found`),Promise.resolve(()=>{})};var x=()=>{return new Promise((J)=>{if(window.__TAURI__){J();return}let Q=setInterval(()=>{if(window.__TAURI__)clearInterval(Q),J()},10);setTimeout(()=>{clearInterval(Q),J()},2000)})},c=async()=>{await x();let J=100,Q=50;for(let Z=0;Z<J;Z++)try{await B("get_app_name"),$.debug(`[Tauri] IPC ready after ${Z*Q}ms`);return}catch(z){if(Z<J-1)await new Promise((P)=>setTimeout(P,Q))}$.warn(`[Tauri] IPC not ready after ${J*Q}ms, continuing anyway`)},V=(J)=>{if(window.__TAURI__)B("log_to_file",{message:J}).catch(()=>{});else $.debug(J)};class _{data;version;constructor(J,Q=0){this.data=J,this.version=Q,this.data._version=this.version}getData(){return{...this.data}}getVersion(){return this.version}tryUpdate(J){let Q=this.version+1,Z={...this.data,...J,_version:Q};return this.data=Z,this.version=Q,{success:!0,version:Q,data:this.getData()}}loadFromExternal(J,Q){if(Q>=this.version)return this.data={...J,_version:Q},this.version=Q,!0;return!1}isStale(J){return J>this.version}forceSet(J,Q){this.data={...J,_version:Q},this.version=Q}}class E{static instance;lock=null;listeners=new Set;initialized=!1;constructor(){}static migrateOldSettings(J){if(!(("readerWide"in J)||("hideToolbar"in J)||("autoFlip"in J)))return J;$.info("[SettingsStore] Detected old settings format, migrating to new structure...");let Z={readerWide:J.readerWide,hideToolbar:J.hideToolbar,lastReaderUrl:J.lastReaderUrl,scrollPosition:J.scrollPosition,readingProgress:J.readingProgress,autoFlip:J.autoFlip},z={_version:J._version||0,global:{zoom:J.zoom,autoUpdate:J.autoUpdate,lastPage:J.lastPage},sites:{weread:Z}};return $.info("[SettingsStore] Migration complete"),z}static getInstance(){if(!E.instance)E.instance=new E;return E.instance}async init(){if(this.initialized)return;try{let J=await B("get_settings")||{},Q=E.migrateOldSettings(J),Z=Q._version||0,z={_version:Z,global:{zoom:0.8,autoUpdate:!0,lastPage:!0,...Q.global},sites:Q.sites||{}};this.lock=new _(z,Z),$.debug("[SettingsStore] Initialized optimistic lock with version:",Z)}catch(J){$.error("SettingsStore: Failed to load settings",J);let Q={_version:0,global:{zoom:0.8,autoUpdate:!0,lastPage:!0},sites:{}};this.lock=new _(Q,0)}U("settings-updated",async()=>{if(!this.lock)return;let J=await B("get_settings")||{},Q=J._version||0;if($.debug("[SettingsStore] Received settings-updated event, backend version:",Q,"local version:",this.lock.getVersion()),this.lock.loadFromExternal(J,Q))$.debug("[SettingsStore] Loaded newer version from backend:",Q),this.notify();else $.debug("[SettingsStore] Ignoring older version from backend:",Q,"<",this.lock.getVersion())}),this.initialized=!0,this.notify()}get(){let J=this.lock?this.lock.getData():{},Q=W().siteId,Z=J.sites?.[Q]||{};return{...J,...J.global,...Z}}getGlobal(){return(this.lock?this.lock.getData():{}).global||{}}getSite(J){return(this.lock?this.lock.getData():{}).sites?.[J]||{}}async updateGlobal(J){let Q=this.get();await this.update({global:{...Q.global,...J}})}async updateSite(J,Q){let Z=this.get();await this.update({sites:{...Z.sites,[J]:{...Z.sites?.[J],...Q}}})}getCurrentSiteSettings(){return this.getSite("weread")}async updateCurrentSite(J){return this.updateSite("weread",J)}async update(J){if(!this.lock){$.error("[SettingsStore] Lock not initialized");return}let{_version:Q,...Z}=J,z=["zoom","autoUpdate","lastPage"],P=["readerWide","hideToolbar","lastReaderUrl","scrollPosition","readingProgress","autoFlip"],q=this.lock.getData(),K=!1,D={...q};if("global"in Z)D.global={...q.global,...Z.global},K=!0;if("sites"in Z)D.sites={...q.sites,...Z.sites},K=!0;let O={};for(let j in Z)if(j!=="global"&&j!=="sites")O[j]=Z[j];if(Object.keys(O).length>0){let j={},H={};for(let Y in O)if(z.includes(Y))j[Y]=O[Y];else if(P.includes(Y))H[Y]=O[Y];if(Object.keys(j).length>0)D.global={...q.global,...j},K=!0;if(Object.keys(H).length>0){let Y=W().siteId;D.sites={...q.sites,[Y]:{...q.sites?.[Y],...H}},K=!0}}if(!K)return;let X=this.lock.tryUpdate(D);$.debug("[SettingsStore] Update: version",X.version-1,"->",X.version,"partial:",Z),this.notify();let F={_version:X.version,global:X.data.global,sites:X.data.sites};try{await B("save_settings",{settings:F,version:X.version}),$.debug("[SettingsStore] Saved successfully with version:",X.version)}catch(j){$.error("[SettingsStore] Failed to save settings",j),this.lock.forceSet(X.data,X.version-1),this.notify()}}subscribe(J){if(this.listeners.add(J),this.initialized&&this.lock)J(this.get());return()=>this.listeners.delete(J)}notify(){if(!this.lock)return;let J=this.get();this.listeners.forEach((Q)=>Q(J))}}var G=E.getInstance();var g="__wxrd_scroll_restored";class N{static isRestorationComplete(){return!!window[g]}static markRestorationComplete(){if(!this.isRestorationComplete())$.debug("[ScrollState] Restoration marked as complete - unlocking save/auto-scroll"),window[g]=!0}static async waitForRestoration(J=2000){if(this.isRestorationComplete())return;return new Promise((Q)=>{let Z=Date.now(),z=()=>{if(this.isRestorationComplete()){Q();return}if(Date.now()-Z>J){$.warn(`[ScrollState] Timeout waiting for restoration (${J}ms)`),Q();return}setTimeout(z,100)};z()})}}class w{siteContext;currentIsReader=!1;initialized=!1;scrollSaveTimer=null;lastSavedScrollY=0;checkRouteHandler=null;titleObserver=null;scrollHandler=null;safetyTimeout=null;originalPushState=null;originalReplaceState=null;constructor(){this.siteContext=W(),this.init()}async init(){await G.init(),this.safetyTimeout=setTimeout(()=>{if(!N.isRestorationComplete())$.warn("[IPCManager] Force enabling scroll save after timeout"),N.markRestorationComplete()},1e4),this.monitorRoute(),this.monitorTitle(),this.monitorScroll()}monitorRoute(){this.checkRouteHandler=()=>{let z=window.location.href,P=window.location.pathname,q=this.siteContext.isReaderPage,K=this.currentIsReader!==q;if(this.currentIsReader=q,this.handleLastPageSaving(q,z),K)this.dispatchRouteChanged(q,z,P)},window.addEventListener("popstate",this.checkRouteHandler),this.originalPushState=history.pushState,history.pushState=(...z)=>{let P=this.originalPushState.apply(history,z);if(this.checkRouteHandler)this.checkRouteHandler();return P},this.originalReplaceState=history.replaceState,history.replaceState=(...z)=>{let P=this.originalReplaceState.apply(history,z);if(this.checkRouteHandler)this.checkRouteHandler();return P},this.checkRouteHandler();let J=window.location.href,Q=window.location.pathname,Z=this.siteContext.isReaderPage;this.dispatchRouteChanged(Z,J,Q)}handleLastPageSaving(J,Q){let Z=G.get();if(Z.lastPage&&J){if(Z.lastReaderUrl!==Q)G.update({lastReaderUrl:Q})}}dispatchRouteChanged(J,Q,Z){let z={isReader:J,url:Q,pathname:Z};window.dispatchEvent(new CustomEvent("wxrd:route-changed",{detail:z})),window.dispatchEvent(new CustomEvent("ipc:route-changed",{detail:z}))}monitorTitle(){let J=document.querySelector("title");if(J)this.titleObserver=new MutationObserver(()=>{this.dispatchTitleChanged()}),this.titleObserver.observe(J,{childList:!0,characterData:!0,subtree:!0}),this.dispatchTitleChanged()}dispatchTitleChanged(){if(document.title&&document.title.trim()!==""){let J={title:document.title};window.dispatchEvent(new CustomEvent("ipc:title-changed",{detail:J}))}}monitorScroll(){this.scrollHandler=()=>{if(!this.currentIsReader)return;if(!G.get().lastPage)return;if(this.siteContext.isDoubleColumn)return;if(!N.isRestorationComplete())return;let Q=window.scrollY;if(Math.abs(Q-this.lastSavedScrollY)<50)return;if(this.scrollSaveTimer)clearTimeout(this.scrollSaveTimer);this.scrollSaveTimer=setTimeout(()=>{this.lastSavedScrollY=Q;let Z=window.location.href,P={...G.get().readingProgress||{},[Z]:Q};G.update({scrollPosition:Q,readingProgress:P})},500)},window.addEventListener("scroll",this.scrollHandler,{passive:!0})}destroy(){if(this.scrollSaveTimer)clearTimeout(this.scrollSaveTimer),this.scrollSaveTimer=null;if(this.safetyTimeout)clearTimeout(this.safetyTimeout),this.safetyTimeout=null;if(this.checkRouteHandler)window.removeEventListener("popstate",this.checkRouteHandler),this.checkRouteHandler=null;if(this.scrollHandler)window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null;if(this.originalPushState)history.pushState=this.originalPushState,this.originalPushState=null;if(this.originalReplaceState)history.replaceState=this.originalReplaceState,this.originalReplaceState=null;if(this.titleObserver)this.titleObserver.disconnect(),this.titleObserver=null}}var R="wxrd_has_restored";class h{appName="微信阅读";siteContext;pagehideHandler=null;visibilitychangeHandler=null;constructor(){this.siteContext=W(),this.init()}async init(){await x();try{this.appName=await B("get_app_name")||"微信阅读"}catch(J){$.error("Failed to get app name:",J)}await G.init(),this.pagehideHandler=()=>{this.clearAutoFlipOnExit()},this.visibilitychangeHandler=()=>{if(document.visibilityState==="hidden")this.clearAutoFlipOnExit()},window.addEventListener("pagehide",this.pagehideHandler),document.addEventListener("visibilitychange",this.visibilitychangeHandler),await this.restoreLastPage(),this.restoreScrollPosition()}clearAutoFlipOnExit(){let J=G.get();if(J.autoFlip?.active)$.debug("[AppManager] Clearing autoFlip.active on exit"),V("[AppManager] Clearing autoFlip.active on exit"),G.update({autoFlip:{active:!1,interval:J.autoFlip.interval||15,keepAwake:J.autoFlip.keepAwake!==!1}})}async restoreLastPage(){if(sessionStorage.getItem(R)==="true")return;let Q=G.get();if(!this.siteContext.isReaderPage&&Q.lastPage&&Q.lastReaderUrl){let z=`[AppManager] Restoring last page: ${Q.lastReaderUrl}`;V(z),$.debug("[AppManager] Restoring last page:",Q.lastReaderUrl),sessionStorage.setItem(R,"true"),window.location.href=Q.lastReaderUrl}else sessionStorage.setItem(R,"true")}restoreScrollPosition(){if(N.isRestorationComplete())return;let J=G.get(),Q=this.siteContext.isReaderPage,Z=window.location.href,P=(J.readingProgress||{})[Z]??J.scrollPosition;if(!Q||!J.lastPage||P===void 0||P===null){N.markRestorationComplete();return}if(this.siteContext.isDoubleColumn){N.markRestorationComplete();return}$.debug("[AppManager] Planning to restore scroll position:",P,"for URL:",Z),V(`[AppManager] Planning to restore scroll position: ${P} for URL: ${Z}`);let q=0,K=50,D=0,O=()=>{try{let X=document.documentElement.scrollHeight,F=window.innerHeight,j=P+F;if(X>D)q=0,D=X;else q++;if(X>=j){$.debug(`[AppManager] Height sufficient (${X} >= ${j}), restoring to ${P}`),window.scrollTo({top:P,behavior:"instant"}),N.markRestorationComplete();return}if(q<K){window.scrollTo({top:X,behavior:"instant"}),document.dispatchEvent(new Event("scroll"));try{document.dispatchEvent(new WheelEvent("wheel",{deltaY:100,bubbles:!0}))}catch(H){}setTimeout(O,100)}else $.debug("[AppManager] Max restore attempts reached (stuck), giving up."),window.scrollTo({top:P,behavior:"instant"}),N.markRestorationComplete()}catch(X){$.error("[AppManager] Error during scroll restoration:",X),N.markRestorationComplete()}};setTimeout(O,500)}destroy(){if(this.pagehideHandler)window.removeEventListener("pagehide",this.pagehideHandler),this.pagehideHandler=null;if(this.visibilitychangeHandler)document.removeEventListener("visibilitychange",this.visibilitychangeHandler),this.visibilitychangeHandler=null}}function L(J,Q){let Z=document.getElementById(J);if(!Z)if(Z=document.createElement("style"),Z.id=J,document.head)document.head.appendChild(Z);else if(document.documentElement)document.documentElement.appendChild(Z);else{let z=new MutationObserver((P)=>{for(let q of P)if(q.addedNodes.length>0){if(document.head){document.head.appendChild(Z),z.disconnect();return}else if(document.documentElement){document.documentElement.appendChild(Z),z.disconnect();return}}});z.observe(document,{childList:!0})}Z.innerHTML=Q}function M(J){let Q=document.getElementById(J);if(Q)Q.remove()}class C{mouseHideTimer=null;isMouseHidden=!1;isScrollingOrSwiping=!1;scrollLockTimer=null;lastScreenX=0;lastScreenY=0;siteContext;timerStarted=!1;onMouseMove=null;onMouseDown=null;constructor(J){this.siteContext=J,this.init()}init(){let J=()=>{if(this.isMouseHidden)this.showCursor();if(this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null;if(this.siteContext.isReaderPage)this.mouseHideTimer=window.setTimeout(()=>{this.hideCursor()},3000),this.timerStarted=!0},Q=0;this.onMouseMove=(Z)=>{if(this.isScrollingOrSwiping)return;let z=Math.abs(Z.screenX-this.lastScreenX),P=Math.abs(Z.screenY-this.lastScreenY);if(z<15&&P<15)return;this.lastScreenX=Z.screenX,this.lastScreenY=Z.screenY;let q=Date.now();if(q-Q>200){if(Q=q,!this.timerStarted)this.timerStarted=!0;J()}},this.onMouseDown=J,document.addEventListener("mousemove",this.onMouseMove,!1),document.addEventListener("mousedown",this.onMouseDown,!1)}setScrollLock(J=200){if(this.isScrollingOrSwiping=!0,this.scrollLockTimer)clearTimeout(this.scrollLockTimer);this.scrollLockTimer=window.setTimeout(()=>{this.isScrollingOrSwiping=!1},J)}hideCursor(){if(this.isMouseHidden)return;if(!this.siteContext.isReaderPage)return;$.debug("[CursorHider] Hiding cursor"),document.documentElement.classList.add("wxrd-hide-cursor"),L("wxrd-cursor-hide",`
      html.wxrd-hide-cursor,
      html.wxrd-hide-cursor * {
        cursor: none !important;
      }
    `),this.isMouseHidden=!0}showCursor(){if(!this.isMouseHidden)return;$.debug("[CursorHider] Showing cursor"),document.documentElement.classList.remove("wxrd-hide-cursor"),M("wxrd-cursor-hide"),this.isMouseHidden=!1}destroy(){if(this.showCursor(),this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null;if(this.scrollLockTimer)window.clearTimeout(this.scrollLockTimer),this.scrollLockTimer=null;if(this.onMouseMove)document.removeEventListener("mousemove",this.onMouseMove,!1);if(this.onMouseDown)document.removeEventListener("mousedown",this.onMouseDown,!1)}}class y{swipeAccumulator=0;swipeResetTimer=null;swipeCooldown=!1;siteContext;onScrollLock;handler;constructor(J,Q){this.siteContext=J,this.onScrollLock=Q,this.handler=(Z)=>{this.onScrollLock(),this.handleWheel(Z)},this.init()}init(){window.addEventListener("wheel",this.handler,{passive:!1,capture:!0})}handleWheel(J){if(!this.siteContext.isReaderPage)return;if(!this.siteContext.isDoubleColumn)return;let Q=this.siteContext.currentAdapter;if(!Q)return;let{deltaX:Z,deltaY:z}=J;if(Math.abs(Z)>Math.abs(z))J.preventDefault();else return;if(this.swipeCooldown)return;if(Math.abs(Z)<2)return;if(this.swipeAccumulator+=Z,this.swipeResetTimer)clearTimeout(this.swipeResetTimer);this.swipeResetTimer=setTimeout(()=>{this.swipeAccumulator=0},250);let q=50;if(this.swipeAccumulator>=q)$.debug("[SwipeHandler] Swipe left detected, next page"),Q.nextPage(),this.swipeAccumulator=0,this.startCooldown();else if(this.swipeAccumulator<=-q)$.debug("[SwipeHandler] Swipe right detected, prev page"),Q.prevPage(),this.swipeAccumulator=0,this.startCooldown()}startCooldown(){this.swipeCooldown=!0,setTimeout(()=>{this.swipeCooldown=!1,this.swipeAccumulator=0},800)}destroy(){if(this.swipeResetTimer)clearTimeout(this.swipeResetTimer),this.swipeResetTimer=null;window.removeEventListener("wheel",this.handler,{capture:!0})}}class k{isActive=!1;intervalSeconds=30;keepAwake=!1;doubleTimer=null;singleRafId=null;lastFrameTime=0;lastScrollTime=0;accumulatedMove=0;countdown=30;originalTitle=null;appName="微信阅读";elapsedTime=0;siteContext;bottomTriggered=!1;onScrollLock;generation=0;constructor(J,Q){this.siteContext=J,this.onScrollLock=Q,this.initAppName()}async initAppName(){try{this.appName=await B("get_app_name")||"微信阅读"}catch(J){this.appName="微信阅读"}}updateState(J){let Q=J.autoFlip||{active:!1,interval:15,keepAwake:!0},Z=!!Q.active,z=Q.interval>0?Q.interval:15,P=!!Q.keepAwake;if(!Z){if(this.isActive)this.stopAll(),this.isActive=!1}else if(!this.isActive||this.intervalSeconds!==z||this.keepAwake!==P){if(this.isActive)this.stopAll();this.isActive=!0,this.intervalSeconds=z,this.keepAwake=P,this.start()}}stopAll(){if(this.isActive=!1,this.generation++,this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.originalTitle)document.title=this.originalTitle,this.originalTitle=null;this.elapsedTime=0}start(){let J=this.siteContext.currentAdapter;if(!J){$.warn("[AutoFlipper] No adapter found");return}if(this.siteContext.isDoubleColumn)this.startDoubleColumnLogic(J);else this.startSingleColumnLogic(J)}startDoubleColumnLogic(J){if(this.doubleTimer)return;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.countdown=this.intervalSeconds,!this.originalTitle)this.originalTitle=document.title;this.doubleTimer=setInterval(()=>{if(!this.siteContext.isDoubleColumn){this.stopAll(),this.startSingleColumnLogic(J);return}if(document.hidden&&!this.keepAwake)return;if(this.countdown--,document.title=`${this.appName} - 自动翻页 - ${this.countdown} 秒`,this.countdown<=0)this.onScrollLock(),J.nextPage(),this.countdown=this.intervalSeconds},1000)}startSingleColumnLogic(J){if(this.singleRafId)return;if(this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(!N.isRestorationComplete()){setTimeout(()=>{if(this.isActive)this.startSingleColumnLogic(J)},200);return}if(this.countdown=this.intervalSeconds,this.elapsedTime=0,!this.originalTitle)this.originalTitle=document.title;this.lastFrameTime=performance.now(),this.lastScrollTime=performance.now();let Q=this.generation;this.singleRafId=requestAnimationFrame((Z)=>this.singleColumnLoop(Z,J,Q))}singleColumnLoop(J,Q,Z){if(Z!==this.generation)return;if(!this.isActive){this.singleRafId=null;return}if(this.siteContext.isDoubleColumn){this.stopAll(),this.startDoubleColumnLogic(Q);return}let z=J-this.lastFrameTime;if(this.lastFrameTime=J,z>100)z=16,this.accumulatedMove=0;else if(z>50)z=50;if(this.elapsedTime+=z,this.elapsedTime>=1000){let X=window.scrollY,F=document.documentElement.scrollHeight,j=window.innerHeight,H=Math.max(1,F-j),Y=Math.min(100,Math.max(0,Math.round(X/H*1000)/10));this.elapsedTime-=1000,document.title=`${this.appName} - 自动翻页 - 已读 ${Y}%`}if(document.hidden&&!this.keepAwake){this.singleRafId=requestAnimationFrame((X)=>this.singleColumnLoop(X,Q,Z));return}let P=J-this.lastScrollTime;if(P<30){this.singleRafId=requestAnimationFrame((X)=>this.singleColumnLoop(X,Q,Z));return}this.lastScrollTime=J;let q=window.innerHeight,K=this.intervalSeconds>0?this.intervalSeconds:30,O=q/(K*1000)*P;if(this.accumulatedMove+=O,this.accumulatedMove>=1){this.onScrollLock();let X=Math.floor(this.accumulatedMove);window.scrollBy(0,X),this.accumulatedMove-=X;let F=Q.isAtBottom();if(F&&!this.bottomTriggered){if($.debug("[AutoFlipper] Reached bottom, triggering next page"),this.bottomTriggered=!0,Q.nextPage(),Q.clickNextChapter)Q.clickNextChapter();if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;setTimeout(()=>{if(this.bottomTriggered=!1,this.isActive&&this.generation===Z)this.startSingleColumnLogic(Q)},1e4);return}else if(!F)this.bottomTriggered=!1}this.singleRafId=requestAnimationFrame((X)=>this.singleColumnLoop(X,Q,Z))}}class v{cursorHider;swipeHandler;autoFlipper;siteContext;routeChangedHandler=null;constructor(){this.siteContext=W(),this.cursorHider=new C(this.siteContext);let J=(Q)=>{this.cursorHider.setScrollLock(Q)};this.swipeHandler=new y(this.siteContext,J),this.autoFlipper=new k(this.siteContext,J),this.init()}init(){G.subscribe((J)=>{this.updateState(J)}),this.routeChangedHandler=(J)=>{if(!J.detail.isReader){let Z=G.get();if(Z.autoFlip?.active)this.autoFlipper.stopAll(),G.update({autoFlip:{...Z.autoFlip,active:!1}})}},window.addEventListener("ipc:route-changed",this.routeChangedHandler)}updateState(J){this.autoFlipper.updateState(J)}destroy(){if(this.routeChangedHandler)window.removeEventListener("ipc:route-changed",this.routeChangedHandler),this.routeChangedHandler=null;this.cursorHider.destroy(),this.swipeHandler.destroy(),this.autoFlipper.stopAll()}}class m{isReader=!1;initialized=!1;siteContext;routeChangedHandler=null;legacyRouteChangedHandler=null;titleChangedHandler=null;unlistenMenuAction=null;constructor(){this.siteContext=W(),this.init()}async init(){this.unlistenMenuAction=await U("menu-action",(J)=>{this.handleMenuAction(J.payload)}),this.routeChangedHandler=(J)=>{this.isReader=J.detail.isReader,this.updateMenuEnabledStatus("route-changed")},this.legacyRouteChangedHandler=(J)=>{this.isReader=J.detail.isReader,this.updateMenuEnabledStatus("route-changed-legacy")},this.titleChangedHandler=(J)=>{this.updateWindowTitle(J.detail.title)},window.addEventListener("ipc:route-changed",this.routeChangedHandler),window.addEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),window.addEventListener("ipc:title-changed",this.titleChangedHandler),U("menu-rebuilt",()=>{$.info("[MenuManager] Menu rebuilt, resyncing state"),this.syncMenuState()}),this.siteContext.onDoubleColumnChange(async(J)=>{await this.updateMenuEnabledStatus("double-column-change")}),await c(),this.isReader=this.siteContext.isReaderPage,this.initialized=!0,G.subscribe(async(J)=>{if(J.zoom!==void 0)try{await B("set_zoom",{value:J.zoom})}catch(Q){$.error("[MenuManager] set_zoom failed:",Q)}await this.syncMenuState(J)}),await this.syncMenuState()}checkIsReader(){return this.siteContext.isReaderPage}async updateMenuEnabledStatus(J="unknown"){if(!window.__TAURI__)return;let Q=this.checkIsReader();try{await B("set_menu_item_enabled",{id:"reader_wide",enabled:Q}),await B("set_menu_item_enabled",{id:"hide_toolbar",enabled:Q}),await B("set_menu_item_enabled",{id:"hide_navbar",enabled:Q}),await B("set_menu_item_enabled",{id:"auto_flip",enabled:Q}),await B("set_menu_item_enabled",{id:"zoom_in",enabled:!0}),await B("set_menu_item_enabled",{id:"zoom_out",enabled:!0}),await B("set_menu_item_enabled",{id:"zoom_reset",enabled:!0})}catch(Z){$.error("[MenuManager] Error updating menu enabled status:",Z)}}async updateWindowTitle(J){if(!window.__TAURI__)return;try{await B("set_title",{title:J})}catch(Q){$.error("[MenuManager] Error setting window title:",Q)}}async syncMenuState(J=G.get()){if(!this.initialized)return;let Q=!!J.readerWide,Z=!!J.hideToolbar,z=!!J.hideNavbar,P=!!J.autoFlip?.active;await this.updateMenuEnabledStatus("sync-menu-state");try{await B("update_menu_state",{id:"reader_wide",state:Q}),await B("update_menu_state",{id:"hide_toolbar",state:Z}),await B("update_menu_state",{id:"hide_navbar",state:z}),await B("update_menu_state",{id:"auto_flip",state:P})}catch(q){$.error("[MenuManager] Error updating menu state:",q)}}handleMenuAction(J){let Q=G.get(),Z=this.siteContext.siteId;switch($.debug("[MenuManager] Handling action:",J,"siteId:",Z),J){case"reader_wide":{let z=!Q.readerWide,P={readerWide:z};if(!z&&Q.hideToolbar)P.hideToolbar=!1;if(Z!=="unknown")G.updateSite(Z,P);else G.update(P)}break;case"hide_toolbar":if(Z!=="unknown")G.updateSite(Z,{hideToolbar:!Q.hideToolbar});else G.update({hideToolbar:!Q.hideToolbar});break;case"hide_navbar":if(Z!=="unknown")G.updateSite(Z,{hideNavbar:!Q.hideNavbar});else G.update({hideNavbar:!Q.hideNavbar});break;case"auto_flip":{let z=Q.autoFlip||{active:!1,interval:15,keepAwake:!0},P=!z.active,q={autoFlip:{...z,active:P}};if(Z!=="unknown")G.updateSite(Z,q);else G.update(q)}break;case"zoom_in":{let z=Q.zoom||1;z=Math.round((z+0.1)*10)/10,G.updateGlobal({zoom:z})}break;case"zoom_out":{let z=Q.zoom||1;if(z=Math.round((z-0.1)*10)/10,z<0.1)z=0.1;G.updateGlobal({zoom:z})}break;case"zoom_reset":G.updateGlobal({zoom:1});break}}destroy(){if(this.routeChangedHandler)window.removeEventListener("ipc:route-changed",this.routeChangedHandler),this.routeChangedHandler=null;if(this.legacyRouteChangedHandler)window.removeEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),this.legacyRouteChangedHandler=null;if(this.titleChangedHandler)window.removeEventListener("ipc:title-changed",this.titleChangedHandler),this.titleChangedHandler=null;if(this.unlistenMenuAction)this.unlistenMenuAction(),this.unlistenMenuAction=null}}class u{clickHandler=null;darkModeQuery=null;darkModeChangeHandler=null;constructor(){this.init()}initLinks(){window.open=function(J,Q,Z){if(J)window.location.href=J.toString();return null},this.clickHandler=(J)=>{let Z=J.target.closest("a");if(Z&&Z.target==="_blank")Z.target="_self"},document.addEventListener("click",this.clickHandler,!0)}shouldEnableDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}applyTheme(J){let Q=window.self!==window.top,Z=`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,z=`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    `,P=Q?`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `:`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,q="wxrd-dark-mode-filter";if(J)L("wxrd-dark-mode-filter",P);else M("wxrd-dark-mode-filter")}initDarkMode(){this.applyTheme(this.shouldEnableDarkMode()),this.darkModeQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.darkModeChangeHandler=(J)=>{this.applyTheme(J.matches)},this.darkModeQuery.addEventListener("change",this.darkModeChangeHandler)}init(){this.initLinks(),this.initDarkMode()}destroy(){if(this.clickHandler)document.removeEventListener("click",this.clickHandler,!0),this.clickHandler=null;if(this.darkModeQuery&&this.darkModeChangeHandler)this.darkModeQuery.removeEventListener("change",this.darkModeChangeHandler),this.darkModeQuery=null,this.darkModeChangeHandler=null;M("wxrd-dark-mode-filter")}}class S{isWide=!1;isHideToolbar=!1;isHideNavbar=!1;isReader=!1;siteContext;routeChangedHandler=null;legacyRouteChangedHandler=null;darkModeQuery=null;darkModeHandler=null;constructor(){this.siteContext=W(),this.init()}async init(){if(this.isReader=this.siteContext.isReaderPage,!this.isReader)$.debug("[StyleManager] Starting on non-reader page, clearing any leftover reader styles"),this.clearReaderStyles();this.handleTheme(),G.subscribe(()=>{this.updateStyles(G.get())}),this.updateStyles(G.get()),this.routeChangedHandler=(J)=>{let Q=this.isReader;if(this.isReader=J.detail.isReader,Q&&!this.isReader)$.debug("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles();if(!Q&&this.isReader)$.debug("[StyleManager] Entering reader page, applying styles"),this.applyStyles()},this.legacyRouteChangedHandler=(J)=>{let Q=this.isReader;if(this.isReader=J.detail.isReader,Q&&!this.isReader)$.debug("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles()},window.addEventListener("ipc:route-changed",this.routeChangedHandler),window.addEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),this.siteContext.onDoubleColumnChange((J)=>{$.debug("[StyleManager] Double column mode changed from SiteContext:",J),this.applyStyles()})}handleTheme(){this.darkModeHandler=(J)=>{let Q=this.siteContext.currentAdapter;if(Q&&Q.getDarkThemeCSS&&Q.getLightThemeCSS){let Z=J.matches?Q.getDarkThemeCSS():Q.getLightThemeCSS();L("wxrd-base-bg",Z)}else{let Z=J.matches?"html, body { background-color: #222222 !important; }":"html, body { background-color: #ffffff !important; }";L("wxrd-base-bg",Z)}},this.darkModeQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.darkModeHandler(this.darkModeQuery),this.darkModeQuery.addEventListener("change",this.darkModeHandler)}updateStyles(J){let Q=!!J.readerWide,Z=!!J.hideToolbar,z=!!J.hideNavbar;if(Q!==this.isWide||Z!==this.isHideToolbar||z!==this.isHideNavbar)this.isWide=Q,this.isHideToolbar=Z,this.isHideNavbar=z,this.applyStyles()}applyStyles(){if(!this.isReader)return;let J=this.siteContext.currentAdapter,Q=this.siteContext.isDoubleColumn;if($.debug("[StyleManager] Applying styles. isDoubleColumn:",Q),J){let Z=J.getWideModeCSS(this.isWide),z=J.getToolbarCSS(this.isHideToolbar),P=Q&&J.getNavbarCSS?J.getNavbarCSS(this.isHideNavbar):"";L("wxrd-wide-mode",Z),L("wxrd-hide-toolbar",z),L("wxrd-hide-navbar",P)}else $.warn("[StyleManager] No adapter found, styles not applied");window.dispatchEvent(new Event("resize"))}clearReaderStyles(){M("wxrd-wide-mode"),M("wxrd-hide-toolbar"),M("wxrd-hide-navbar")}destroy(){if(this.routeChangedHandler)window.removeEventListener("ipc:route-changed",this.routeChangedHandler),this.routeChangedHandler=null;if(this.legacyRouteChangedHandler)window.removeEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),this.legacyRouteChangedHandler=null;if(this.darkModeQuery&&this.darkModeHandler)this.darkModeQuery.removeEventListener("change",this.darkModeHandler),this.darkModeQuery=null,this.darkModeHandler=null;this.clearReaderStyles(),M("wxrd-base-bg")}}(function(){if(window.wxrd_injected)return;window.wxrd_injected=!0;try{let J=f();$.info(`[Inject] Starting injection on: ${window.location.href}`),$.info(`[Inject] Hostname: ${window.location.hostname}`),$.info(`[Inject] User Agent: ${navigator.userAgent}`);try{let P=p();if(!P||P.length===0)$.error("[Inject] No adapters found! Auto-discovery failed.");else $.info(`[Inject] Found ${P.length} adapters:`,P.map((q)=>q.id).join(", ")),P.forEach((q)=>{J.register(q);let K=q.matchesCurrentDomain?q.matchesCurrentDomain():!1;$.debug(`[Inject] Registered adapter: ${q.name} (${q.id}) - Match: ${K}`)})}catch(P){$.error("[Inject] Failed to register adapters",P)}let Q=J.getCurrentAdapter();if($.info(`[Inject] Location check - Href: ${window.location.href}, Hostname: ${window.location.hostname}`),!Q){if($.warn(`[Inject] No adapter matched hostname '${window.location.hostname}'`),window.location.hostname.includes("weread.qq.com")||window.location.href.includes("weread.qq.com")){$.info("[Inject] Hostname contains weread.qq.com, forcing WeRead adapter");let P=adapterInstances.find((q)=>q.id==="weread");if(P)P.matchesCurrentDomain=()=>!0,Q=J.getCurrentAdapter()}}if(Q)$.info(`[Inject] Detected site: ${Q.name} (isReader: ${J.isReaderPage()})`);else $.error("[Inject] FATAL: No matching adapter found for current site. Feature injection will fail.");let Z=J.isReaderPage(),z=(P,q)=>{try{q()}catch(K){$.error(`[Inject] Failed to initialize ${P}`,K)}};if(z("IPCManager",()=>new w),z("MenuManager",()=>new m),z("AppManager",()=>new h),z("TurnerManager",()=>new v),!Z)z("ThemeManager",()=>new u);z("StyleManager",()=>new S)}catch(J){console.error("[Inject] Critical error during initialization:",J),$.error("[Inject] Critical initialization error",J)}})();
