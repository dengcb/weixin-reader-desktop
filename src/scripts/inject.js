var r=Object.defineProperty;var t=(J,Q)=>{for(var Z in Q)r(J,Z,{get:Q[Z],enumerable:!0,configurable:!0,set:(z)=>Q[Z]=()=>z})};var f=(J,Q)=>()=>(J&&(Q=J(J=0)),Q);var $;var W=f(()=>{$={debug:(...J)=>{if(typeof window<"u"&&window.__TAURI__&&!window.__TAURI__.__currentWindow?.label?.includes("app."))console.log(...J)},info:(...J)=>{console.log(...J)},warn:(...J)=>{console.warn(...J)},error:(...J)=>{console.error(...J)}}});class T{static instance;adapters=new Map;currentAdapter=null;constructor(){}static getInstance(){if(!T.instance)T.instance=new T;return T.instance}register(J){this.adapters.set(J.id,J)}registerAll(J){J.forEach((Q)=>this.register(Q))}getCurrentAdapter(){if(this.currentAdapter){let J=this.currentAdapter;if(J.matchesCurrentDomain&&J.matchesCurrentDomain())return J}for(let J of this.adapters.values())if(J.matchesCurrentDomain&&J.matchesCurrentDomain())return this.currentAdapter=J,J;return this.currentAdapter=null,$.warn("[SiteRegistry] No matching adapter found for current site"),null}getAdapter(J){return this.adapters.get(J)}getAllAdapters(){return Array.from(this.adapters.values())}isReaderPage(){let J=this.getCurrentAdapter();return J?J.isReaderPage():!1}isHomePage(){let J=this.getCurrentAdapter();return J?J.isHomePage():!1}getReaderMenuItems(){let J=this.getCurrentAdapter();if(J&&J.getReaderMenuItems)return J.getReaderMenuItems();return["reader_wide","hide_toolbar","auto_flip"]}}var I=()=>T.getInstance();var w=f(()=>{W()});class o{registry;constructor(){this.registry=I()}get currentAdapter(){return this.registry.getCurrentAdapter()}get isReaderPage(){return this.registry.isReaderPage()}get isHomePage(){return this.registry.isHomePage()}get siteId(){return this.currentAdapter?.id||"unknown"}}var Y=()=>{return new o};var V=f(()=>{w()});var X=(J,Q)=>{if(window.__TAURI__)return window.__TAURI__.core.invoke(J,Q);return $.warn(`[Tauri] Invoke '${J}' failed: API not found`),Promise.resolve({})},x=(J,Q)=>{if(window.__TAURI__)return window.__TAURI__.event.listen(J,Q);return $.warn(`[Tauri] Listen '${J}' failed: API not found`),Promise.resolve(()=>{})},k=()=>{return new Promise((J)=>{if(window.__TAURI__){J();return}let Q=setInterval(()=>{if(window.__TAURI__)clearInterval(Q),J()},10);setTimeout(()=>{clearInterval(Q),J()},2000)})},i=async()=>{await k();let J=100,Q=50;for(let Z=0;Z<J;Z++)try{await X("get_app_name"),$.debug(`[Tauri] IPC ready after ${Z*Q}ms`);return}catch(z){if(Z<J-1)await new Promise((P)=>setTimeout(P,Q))}$.warn(`[Tauri] IPC not ready after ${J*Q}ms, continuing anyway`)},_=(J)=>{if(window.__TAURI__)X("log_to_file",{message:J}).catch(()=>{});else $.debug(J)};var U=f(()=>{W()});class C{data;version;constructor(J,Q=0){this.data=J,this.version=Q,this.data._version=this.version}getData(){return{...this.data}}getVersion(){return this.version}tryUpdate(J){let Q=this.version+1,Z={...this.data,...J,_version:Q};return this.data=Z,this.version=Q,{success:!0,version:Q,data:this.getData()}}loadFromExternal(J,Q){if(Q>=this.version)return this.data={...J,_version:Q},this.version=Q,!0;return!1}isStale(J){return J>this.version}forceSet(J,Q){this.data={...J,_version:Q},this.version=Q}}var s={};t(s,{settingsStore:()=>G,SettingsStore:()=>H});class H{static instance;lock=null;listeners=new Set;initialized=!1;constructor(){}static migrateOldSettings(J){if(!(("readerWide"in J)||("hideToolbar"in J)||("autoFlip"in J)))return J;$.info("[SettingsStore] Detected old settings format, migrating to new structure...");let Z={readerWide:J.readerWide,hideToolbar:J.hideToolbar,lastReaderUrl:J.lastReaderUrl,scrollPosition:J.scrollPosition,readingProgress:J.readingProgress,autoFlip:J.autoFlip},z={_version:J._version||0,global:{zoom:J.zoom,autoUpdate:J.autoUpdate,lastPage:J.lastPage},sites:{weread:Z}};return $.info("[SettingsStore] Migration complete"),z}static getInstance(){if(!H.instance)H.instance=new H;return H.instance}async init(){if(this.initialized)return;try{let J=await X("get_settings")||{},Q=H.migrateOldSettings(J),Z=Q._version||0,z={_version:Z,global:{zoom:0.8,autoUpdate:!0,lastPage:!0,...Q.global},sites:Q.sites||{}};this.lock=new C(z,Z),$.debug("[SettingsStore] Initialized optimistic lock with version:",Z)}catch(J){$.error("SettingsStore: Failed to load settings",J);let Q={_version:0,global:{zoom:0.8,autoUpdate:!0,lastPage:!0},sites:{}};this.lock=new C(Q,0)}x("settings-updated",async()=>{if(!this.lock)return;let J=await X("get_settings")||{},Q=J._version||0;if($.debug("[SettingsStore] Received settings-updated event, backend version:",Q,"local version:",this.lock.getVersion()),this.lock.loadFromExternal(J,Q))$.debug("[SettingsStore] Loaded newer version from backend:",Q),this.notify();else $.debug("[SettingsStore] Ignoring older version from backend:",Q,"<",this.lock.getVersion())}),this.initialized=!0,this.notify()}get(){let J=this.lock?this.lock.getData():{},Q=Y().siteId,Z=J.sites?.[Q]||{};return{...J,...J.global,...Z}}getGlobal(){return(this.lock?this.lock.getData():{}).global||{}}getSite(J){return(this.lock?this.lock.getData():{}).sites?.[J]||{}}async updateGlobal(J){let Q=this.get();await this.update({global:{...Q.global,...J}})}async updateSite(J,Q){let Z=this.get();await this.update({sites:{...Z.sites,[J]:{...Z.sites?.[J],...Q}}})}getCurrentSiteSettings(){return this.getSite("weread")}async updateCurrentSite(J){return this.updateSite("weread",J)}async update(J){if(!this.lock){$.error("[SettingsStore] Lock not initialized");return}let{_version:Q,...Z}=J,z=["zoom","autoUpdate","lastPage"],P=["readerWide","hideToolbar","lastReaderUrl","scrollPosition","readingProgress","autoFlip"],q=this.lock.getData(),K=!1,b={...q};if("global"in Z)b.global={...q.global,...Z.global},K=!0;if("sites"in Z)b.sites={...q.sites,...Z.sites},K=!0;let L={};for(let j in Z)if(j!=="global"&&j!=="sites")L[j]=Z[j];if(Object.keys(L).length>0){let j={},F={};for(let D in L)if(z.includes(D))j[D]=L[D];else if(P.includes(D))F[D]=L[D];if(Object.keys(j).length>0)b.global={...q.global,...j},K=!0;if(Object.keys(F).length>0){let D=Y().siteId;b.sites={...q.sites,[D]:{...q.sites?.[D],...F}},K=!0}}if(!K)return;let B=this.lock.tryUpdate(b);$.debug("[SettingsStore] Update: version",B.version-1,"->",B.version,"partial:",Z),this.notify();let N={_version:B.version,global:B.data.global,sites:B.data.sites};try{await X("save_settings",{settings:N,version:B.version}),$.debug("[SettingsStore] Saved successfully with version:",B.version)}catch(j){$.error("[SettingsStore] Failed to save settings",j),this.lock.forceSet(B.data,B.version-1),this.notify()}}subscribe(J){if(this.listeners.add(J),this.initialized&&this.lock)J(this.get());return()=>this.listeners.delete(J)}notify(){if(!this.lock)return;let J=this.get();this.listeners.forEach((Q)=>Q(J))}}var G;var A=f(()=>{U();W();V();G=H.getInstance()});w();W();class R{matchesCurrentDomain(){let J=window.location.hostname;return(Array.isArray(this.domain)?this.domain:[this.domain]).some((Z)=>J===Z||J.endsWith(`.${Z}`))}matchesPath(J){let Q=window.location.pathname,Z=window.location.href;if(typeof J==="string")return Q.includes(J)||Z.includes(J);else return J.test(Q)||J.test(Z)}triggerKey(J){let Q=new KeyboardEvent("keydown",{key:J,code:J==="Right"?"ArrowRight":J==="Left"?"ArrowLeft":J,keyCode:J==="Right"?39:J==="Left"?37:0,bubbles:!0,cancelable:!0});document.dispatchEvent(Q)}clickElement(J){let Q=document.querySelector(J);if(Q)return Q.click(),!0;return!1}}class h extends R{id="weread";name="微信读书";domain="weread.qq.com";isReaderPage(){return this.matchesPath("/web/reader/")}isHomePage(){let J=window.location.pathname;return J==="/"||J==="/web"||J.startsWith("/web/shelf")}getWideModeCSS(J){if(J)return`
        /* 微信读书 - 宽屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 96% !important;
          max-width: calc(100vw - 224px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 80px) !important;
        }
      `;else return`
        /* 微信读书 - 窄屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 80% !important;
          max-width: calc(100vw - 424px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 120px) !important;
        }
      `}getToolbarCSS(J){if(J)return`
        /* 微信读书 - 隐藏工具栏 */
        .readerControls {
          display: none !important;
        }
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 124px) !important;
        }
        .app_content {
          max-width: calc(100vw - 124px) !important;
        }
      `;else return`
        /* 微信读书 - 显示工具栏 */
        .readerControls {
          display: block !important;
        }
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 224px) !important;
        }
        .app_content {
          max-width: calc(100vw - 224px) !important;
        }
      `}getDarkThemeCSS(){return`
      html, body {
        background-color: #222222 !important;
      }
    `}getLightThemeCSS(){return`
      html, body {
        background-color: #ffffff !important;
      }
    `}nextPage(){this.triggerKey("Right")}prevPage(){this.triggerKey("Left")}isDoubleColumn(){return!!document.querySelector('.readerControls[is-horizontal="true"]')}isAtBottom(){let J=document.documentElement.scrollHeight;return window.innerHeight+window.scrollY>=J-300}getNextChapterSelector(){return".readerFooter_button"}clickNextChapter(){let J=document.querySelector(this.getNextChapterSelector());if(J)J.click()}getReaderMenuItems(){return["reader_wide","hide_toolbar","auto_flip"]}}var e=[h],n=()=>{return e.map((J)=>new J)};V();A();W();var a="__wxrd_scroll_restored";class O{static isRestorationComplete(){return!!window[a]}static markRestorationComplete(){if(!this.isRestorationComplete())$.debug("[ScrollState] Restoration marked as complete - unlocking save/auto-scroll"),window[a]=!0}static async waitForRestoration(J=2000){if(this.isRestorationComplete())return;return new Promise((Q)=>{let Z=Date.now(),z=()=>{if(this.isRestorationComplete()){Q();return}if(Date.now()-Z>J){$.warn(`[ScrollState] Timeout waiting for restoration (${J}ms)`),Q();return}setTimeout(z,100)};z()})}}W();class v{siteContext;currentIsReader=!1;initialized=!1;scrollSaveTimer=null;lastSavedScrollY=0;checkRouteHandler=null;titleObserver=null;scrollHandler=null;safetyTimeout=null;originalPushState=null;originalReplaceState=null;constructor(){this.siteContext=Y(),this.init()}async init(){await G.init(),this.safetyTimeout=setTimeout(()=>{if(!O.isRestorationComplete())$.warn("[IPCManager] Force enabling scroll save after timeout"),O.markRestorationComplete()},1e4),this.monitorRoute(),this.monitorTitle(),this.monitorScroll()}monitorRoute(){this.checkRouteHandler=()=>{let z=window.location.href,P=window.location.pathname,q=this.siteContext.isReaderPage,K=this.currentIsReader!==q;if(this.currentIsReader=q,this.handleLastPageSaving(q,z),K)this.dispatchRouteChanged(q,z,P)},window.addEventListener("popstate",this.checkRouteHandler),this.originalPushState=history.pushState,history.pushState=(...z)=>{let P=this.originalPushState.apply(history,z);if(this.checkRouteHandler)this.checkRouteHandler();return P},this.originalReplaceState=history.replaceState,history.replaceState=(...z)=>{let P=this.originalReplaceState.apply(history,z);if(this.checkRouteHandler)this.checkRouteHandler();return P},this.checkRouteHandler();let J=window.location.href,Q=window.location.pathname,Z=this.siteContext.isReaderPage;this.dispatchRouteChanged(Z,J,Q)}handleLastPageSaving(J,Q){let Z=G.get();if(Z.lastPage&&J){if(Z.lastReaderUrl!==Q)G.update({lastReaderUrl:Q})}}dispatchRouteChanged(J,Q,Z){let z={isReader:J,url:Q,pathname:Z};window.dispatchEvent(new CustomEvent("wxrd:route-changed",{detail:z})),window.dispatchEvent(new CustomEvent("ipc:route-changed",{detail:z}))}monitorTitle(){let J=document.querySelector("title");if(J)this.titleObserver=new MutationObserver(()=>{this.dispatchTitleChanged()}),this.titleObserver.observe(J,{childList:!0,characterData:!0,subtree:!0}),this.dispatchTitleChanged()}dispatchTitleChanged(){if(document.title&&document.title.trim()!==""){let J={title:document.title};window.dispatchEvent(new CustomEvent("ipc:title-changed",{detail:J}))}}monitorScroll(){this.scrollHandler=()=>{if(!this.currentIsReader)return;if(!G.get().lastPage)return;let Q=this.siteContext.currentAdapter;if(!Q||Q.isDoubleColumn())return;if(!O.isRestorationComplete())return;let Z=window.scrollY;if(Math.abs(Z-this.lastSavedScrollY)<50)return;if(this.scrollSaveTimer)clearTimeout(this.scrollSaveTimer);this.scrollSaveTimer=setTimeout(()=>{this.lastSavedScrollY=Z;let z=window.location.href,q={...G.get().readingProgress||{},[z]:Z};G.update({scrollPosition:Z,readingProgress:q})},500)},window.addEventListener("scroll",this.scrollHandler,{passive:!0})}destroy(){if(this.scrollSaveTimer)clearTimeout(this.scrollSaveTimer),this.scrollSaveTimer=null;if(this.safetyTimeout)clearTimeout(this.safetyTimeout),this.safetyTimeout=null;if(this.checkRouteHandler)window.removeEventListener("popstate",this.checkRouteHandler),this.checkRouteHandler=null;if(this.scrollHandler)window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null;if(this.originalPushState)history.pushState=this.originalPushState,this.originalPushState=null;if(this.originalReplaceState)history.replaceState=this.originalReplaceState,this.originalReplaceState=null;if(this.titleObserver)this.titleObserver.disconnect(),this.titleObserver=null}}U();A();V();W();var y="wxrd_has_restored";class m{appName="微信阅读";siteContext;pagehideHandler=null;visibilitychangeHandler=null;constructor(){this.siteContext=Y(),this.init()}async init(){await k();try{this.appName=await X("get_app_name")||"微信阅读"}catch(J){$.error("Failed to get app name:",J)}await G.init(),this.pagehideHandler=()=>{this.clearAutoFlipOnExit()},this.visibilitychangeHandler=()=>{if(document.visibilityState==="hidden")this.clearAutoFlipOnExit()},window.addEventListener("pagehide",this.pagehideHandler),document.addEventListener("visibilitychange",this.visibilitychangeHandler),await this.restoreLastPage(),this.restoreScrollPosition()}clearAutoFlipOnExit(){let J=G.get();if(J.autoFlip?.active)$.debug("[AppManager] Clearing autoFlip.active on exit"),_("[AppManager] Clearing autoFlip.active on exit"),G.update({autoFlip:{active:!1,interval:J.autoFlip.interval||15,keepAwake:J.autoFlip.keepAwake!==!1}})}async restoreLastPage(){if(sessionStorage.getItem(y)==="true")return;let Q=G.get();if(!this.siteContext.isReaderPage&&Q.lastPage&&Q.lastReaderUrl){let z=`[AppManager] Restoring last page: ${Q.lastReaderUrl}`;_(z),$.debug("[AppManager] Restoring last page:",Q.lastReaderUrl),sessionStorage.setItem(y,"true"),window.location.href=Q.lastReaderUrl}else sessionStorage.setItem(y,"true")}restoreScrollPosition(){if(O.isRestorationComplete())return;let J=G.get(),Q=this.siteContext.isReaderPage,Z=window.location.href,P=(J.readingProgress||{})[Z]??J.scrollPosition;if(!Q||!J.lastPage||P===void 0||P===null){O.markRestorationComplete();return}let q=this.siteContext.currentAdapter;if(!q||q.isDoubleColumn()){O.markRestorationComplete();return}$.debug("[AppManager] Planning to restore scroll position:",P,"for URL:",Z),_(`[AppManager] Planning to restore scroll position: ${P} for URL: ${Z}`);let K=0,b=50,L=0,B=()=>{try{let N=document.documentElement.scrollHeight,j=window.innerHeight,F=P+j;if(N>L)K=0,L=N;else K++;if(N>=F){$.debug(`[AppManager] Height sufficient (${N} >= ${F}), restoring to ${P}`),window.scrollTo({top:P,behavior:"instant"}),O.markRestorationComplete();return}if(K<b){window.scrollTo({top:N,behavior:"instant"}),document.dispatchEvent(new Event("scroll"));try{document.dispatchEvent(new WheelEvent("wheel",{deltaY:100,bubbles:!0}))}catch(D){}setTimeout(B,100)}else $.debug("[AppManager] Max restore attempts reached (stuck), giving up."),window.scrollTo({top:P,behavior:"instant"}),O.markRestorationComplete()}catch(N){$.error("[AppManager] Error during scroll restoration:",N),O.markRestorationComplete()}};setTimeout(B,500)}destroy(){if(this.pagehideHandler)window.removeEventListener("pagehide",this.pagehideHandler),this.pagehideHandler=null;if(this.visibilitychangeHandler)document.removeEventListener("visibilitychange",this.visibilitychangeHandler),this.visibilitychangeHandler=null}}A();V();U();function M(J,Q){let Z=document.getElementById(J);if(!Z)if(Z=document.createElement("style"),Z.id=J,document.head)document.head.appendChild(Z);else if(document.documentElement)document.documentElement.appendChild(Z);else{let z=new MutationObserver((P)=>{for(let q of P)if(q.addedNodes.length>0){if(document.head){document.head.appendChild(Z),z.disconnect();return}else if(document.documentElement){document.documentElement.appendChild(Z),z.disconnect();return}}});z.observe(document,{childList:!0})}Z.innerHTML=Q}function E(J){let Q=document.getElementById(J);if(Q)Q.remove()}W();class u{mouseHideTimer=null;isMouseHidden=!1;isScrollingOrSwiping=!1;scrollLockTimer=null;lastScreenX=0;lastScreenY=0;siteContext;onMouseMove=null;onMouseDown=null;constructor(J){this.siteContext=J,this.init()}init(){let J=()=>{if(this.isMouseHidden)this.showCursor();if(this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null;if(this.siteContext.isReaderPage)this.mouseHideTimer=window.setTimeout(()=>{this.hideCursor()},3000)},Q=0;this.onMouseMove=(Z)=>{if(this.isScrollingOrSwiping)return;let z=Math.abs(Z.screenX-this.lastScreenX),P=Math.abs(Z.screenY-this.lastScreenY);if(z<15&&P<15)return;this.lastScreenX=Z.screenX,this.lastScreenY=Z.screenY;let q=Date.now();if(q-Q>200)Q=q,J()},this.onMouseDown=J,document.addEventListener("mousemove",this.onMouseMove,!1),document.addEventListener("mousedown",this.onMouseDown,!1),J()}setScrollLock(J=200){if(this.isScrollingOrSwiping=!0,this.scrollLockTimer)clearTimeout(this.scrollLockTimer);this.scrollLockTimer=window.setTimeout(()=>{this.isScrollingOrSwiping=!1},J)}hideCursor(){if(this.isMouseHidden)return;if(!this.siteContext.isReaderPage)return;$.debug("[CursorHider] Hiding cursor"),X("set_cursor_visible",{visible:!1}).catch((J)=>$.error(J)),document.documentElement.classList.add("wxrd-hide-cursor"),M("wxrd-cursor-hide",`
      html.wxrd-hide-cursor,
      html.wxrd-hide-cursor * {
        cursor: none !important;
      }
    `),this.isMouseHidden=!0}showCursor(){if(!this.isMouseHidden)return;$.debug("[CursorHider] Showing cursor"),X("set_cursor_visible",{visible:!0}).catch((J)=>$.error(J)),document.documentElement.classList.remove("wxrd-hide-cursor"),E("wxrd-cursor-hide"),this.isMouseHidden=!1}destroy(){if(this.showCursor(),this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null;if(this.scrollLockTimer)window.clearTimeout(this.scrollLockTimer),this.scrollLockTimer=null;if(this.onMouseMove)document.removeEventListener("mousemove",this.onMouseMove,!1);if(this.onMouseDown)document.removeEventListener("mousedown",this.onMouseDown,!1)}}W();class S{swipeAccumulator=0;swipeResetTimer=null;swipeCooldown=!1;siteContext;onScrollLock;handler;constructor(J,Q){this.siteContext=J,this.onScrollLock=Q,this.handler=(Z)=>{this.onScrollLock(),this.handleWheel(Z)},this.init()}init(){window.addEventListener("wheel",this.handler,{passive:!1,capture:!0})}handleWheel(J){if(!this.siteContext.isReaderPage)return;let Q=this.siteContext.currentAdapter;if(!Q||!Q.isDoubleColumn())return;let{deltaX:Z,deltaY:z}=J;if(Math.abs(Z)>Math.abs(z))J.preventDefault();else return;if(this.swipeCooldown)return;if(Math.abs(Z)<2)return;if(this.swipeAccumulator+=Z,this.swipeResetTimer)clearTimeout(this.swipeResetTimer);this.swipeResetTimer=setTimeout(()=>{this.swipeAccumulator=0},250);let q=50;if(this.swipeAccumulator>=q)$.debug("[SwipeHandler] Swipe left detected, next page"),Q.nextPage(),this.swipeAccumulator=0,this.startCooldown();else if(this.swipeAccumulator<=-q)$.debug("[SwipeHandler] Swipe right detected, prev page"),Q.prevPage(),this.swipeAccumulator=0,this.startCooldown()}startCooldown(){this.swipeCooldown=!0,setTimeout(()=>{this.swipeCooldown=!1,this.swipeAccumulator=0},800)}destroy(){if(this.swipeResetTimer)clearTimeout(this.swipeResetTimer),this.swipeResetTimer=null;window.removeEventListener("wheel",this.handler,{capture:!0})}}U();W();class c{isActive=!1;intervalSeconds=30;keepAwake=!1;doubleTimer=null;singleRafId=null;lastFrameTime=0;lastScrollTime=0;accumulatedMove=0;countdown=30;originalTitle=null;appName="微信阅读";elapsedTime=0;siteContext;bottomTriggered=!1;onScrollLock;generation=0;constructor(J,Q){this.siteContext=J,this.onScrollLock=Q,this.initAppName()}async initAppName(){try{this.appName=await X("get_app_name")||"微信阅读"}catch(J){$.error("AutoFlipper: Failed to get app name",J)}}updateState(J){let Q=J.autoFlip||{active:!1,interval:15,keepAwake:!0},Z=!!Q.active,z=Q.interval>0?Q.interval:15,P=!!Q.keepAwake;if(!Z){if(this.isActive)this.stopAll(),this.isActive=!1}else if(!this.isActive||this.intervalSeconds!==z||this.keepAwake!==P){if(this.isActive)this.stopAll();this.isActive=!0,this.intervalSeconds=z,this.keepAwake=P,this.start()}}stopAll(){if(this.isActive=!1,this.generation++,this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.originalTitle)document.title=this.originalTitle,this.originalTitle=null;this.elapsedTime=0}start(){let J=this.siteContext.currentAdapter;if(!J){$.warn("[AutoFlipper] No adapter found");return}if(J.isDoubleColumn())this.startDoubleColumnLogic(J);else this.startSingleColumnLogic(J)}startDoubleColumnLogic(J){if(this.doubleTimer)return;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.countdown=this.intervalSeconds,!this.originalTitle)this.originalTitle=document.title;this.doubleTimer=setInterval(()=>{if(!J.isDoubleColumn()){this.stopAll(),this.startSingleColumnLogic(J);return}if(document.hidden&&!this.keepAwake)return;if(this.countdown--,document.title=`${this.appName} - 自动翻页 - ${this.countdown} 秒`,this.countdown<=0)this.onScrollLock(),J.nextPage(),this.countdown=this.intervalSeconds},1000)}startSingleColumnLogic(J){if(this.singleRafId)return;if(this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(!O.isRestorationComplete()){setTimeout(()=>{if(this.isActive)this.startSingleColumnLogic(J)},200);return}if(this.countdown=this.intervalSeconds,this.elapsedTime=0,!this.originalTitle)this.originalTitle=document.title;this.lastFrameTime=performance.now(),this.lastScrollTime=performance.now();let Q=this.generation;this.singleRafId=requestAnimationFrame((Z)=>this.singleColumnLoop(Z,J,Q))}singleColumnLoop(J,Q,Z){if(Z!==this.generation)return;if(!this.isActive){this.singleRafId=null;return}if(Q.isDoubleColumn()){this.stopAll(),this.startDoubleColumnLogic(Q);return}let z=J-this.lastFrameTime;if(this.lastFrameTime=J,z>100)z=16,this.accumulatedMove=0;else if(z>50)z=50;if(this.elapsedTime+=z,this.elapsedTime>=1000){let B=window.scrollY,N=document.documentElement.scrollHeight,j=window.innerHeight,F=Math.max(1,N-j),D=Math.min(100,Math.max(0,Math.round(B/F*1000)/10));this.elapsedTime-=1000,document.title=`${this.appName} - 自动翻页 - 已读 ${D}%`}if(document.hidden&&!this.keepAwake){this.singleRafId=requestAnimationFrame((B)=>this.singleColumnLoop(B,Q,Z));return}let P=J-this.lastScrollTime;if(P<30){this.singleRafId=requestAnimationFrame((B)=>this.singleColumnLoop(B,Q,Z));return}this.lastScrollTime=J;let q=window.innerHeight,K=this.intervalSeconds>0?this.intervalSeconds:30,L=q/(K*1000)*P;if(this.accumulatedMove+=L,this.accumulatedMove>=1){this.onScrollLock();let B=Math.floor(this.accumulatedMove);window.scrollBy(0,B),this.accumulatedMove-=B;let N=Q.isAtBottom();if(N&&!this.bottomTriggered){if($.debug("[AutoFlipper] Reached bottom, triggering next page"),this.bottomTriggered=!0,Q.nextPage(),Q.clickNextChapter)Q.clickNextChapter();if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;setTimeout(()=>{if(this.bottomTriggered=!1,this.isActive&&this.generation===Z)this.startSingleColumnLogic(Q)},1e4);return}else if(!N)this.bottomTriggered=!1}this.singleRafId=requestAnimationFrame((B)=>this.singleColumnLoop(B,Q,Z))}}class p{cursorHider;swipeHandler;autoFlipper;siteContext;routeChangedHandler=null;constructor(){this.siteContext=Y(),this.cursorHider=new u(this.siteContext);let J=(Q)=>{this.cursorHider.setScrollLock(Q)};this.swipeHandler=new S(this.siteContext,J),this.autoFlipper=new c(this.siteContext,J),this.init()}init(){G.subscribe((J)=>{this.updateState(J)}),this.routeChangedHandler=(J)=>{if(!J.detail.isReader){let Z=G.get();if(Z.autoFlip?.active)this.autoFlipper.stopAll(),G.update({autoFlip:{...Z.autoFlip,active:!1}})}},window.addEventListener("ipc:route-changed",this.routeChangedHandler)}updateState(J){this.autoFlipper.updateState(J)}destroy(){if(this.routeChangedHandler)window.removeEventListener("ipc:route-changed",this.routeChangedHandler),this.routeChangedHandler=null;this.cursorHider.destroy(),this.swipeHandler.destroy(),this.autoFlipper.stopAll()}}U();A();V();W();class g{isReader=!1;initialized=!1;siteContext;routeChangedHandler=null;legacyRouteChangedHandler=null;titleChangedHandler=null;unlistenMenuAction=null;constructor(){this.siteContext=Y(),this.init()}async init(){this.unlistenMenuAction=await x("menu-action",(J)=>{this.handleMenuAction(J.payload)}),this.routeChangedHandler=(J)=>{this.isReader=J.detail.isReader,this.updateMenuEnabledStatus()},this.legacyRouteChangedHandler=(J)=>{this.isReader=J.detail.isReader,this.updateMenuEnabledStatus()},this.titleChangedHandler=(J)=>{this.updateWindowTitle(J.detail.title)},window.addEventListener("ipc:route-changed",this.routeChangedHandler),window.addEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),window.addEventListener("ipc:title-changed",this.titleChangedHandler),await i(),this.isReader=this.siteContext.isReaderPage,this.initialized=!0,G.subscribe(async(J)=>{if(J.zoom!==void 0)try{await X("set_zoom",{value:J.zoom})}catch(Q){$.error("[MenuManager] set_zoom failed:",Q)}await this.syncMenuState(J)}),await this.syncMenuState()}checkIsReader(){return this.siteContext.isReaderPage}async updateMenuEnabledStatus(){if(!window.__TAURI__)return;let J=this.checkIsReader(),Q=this.siteContext.siteId;$.debug("[MenuManager] Updating menu enabled status. isReader:",J,"siteId:",Q,"URL:",window.location.href);try{await X("set_menu_item_enabled",{id:"reader_wide",enabled:J}),await X("set_menu_item_enabled",{id:"hide_toolbar",enabled:J}),await X("set_menu_item_enabled",{id:"auto_flip",enabled:J}),await X("set_menu_item_enabled",{id:"zoom_in",enabled:!0}),await X("set_menu_item_enabled",{id:"zoom_out",enabled:!0}),await X("set_menu_item_enabled",{id:"zoom_reset",enabled:!0})}catch(Z){$.error("[MenuManager] Error updating menu enabled status:",Z)}}async updateWindowTitle(J){if(!window.__TAURI__)return;try{await X("set_title",{title:J})}catch(Q){$.error("[MenuManager] Error setting window title:",Q)}}async syncMenuState(J=G.get()){if(!this.initialized)return;let Q=!!J.readerWide,Z=!!J.hideToolbar,z=!!J.autoFlip?.active;await this.updateMenuEnabledStatus();try{await X("update_menu_state",{id:"reader_wide",state:Q}),await X("update_menu_state",{id:"hide_toolbar",state:Z}),await X("update_menu_state",{id:"auto_flip",state:z})}catch(P){$.error("[MenuManager] Error updating menu state:",P)}}handleMenuAction(J){let Q=G.get(),Z=this.siteContext.siteId;switch($.debug("[MenuManager] Handling action:",J,"siteId:",Z),J){case"reader_wide":{let z=!Q.readerWide,P={readerWide:z};if(!z&&Q.hideToolbar)P.hideToolbar=!1;if(Z!=="unknown")G.updateSite(Z,P);else G.update(P)}break;case"hide_toolbar":if(Z!=="unknown")G.updateSite(Z,{hideToolbar:!Q.hideToolbar});else G.update({hideToolbar:!Q.hideToolbar});break;case"auto_flip":{let z=Q.autoFlip||{active:!1,interval:15,keepAwake:!0},P=!z.active,q={autoFlip:{...z,active:P}};if(Z!=="unknown")G.updateSite(Z,q);else G.update(q)}break;case"zoom_in":{let z=Q.zoom||1;z=Math.round((z+0.1)*10)/10,G.updateGlobal({zoom:z})}break;case"zoom_out":{let z=Q.zoom||1;if(z=Math.round((z-0.1)*10)/10,z<0.1)z=0.1;G.updateGlobal({zoom:z})}break;case"zoom_reset":G.updateGlobal({zoom:1});break}}destroy(){if(this.routeChangedHandler)window.removeEventListener("ipc:route-changed",this.routeChangedHandler),this.routeChangedHandler=null;if(this.legacyRouteChangedHandler)window.removeEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),this.legacyRouteChangedHandler=null;if(this.titleChangedHandler)window.removeEventListener("ipc:title-changed",this.titleChangedHandler),this.titleChangedHandler=null;if(this.unlistenMenuAction)this.unlistenMenuAction(),this.unlistenMenuAction=null}}class d{clickHandler=null;darkModeQuery=null;darkModeChangeHandler=null;constructor(){this.init()}initLinks(){window.open=function(J,Q,Z){if(J)window.location.href=J.toString();return null},this.clickHandler=(J)=>{let Z=J.target.closest("a");if(Z&&Z.target==="_blank")Z.target="_self"},document.addEventListener("click",this.clickHandler,!0)}shouldEnableDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}applyTheme(J){let Q=window.self!==window.top,Z=`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,z=`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    `,P=Q?`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `:`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,q="wxrd-dark-mode-filter";if(J)M("wxrd-dark-mode-filter",P);else E("wxrd-dark-mode-filter")}initDarkMode(){this.applyTheme(this.shouldEnableDarkMode()),this.darkModeQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.darkModeChangeHandler=(J)=>{this.applyTheme(J.matches)},this.darkModeQuery.addEventListener("change",this.darkModeChangeHandler)}init(){this.initLinks(),this.initDarkMode()}destroy(){if(this.clickHandler)document.removeEventListener("click",this.clickHandler,!0),this.clickHandler=null;if(this.darkModeQuery&&this.darkModeChangeHandler)this.darkModeQuery.removeEventListener("change",this.darkModeChangeHandler),this.darkModeQuery=null,this.darkModeChangeHandler=null;E("wxrd-dark-mode-filter")}}A();V();W();class l{isWide=!1;isHideToolbar=!1;isReader=!1;siteContext;routeChangedHandler=null;legacyRouteChangedHandler=null;darkModeQuery=null;darkModeHandler=null;constructor(){this.siteContext=Y(),this.init()}async init(){if(this.isReader=this.siteContext.isReaderPage,!this.isReader)$.debug("[StyleManager] Starting on non-reader page, clearing any leftover reader styles"),this.clearReaderStyles();this.handleTheme(),G.subscribe(()=>{this.updateStyles(G.get())}),this.updateStyles(G.get()),this.routeChangedHandler=(J)=>{let Q=this.isReader;if(this.isReader=J.detail.isReader,Q&&!this.isReader)$.debug("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles();if(!Q&&this.isReader)$.debug("[StyleManager] Entering reader page, applying styles"),this.applyStyles()},this.legacyRouteChangedHandler=(J)=>{let Q=this.isReader;if(this.isReader=J.detail.isReader,Q&&!this.isReader)$.debug("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles()},window.addEventListener("ipc:route-changed",this.routeChangedHandler),window.addEventListener("wxrd:route-changed",this.legacyRouteChangedHandler)}handleTheme(){this.darkModeHandler=(J)=>{let Q=this.siteContext.currentAdapter;if(Q&&Q.getDarkThemeCSS&&Q.getLightThemeCSS){let Z=J.matches?Q.getDarkThemeCSS():Q.getLightThemeCSS();M("wxrd-base-bg",Z)}else{let Z=J.matches?"html, body { background-color: #222222 !important; }":"html, body { background-color: #ffffff !important; }";M("wxrd-base-bg",Z)}},this.darkModeQuery=window.matchMedia("(prefers-color-scheme: dark)"),this.darkModeHandler(this.darkModeQuery),this.darkModeQuery.addEventListener("change",this.darkModeHandler)}updateStyles(J){let Q=!!J.readerWide,Z=!!J.hideToolbar;if(Q!==this.isWide||Z!==this.isHideToolbar)this.isWide=Q,this.isHideToolbar=Z,this.applyStyles()}applyStyles(){if(!this.isReader)return;let J=this.siteContext.currentAdapter;if(J){let Q=J.getWideModeCSS(this.isWide),Z=J.getToolbarCSS(this.isHideToolbar);M("wxrd-wide-mode",Q),M("wxrd-hide-toolbar",Z)}else $.warn("[StyleManager] No adapter found, styles not applied");window.dispatchEvent(new Event("resize"))}clearReaderStyles(){E("wxrd-wide-mode"),E("wxrd-hide-toolbar")}destroy(){if(this.routeChangedHandler)window.removeEventListener("ipc:route-changed",this.routeChangedHandler),this.routeChangedHandler=null;if(this.legacyRouteChangedHandler)window.removeEventListener("wxrd:route-changed",this.legacyRouteChangedHandler),this.legacyRouteChangedHandler=null;if(this.darkModeQuery&&this.darkModeHandler)this.darkModeQuery.removeEventListener("change",this.darkModeHandler),this.darkModeQuery=null,this.darkModeHandler=null;this.clearReaderStyles(),E("wxrd-base-bg")}}(function(){if(console.log("[Inject] Script loaded. Timestamp:",new Date().toISOString()),console.log("[Inject] Window Location:",window.location.href),window.wxrd_injected)return;window.wxrd_injected=!0;try{let J=I();$.info(`[Inject] Starting injection on: ${window.location.href}`),$.info(`[Inject] Hostname: ${window.location.hostname}`),$.info(`[Inject] User Agent: ${navigator.userAgent}`);try{let P=n();if(!P||P.length===0)$.error("[Inject] No adapters found! Auto-discovery failed.");else $.info(`[Inject] Found ${P.length} adapters:`,P.map((q)=>q.id).join(", ")),P.forEach((q)=>{J.register(q);let K=q.matchesCurrentDomain?q.matchesCurrentDomain():!1;$.debug(`[Inject] Registered adapter: ${q.name} (${q.id}) - Match: ${K}`)})}catch(P){$.error("[Inject] Failed to register adapters",P)}let Q=J.getCurrentAdapter();if($.info(`[Inject] Location check - Href: ${window.location.href}, Hostname: ${window.location.hostname}`),!Q){if($.warn(`[Inject] No adapter matched hostname '${window.location.hostname}'`),window.location.hostname.includes("weread.qq.com")||window.location.href.includes("weread.qq.com")){$.info("[Inject] Hostname contains weread.qq.com, forcing WeRead adapter");let P=adapterInstances.find((q)=>q.id==="weread");if(P)P.matchesCurrentDomain=()=>!0,Q=J.getCurrentAdapter()}}if(Q)$.info(`[Inject] Detected site: ${Q.name} (isReader: ${J.isReaderPage()})`);else $.error("[Inject] FATAL: No matching adapter found for current site. Feature injection will fail.");let Z=J.isReaderPage(),z=(P,q)=>{try{$.info(`[Inject] Initializing ${P}...`),q(),$.info(`[Inject] Initialized ${P}`)}catch(K){$.error(`[Inject] Failed to initialize ${P}`,K)}};if(z("IPCManager",()=>new v),z("MenuManager",()=>new g),z("AppManager",()=>new m),z("TurnerManager",()=>new p),!Z)z("ThemeManager",()=>new d);else $.debug("[Inject] Skipping ThemeManager (Reader mode active)");z("StyleManager",()=>new l),setTimeout(async()=>{try{let{settingsStore:P}=await Promise.resolve().then(() => (A(),s)),q=P.get();$.info("[Inject] Post-init settings check:",JSON.stringify(q)),$.info("[Inject] Current adapter:",J.getCurrentAdapter()?.id),$.info("[Inject] Is Reader Page:",J.isReaderPage())}catch(P){$.error("[Inject] Failed to perform post-init check",P)}},2000)}catch(J){console.error("[Inject] Critical error during initialization:",J),$.error("[Inject] Critical initialization error",J)}})();
