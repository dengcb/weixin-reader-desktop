class D{static instance;adapters=new Map;currentAdapter=null;constructor(){}static getInstance(){if(!D.instance)D.instance=new D;return D.instance}register(J){this.adapters.set(J.id,J),console.log(`[SiteRegistry] Registered adapter: ${J.name} (${J.id})`)}registerAll(J){J.forEach((Z)=>this.register(Z))}getCurrentAdapter(){if(this.currentAdapter){let J=this.currentAdapter;if("matchesCurrentDomain"in J&&typeof J.matchesCurrentDomain==="function"){if(J.matchesCurrentDomain())return J}}for(let J of this.adapters.values())if("matchesCurrentDomain"in J&&typeof J.matchesCurrentDomain==="function"){if(J.matchesCurrentDomain())return this.currentAdapter=J,console.log(`[SiteRegistry] Detected site: ${J.name}`),J}return this.currentAdapter=null,console.warn("[SiteRegistry] No matching adapter found for current site"),null}getAdapter(J){return this.adapters.get(J)}getAllAdapters(){return Array.from(this.adapters.values())}isReaderPage(){let J=this.getCurrentAdapter();return J?J.isReaderPage():!1}isHomePage(){let J=this.getCurrentAdapter();return J?J.isHomePage():!1}getReaderMenuItems(){let J=this.getCurrentAdapter();if(J&&J.getReaderMenuItems)return J.getReaderMenuItems();return["reader_wide","hide_toolbar","auto_flip"]}}var X=()=>D.getInstance();class H{matchesCurrentDomain(){let J=window.location.hostname;return(Array.isArray(this.domain)?this.domain:[this.domain]).some(($)=>J===$||J.endsWith(`.${$}`))}matchesPath(J){let Z=window.location.pathname,$=window.location.href;if(typeof J==="string")return Z.includes(J)||$.includes(J);else return J.test(Z)||J.test($)}triggerKey(J){let Z=new KeyboardEvent("keydown",{key:J,code:J==="Right"?"ArrowRight":J==="Left"?"ArrowLeft":J,keyCode:J==="Right"?39:J==="Left"?37:0,bubbles:!0,cancelable:!0});document.dispatchEvent(Z)}clickElement(J){let Z=document.querySelector(J);if(Z)return Z.click(),!0;return!1}}class x extends H{id="weread";name="微信读书";domain="weread.qq.com";isReaderPage(){return this.matchesPath("/web/reader/")}isHomePage(){let J=window.location.pathname;return J==="/"||J==="/web"||J.startsWith("/web/shelf")}getWideModeCSS(J){if(J)return`
        /* 微信读书 - 宽屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 96% !important;
          max-width: calc(100vw - 224px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 80px) !important;
        }
      `;else return`
        /* 微信读书 - 窄屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 80% !important;
          max-width: calc(100vw - 424px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 120px) !important;
        }
      `}getToolbarCSS(J){if(J)return`
        /* 微信读书 - 隐藏工具栏 */
        .readerControls {
          display: none !important;
        }
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 124px) !important;
        }
        .app_content {
          max-width: calc(100vw - 124px) !important;
        }
      `;else return`
        /* 微信读书 - 显示工具栏 */
        .readerControls {
          display: block !important;
        }
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 224px) !important;
        }
        .app_content {
          max-width: calc(100vw - 224px) !important;
        }
      `}getDarkThemeCSS(){return`
      html, body {
        background-color: #222222 !important;
      }
    `}getLightThemeCSS(){return`
      html, body {
        background-color: #ffffff !important;
      }
    `}nextPage(){this.triggerKey("Right")}prevPage(){this.triggerKey("Left")}isDoubleColumn(){return!!document.querySelector('.readerControls[is-horizontal="true"]')}isAtBottom(){let J=document.documentElement.scrollHeight;return window.innerHeight+window.scrollY>=J-300}getNextChapterSelector(){return".readerFooter_button"}clickNextChapter(){let J=document.querySelector(this.getNextChapterSelector());if(J)J.click()}getReaderMenuItems(){return["reader_wide","hide_toolbar","auto_flip"]}}var q=(J,Z)=>{if(window.__TAURI__)return window.__TAURI__.core.invoke(J,Z);return console.warn(`[Tauri] Invoke '${J}' failed: API not found`),Promise.resolve({})},E=(J,Z)=>{if(window.__TAURI__)return window.__TAURI__.event.listen(J,Z);return console.warn(`[Tauri] Listen '${J}' failed: API not found`),Promise.resolve(()=>{})};var b=()=>{return new Promise((J)=>{if(window.__TAURI__){J();return}let Z=setInterval(()=>{if(window.__TAURI__)clearInterval(Z),J()},10);setTimeout(()=>{clearInterval(Z),J()},2000)})},R=async()=>{await b();let J=100,Z=50;console.log("[Tauri] Waiting for IPC to be ready...");for(let $=0;$<J;$++)try{await q("get_app_name"),console.log(`[Tauri] IPC ready after ${$*Z}ms`);return}catch(z){if($<J-1)await new Promise((P)=>setTimeout(P,Z))}console.warn(`[Tauri] IPC not ready after ${J*Z}ms, continuing anyway`)},O=(J)=>{if(window.__TAURI__)q("log_to_file",{message:J}).catch(()=>{});else console.log(J)};class U{data;version;constructor(J,Z=0){this.data=J,this.version=Z,this.data._version=this.version}getData(){return{...this.data}}getVersion(){return this.version}tryUpdate(J){let Z=this.version+1,$={...this.data,...J,_version:Z};return this.data=$,this.version=Z,{success:!0,version:Z,data:this.getData()}}loadFromExternal(J,Z){if(Z>=this.version)return this.data={...J,_version:Z},this.version=Z,!0;return!1}isStale(J){return J>this.version}forceSet(J,Z){this.data={...J,_version:Z},this.version=Z}}class I{static instance;lock=null;listeners=new Set;initialized=!1;constructor(){}static getInstance(){if(!I.instance)I.instance=new I;return I.instance}async init(){if(this.initialized)return;try{let J=await q("get_settings")||{},Z=J._version||0,$={_version:Z,readerWide:!1,hideToolbar:!1,zoom:0.8,lastPage:!0,autoUpdate:!0,...J,autoFlip:{active:!1,interval:15,keepAwake:!0,...J.autoFlip||{}}};this.lock=new U($,Z),console.log("[SettingsStore] Initialized optimistic lock with version:",Z)}catch(J){console.error("SettingsStore: Failed to load settings",J);let Z={_version:0,readerWide:!1,hideToolbar:!1,zoom:0.8,lastPage:!0,autoUpdate:!0,autoFlip:{active:!1,interval:15,keepAwake:!0}};this.lock=new U(Z,0)}E("settings-updated",async()=>{if(!this.lock)return;let J=await q("get_settings")||{},Z=J._version||0;if(console.log("[SettingsStore] Received settings-updated event, backend version:",Z,"local version:",this.lock.getVersion()),this.lock.loadFromExternal(J,Z))console.log("[SettingsStore] Loaded newer version from backend:",Z),this.notify();else console.log("[SettingsStore] Ignoring older version from backend:",Z,"<",this.lock.getVersion())}),this.initialized=!0,this.notify()}get(){return this.lock?this.lock.getData():{}}async update(J){if(!this.lock){console.error("[SettingsStore] Lock not initialized");return}let{_version:Z,...$}=J,z=this.lock.tryUpdate($);console.log("[SettingsStore] Update: version",z.version-1,"->",z.version,"partial:",$);try{await q("save_settings",{settings:z.data,version:z.version}),console.log("[SettingsStore] Saved successfully with version:",z.version)}catch(P){console.error("[SettingsStore] Failed to save settings",P),this.lock.forceSet(z.data,z.version-1)}this.notify()}subscribe(J){if(this.listeners.add(J),this.initialized&&this.lock)J(this.lock.getData());return()=>this.listeners.delete(J)}notify(){if(!this.lock)return;let J=this.lock.getData();this.listeners.forEach((Z)=>Z(J))}}var Q=I.getInstance();class B{static isRestorationComplete(){return!!window.__wxrd_scroll_restored}static markRestorationComplete(){if(!this.isRestorationComplete())console.log("[ScrollState] Restoration marked as complete - unlocking save/auto-scroll"),window.__wxrd_scroll_restored=!0}static async waitForRestoration(J=2000){if(this.isRestorationComplete())return;return new Promise((Z)=>{let $=Date.now(),z=()=>{if(this.isRestorationComplete()){Z();return}if(Date.now()-$>J){console.warn(`[ScrollState] Timeout waiting for restoration (${J}ms)`),Z();return}setTimeout(z,100)};z()})}}class M{siteRegistry=X();currentIsReader=!1;initialized=!1;scrollSaveTimer=null;lastSavedScrollY=0;constructor(){this.init()}async init(){await Q.init(),setTimeout(()=>{if(!B.isRestorationComplete())console.warn("[IPCManager] Force enabling scroll save after timeout"),B.markRestorationComplete()},1e4),this.monitorRoute(),this.monitorTitle(),this.monitorScroll()}monitorRoute(){let J=()=>{let z=window.location.href,P=window.location.pathname,G=this.siteRegistry.isReaderPage(),Y=this.siteRegistry.getCurrentAdapter();console.log("[IPCManager] Route check:",{url:z,pathname:P,isReader:G,adapter:Y?.name||"none",initialized:this.initialized});let N=this.currentIsReader!==G;if(this.currentIsReader=G,this.handleLastPageSaving(G,z),N)this.dispatchRouteChanged(G,z,P)};window.addEventListener("popstate",J);let Z=history.pushState;history.pushState=function(...z){let P=Z.apply(this,z);return J(),P};let $=history.replaceState;history.replaceState=function(...z){let P=$.apply(this,z);return J(),P},J()}handleLastPageSaving(J,Z){let $=Q.get();if($.lastPage&&J){if($.lastReaderUrl!==Z)console.log("[IPCManager] Saving reader URL:",Z),Q.update({lastReaderUrl:Z})}}dispatchRouteChanged(J,Z,$){let z={isReader:J,url:Z,pathname:$};window.dispatchEvent(new CustomEvent("wxrd:route-changed",{detail:z})),console.log("[IPCManager] Dispatching ipc:route-changed",z),window.dispatchEvent(new CustomEvent("ipc:route-changed",{detail:z}))}monitorTitle(){let J=document.querySelector("title");if(J)new MutationObserver(()=>{this.dispatchTitleChanged()}).observe(J,{childList:!0,characterData:!0,subtree:!0}),this.dispatchTitleChanged()}dispatchTitleChanged(){if(document.title&&document.title.trim()!==""){let J={title:document.title};console.log("[IPCManager] Dispatching ipc:title-changed",J),window.dispatchEvent(new CustomEvent("ipc:title-changed",{detail:J}))}}monitorScroll(){window.addEventListener("scroll",()=>{if(!this.currentIsReader)return;if(!Q.get().lastPage)return;let Z=this.siteRegistry.getCurrentAdapter();if(!Z||Z.isDoubleColumn())return;if(!B.isRestorationComplete())return;let $=window.scrollY;if(Math.abs($-this.lastSavedScrollY)<50)return;if(this.scrollSaveTimer)clearTimeout(this.scrollSaveTimer);this.scrollSaveTimer=setTimeout(()=>{this.lastSavedScrollY=$,console.log("[IPCManager] Saving scroll position:",$),Q.update({scrollPosition:$})},500)},{passive:!0})}}var A="wxrd_has_restored";class V{appName="微信阅读";siteRegistry=X();constructor(){this.init()}async init(){await b();try{this.appName=await q("get_app_name")||"微信阅读"}catch(J){console.error("Failed to get app name:",J)}await Q.init(),window.addEventListener("pagehide",()=>{this.clearAutoFlipOnExit()}),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden")this.clearAutoFlipOnExit()});try{let J=await q("get_settings");console.log("[AppManager] Backend settings:",JSON.stringify(J))}catch(J){console.error("[AppManager] Failed to get backend settings:",J)}await this.restoreLastPage(),this.restoreScrollPosition()}clearAutoFlipOnExit(){let J=Q.get();if(J.autoFlip?.active)console.log("[AppManager] Clearing autoFlip.active on exit"),O("[AppManager] Clearing autoFlip.active on exit"),q("save_settings",{settings:{autoFlip:{active:!1,interval:J.autoFlip.interval||15,keepAwake:J.autoFlip.keepAwake!==!1}}})}async restoreLastPage(){let J=sessionStorage.getItem(A);if(O(`[AppManager] Session flag: ${J}`),J==="true"){O("[AppManager] Already restored in this session, skipping"),console.log("[AppManager] Already restored in this session, skipping");return}let Z=Q.get(),$=this.siteRegistry.isReaderPage(),z=`[AppManager] restoreLastPage check: isReader=${$}, lastPage=${Z.lastPage}, lastReaderUrl=${Z.lastReaderUrl}`;if(O(z),console.log("[AppManager] restoreLastPage check:",{isReader:$,lastPage:Z.lastPage,lastReaderUrl:Z.lastReaderUrl}),!$&&Z.lastPage&&Z.lastReaderUrl){let P=`[AppManager] Restoring last page: ${Z.lastReaderUrl}`;O(P),console.log("[AppManager] Restoring last page:",Z.lastReaderUrl),sessionStorage.setItem(A,"true"),window.location.href=Z.lastReaderUrl}else{let P=`[AppManager] Marking as restored (no navigation needed): isReader=${$}, lastPage=${Z.lastPage}, hasUrl=${!!Z.lastReaderUrl}`;O(P),console.log("[AppManager] Marking as restored (no navigation needed)"),sessionStorage.setItem(A,"true")}}restoreScrollPosition(){if(B.isRestorationComplete()){console.log("[AppManager] Scroll already restored in this session, skipping");return}let J=Q.get();if(!this.siteRegistry.isReaderPage()||!J.lastPage||!J.scrollPosition){B.markRestorationComplete();return}let $=this.siteRegistry.getCurrentAdapter();if(!$||$.isDoubleColumn()){B.markRestorationComplete();return}let z=J.scrollPosition;console.log("[AppManager] Planning to restore scroll position:",z),O(`[AppManager] Planning to restore scroll position: ${z}`);let P=0,G=50,Y=()=>{P++;let N=document.documentElement.scrollHeight,K=window.innerHeight,L=z+K;if(N>=L){console.log(`[AppManager] Height sufficient (${N} >= ${L}), restoring to ${z}`),window.scrollTo({top:z,behavior:"instant"}),B.markRestorationComplete();return}if(P<G){console.log(`[AppManager] Chasing scroll: height ${N} < target ${z}, scrolling to bottom.`),window.scrollTo({top:N,behavior:"instant"}),document.dispatchEvent(new Event("scroll"));try{document.dispatchEvent(new WheelEvent("wheel",{deltaY:100,bubbles:!0}))}catch(w){}setTimeout(Y,100)}else console.log("[AppManager] Max restore attempts reached, giving up."),window.scrollTo({top:z,behavior:"instant"}),B.markRestorationComplete()};setTimeout(Y,500)}}function j(J,Z){let $=document.getElementById(J);if(!$)if($=document.createElement("style"),$.id=J,document.head)document.head.appendChild($);else if(document.documentElement)document.documentElement.appendChild($);else{let z=new MutationObserver((P)=>{for(let G of P)if(G.addedNodes.length>0){if(document.head){document.head.appendChild($),z.disconnect();return}else if(document.documentElement){document.documentElement.appendChild($),z.disconnect();return}}});z.observe(document,{childList:!0})}$.innerHTML=Z}function W(J){let Z=document.getElementById(J);if(Z)Z.remove()}class F{isActive=!1;intervalSeconds=30;keepAwake=!1;doubleTimer=null;singleRafId=null;lastFrameTime=0;lastScrollTime=0;accumulatedMove=0;countdown=30;originalTitle=null;appName="微信阅读";elapsedTime=0;siteRegistry=X();isProcessingUpdate=!1;swipeAccumulator=0;swipeThreshold=120;swipeResetTimer=null;swipeCooldown=!1;isReader=!1;bottomTriggered=!1;mouseHideTimer=null;isMouseHidden=!1;mouseAutoHideInitialized=!1;isScrollingOrSwiping=!1;scrollLockTimer=null;lastScreenX=0;lastScreenY=0;constructor(){this.init()}async init(){try{this.appName=await q("get_app_name")||"微信阅读"}catch(J){console.error("TurnerManager: Failed to get app name",J)}this.isReader=this.siteRegistry.isReaderPage(),this.initSwipeGesture(),this.initMouseAutoHide(),Q.subscribe((J)=>{this.updateState(J)}),window.addEventListener("ipc:route-changed",(J)=>{let Z=J.detail.isReader;if(this.isReader=Z,console.log("[TurnerManager] Route changed:",{isReader:Z,isActive:this.isActive}),!Z){if(this.isActive){console.log("[TurnerManager] Stopping auto flip and clearing setting"),this.stopAll();let $=Q.get();if($.autoFlip?.active)Q.update({autoFlip:{...$.autoFlip,active:!1}})}}})}initSwipeGesture(){}initMouseAutoHide(){if(this.mouseAutoHideInitialized)return;this.mouseAutoHideInitialized=!0;let J=()=>{if(this.isMouseHidden)this.showCursor();if(this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null;if(this.isReader)this.mouseHideTimer=window.setTimeout(()=>{this.hideCursor()},3000)},Z=0;document.addEventListener("mousemove",($)=>{if(this.isScrollingOrSwiping)return;let z=Math.abs($.screenX-this.lastScreenX),P=Math.abs($.screenY-this.lastScreenY);if(z<50&&P<50)return;this.lastScreenX=$.screenX,this.lastScreenY=$.screenY,console.log(`[TurnerManager] Mouse wake-up triggered! diffX=${z}, diffY=${P}`);let G=Date.now();if(G-Z>200)Z=G,J()},!1),document.addEventListener("mousedown",J,!1),window.addEventListener("wheel",($)=>{this.setScrollLock(),this.handleWheel($)},{passive:!1,capture:!0}),J()}setScrollLock(){if(this.isScrollingOrSwiping=!0,this.scrollLockTimer)clearTimeout(this.scrollLockTimer);this.scrollLockTimer=window.setTimeout(()=>{this.isScrollingOrSwiping=!1},200)}hideCursor(){if(this.isMouseHidden)return;if(!this.isReader)return;console.log("[TurnerManager] Hiding cursor (Native + CSS)"),q("set_cursor_visible",{visible:!1}).catch((J)=>console.error(J)),document.documentElement.classList.add("wxrd-hide-cursor"),j("wxrd-cursor-hide",`
      html.wxrd-hide-cursor,
      html.wxrd-hide-cursor * {
        cursor: none !important;
      }
    `),this.isMouseHidden=!0}showCursor(){if(!this.isMouseHidden)return;console.log("[TurnerManager] Showing cursor (Native + CSS)"),q("set_cursor_visible",{visible:!0}).catch((J)=>console.error(J)),document.documentElement.classList.remove("wxrd-hide-cursor"),W("wxrd-cursor-hide"),this.isMouseHidden=!1}resetMouseState(){if(this.showCursor(),this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null}handleWheel(J){if(!this.isReader)return;let Z=this.siteRegistry.getCurrentAdapter();if(!Z||!Z.isDoubleColumn())return;let{deltaX:$,deltaY:z}=J;if(Math.abs($)>Math.abs(z))J.preventDefault();else return;if(this.swipeCooldown)return;if(Math.abs($)<2)return;if(this.swipeAccumulator+=$,this.swipeResetTimer)clearTimeout(this.swipeResetTimer);this.swipeResetTimer=setTimeout(()=>{this.swipeAccumulator=0},250);let G=50;if(this.swipeAccumulator>=G)console.log("[TurnerManager] Swipe left detected, next page"),Z.nextPage(),this.swipeAccumulator=0,this.startCooldown();else if(this.swipeAccumulator<=-G)console.log("[TurnerManager] Swipe right detected, prev page"),Z.prevPage(),this.swipeAccumulator=0,this.startCooldown()}startCooldown(){this.swipeCooldown=!0,setTimeout(()=>{this.swipeCooldown=!1,this.swipeAccumulator=0},800)}updateState(J){let Z=J.autoFlip||{active:!1,interval:15,keepAwake:!0},$=!!Z.active;if($&&this.isProcessingUpdate)return;let z=Z.interval>0?Z.interval:15,P=!!Z.keepAwake;if(console.log("[TurnerManager] updateState:",{newActive:$,newInterval:z,isActive:this.isActive}),!$){if(this.isActive)this.isProcessingUpdate=!0,this.stopAll(),this.isActive=!1,this.isProcessingUpdate=!1}else if(!this.isActive)this.isProcessingUpdate=!0,this.isActive=!0,this.intervalSeconds=z,this.keepAwake=P,this.start(),setTimeout(()=>{this.isProcessingUpdate=!1},100);else if(this.intervalSeconds!==z||this.keepAwake!==P)this.isProcessingUpdate=!0,this.stopAll(),this.intervalSeconds=z,this.keepAwake=P,this.isActive=!0,this.start(),setTimeout(()=>{this.isProcessingUpdate=!1},100)}start(){let J=this.siteRegistry.getCurrentAdapter();if(!J){console.warn("[TurnerManager] No adapter found");return}if(J.isDoubleColumn())this.startDoubleColumnLogic(J);else this.startSingleColumnLogic(J)}stopAll(){if(this.isActive=!1,this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.originalTitle)document.title=this.originalTitle,this.originalTitle=null;this.elapsedTime=0}startDoubleColumnLogic(J){if(this.doubleTimer)return;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.countdown=this.intervalSeconds,!this.originalTitle)this.originalTitle=document.title;this.doubleTimer=setInterval(()=>{if(!J.isDoubleColumn()){this.stopAll(),this.startSingleColumnLogic(J);return}if(document.hidden&&!this.keepAwake)return;if(this.countdown--,document.title=`${this.appName} - 自动翻页 - ${this.countdown} 秒`,this.countdown<=0)this.setScrollLock(),J.nextPage(),this.countdown=this.intervalSeconds},1000)}startSingleColumnLogic(J){if(this.singleRafId)return;if(this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(!B.isRestorationComplete()){console.log("[TurnerManager] Waiting for scroll restore..."),setTimeout(()=>this.startSingleColumnLogic(J),200);return}if(this.countdown=this.intervalSeconds,this.elapsedTime=0,!this.originalTitle)this.originalTitle=document.title;this.lastFrameTime=performance.now(),this.lastScrollTime=performance.now(),this.singleRafId=requestAnimationFrame((Z)=>this.singleColumnLoop(Z,J))}singleColumnLoop(J,Z){if(!this.isActive){this.singleRafId=null;return}if(Z.isDoubleColumn()){this.stopAll(),this.startDoubleColumnLogic(Z);return}let $=J-this.lastFrameTime;if(this.lastFrameTime=J,$>100)$=16,this.accumulatedMove=0;else if($>50)$=50;if(this.elapsedTime+=$,this.elapsedTime>=1000){let K=window.scrollY,L=document.documentElement.scrollHeight,w=window.innerHeight,h=Math.max(1,L-w),y=Math.min(100,Math.max(0,Math.round(K/h*1000)/10));this.elapsedTime-=1000,document.title=`${this.appName} - 自动翻页 - 已读 ${y}%`}if(document.hidden&&!this.keepAwake){this.singleRafId=requestAnimationFrame((K)=>this.singleColumnLoop(K,Z));return}let z=J-this.lastScrollTime;if(z<30){this.singleRafId=requestAnimationFrame((K)=>this.singleColumnLoop(K,Z));return}this.lastScrollTime=J;let P=window.innerHeight,G=this.intervalSeconds>0?this.intervalSeconds:30,N=P/(G*1000)*z;if(this.accumulatedMove+=N,this.accumulatedMove>=1){this.isScrollingOrSwiping=!0;let K=Math.floor(this.accumulatedMove);window.scrollBy(0,K),this.accumulatedMove-=K;let L=Z.isAtBottom();if(L&&!this.bottomTriggered){if(console.log("[TurnerManager] Reached bottom, triggering next page"),this.bottomTriggered=!0,Z.nextPage(),typeof Z.clickNextChapter==="function")Z.clickNextChapter();if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;console.log("[TurnerManager] Waiting 10s before resuming..."),setTimeout(()=>{if(this.bottomTriggered=!1,this.isActive)this.startSingleColumnLogic(Z)},1e4);return}else if(!L)this.bottomTriggered=!1}this.singleRafId=requestAnimationFrame((K)=>this.singleColumnLoop(K,Z))}}class f{isReader=!1;initialized=!1;constructor(){this.init()}async init(){E("menu-action",(J)=>{this.handleMenuAction(J.payload)}),window.addEventListener("ipc:route-changed",(J)=>{this.isReader=J.detail.isReader,this.updateMenuEnabledStatus()}),window.addEventListener("wxrd:route-changed",(J)=>{this.isReader=J.detail.isReader,this.updateMenuEnabledStatus()}),window.addEventListener("ipc:title-changed",(J)=>{console.log("[MenuManager] Title changed:",J.detail.title),this.updateWindowTitle(J.detail.title)}),await R(),this.isReader=this.checkIsReader(),this.initialized=!0,Q.subscribe(async(J)=>{if(J.zoom!==void 0)try{await q("set_zoom",{value:J.zoom})}catch(Z){console.error("[MenuManager] set_zoom failed:",Z)}await this.syncMenuState(J)}),await this.syncMenuState()}checkIsReader(){let J=window.location.href,Z=window.location.pathname;return Z.includes("/web/reader/")||J.includes("/web/reader/")||Z.startsWith("/reader")||J.includes("reader")}async updateMenuEnabledStatus(){if(!window.__TAURI__)return;try{await q("set_menu_item_enabled",{id:"reader_wide",enabled:this.isReader}),await q("set_menu_item_enabled",{id:"hide_toolbar",enabled:this.isReader}),await q("set_menu_item_enabled",{id:"auto_flip",enabled:this.isReader}),await q("set_menu_item_enabled",{id:"zoom_in",enabled:!0}),await q("set_menu_item_enabled",{id:"zoom_out",enabled:!0}),await q("set_menu_item_enabled",{id:"zoom_reset",enabled:!0})}catch(J){console.error("[MenuManager] Error updating menu enabled status:",J)}}async updateWindowTitle(J){if(!window.__TAURI__)return;try{await q("set_title",{title:J})}catch(Z){console.error("[MenuManager] Error setting window title:",Z)}}async syncMenuState(J=Q.get()){if(!this.initialized)return;let Z=!!J.readerWide,$=!!J.hideToolbar,z=!!J.autoFlip?.active;await this.updateMenuEnabledStatus();try{await q("update_menu_state",{id:"reader_wide",state:Z}),await q("update_menu_state",{id:"hide_toolbar",state:$}),await q("update_menu_state",{id:"auto_flip",state:z})}catch(P){console.error("[MenuManager] Error updating menu state:",P)}}handleMenuAction(J){let Z=Q.get();switch(J){case"reader_wide":{let $=!Z.readerWide,z={readerWide:$};if(!$&&Z.hideToolbar)z.hideToolbar=!1;Q.update(z)}break;case"hide_toolbar":Q.update({hideToolbar:!Z.hideToolbar});break;case"auto_flip":{let $=Z.autoFlip||{active:!1,interval:15,keepAwake:!0},z=!$.active;Q.update({autoFlip:{...$,active:z}})}break;case"zoom_in":{let $=Z.zoom||1;$=Math.round(($+0.1)*10)/10,Q.update({zoom:$})}break;case"zoom_out":{let $=Z.zoom||1;if($=Math.round(($-0.1)*10)/10,$<0.1)$=0.1;Q.update({zoom:$})}break;case"zoom_reset":Q.update({zoom:1});break}}}class C{constructor(){this.init()}initLinks(){window.open=function(J,Z,$){if(J)window.location.href=J.toString();return null},document.addEventListener("click",(J)=>{let $=J.target.closest("a");if($&&$.target==="_blank")$.target="_self"},!0)}shouldEnableDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}applyTheme(J){let Z=window.self!==window.top,$=`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,z=`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    `,P=Z?`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `:`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,G="wxrd-dark-mode-filter";if(J)j("wxrd-dark-mode-filter",P);else W("wxrd-dark-mode-filter")}initDarkMode(){this.applyTheme(this.shouldEnableDarkMode()),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(J)=>{this.applyTheme(J.matches)})}init(){this.initLinks(),this.initDarkMode()}}class _{isWide=!1;isHideToolbar=!1;isReader=!1;siteRegistry=X();constructor(){this.init()}async init(){if(this.isReader=this.siteRegistry.isReaderPage(),!this.isReader)console.log("[StyleManager] Starting on non-reader page, clearing any leftover reader styles"),this.clearReaderStyles();this.handleTheme(),Q.subscribe((J)=>{this.updateStyles(J)}),window.addEventListener("ipc:route-changed",(J)=>{let Z=this.isReader;if(this.isReader=J.detail.isReader,Z&&!this.isReader)console.log("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles()}),window.addEventListener("wxrd:route-changed",(J)=>{let Z=this.isReader;if(this.isReader=J.detail.isReader,Z&&!this.isReader)console.log("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles()})}handleTheme(){let J=($)=>{let z=this.siteRegistry.getCurrentAdapter();if(z&&z.getDarkThemeCSS&&z.getLightThemeCSS){let P=$.matches?z.getDarkThemeCSS():z.getLightThemeCSS();j("wxrd-base-bg",P)}else{let P=$.matches?"html, body { background-color: #222222 !important; }":"html, body { background-color: #ffffff !important; }";j("wxrd-base-bg",P)}},Z=window.matchMedia("(prefers-color-scheme: dark)");J(Z),Z.addEventListener("change",J)}mouseHideTimer=null;isMouseHidden=!1;initMouseAutoHide(){let J=()=>{if(this.isMouseHidden)this.showCursor();if(this.mouseHideTimer)window.clearTimeout(this.mouseHideTimer),this.mouseHideTimer=null;if(this.isReader)this.mouseHideTimer=window.setTimeout(()=>{this.hideCursor()},3000)};window.addEventListener("mousemove",J),window.addEventListener("mousedown",J),window.addEventListener("keydown",J),window.addEventListener("wheel",J)}hideCursor(){if(this.isMouseHidden)return;if(!this.isReader)return;j("wxrd-cursor-hide",`
      body, body * {
        cursor: none !important;
      }
    `),this.isMouseHidden=!0}showCursor(){if(!this.isMouseHidden)return;W("wxrd-cursor-hide"),this.isMouseHidden=!1}updateStyles(J){let Z=!!J.readerWide,$=!!J.hideToolbar;if(Z!==this.isWide||$!==this.isHideToolbar)this.isWide=Z,this.isHideToolbar=$,this.applyStyles()}applyStyles(){if(!this.isReader){console.log("[StyleManager] Not on reader page, skipping reader styles");return}let J=this.siteRegistry.getCurrentAdapter();if(J){let Z=J.getWideModeCSS(this.isWide),$=J.getToolbarCSS(this.isHideToolbar);j("wxrd-wide-mode",Z),j("wxrd-hide-toolbar",$)}else console.warn("[StyleManager] No adapter found, styles not applied");window.dispatchEvent(new Event("resize"))}clearReaderStyles(){W("wxrd-wide-mode"),W("wxrd-hide-toolbar"),console.log("[StyleManager] Reader styles cleared")}}class T{constructor(){this.init()}init(){}}(function(){if(window.wxrd_injected){console.log("Weixin Reader Inject Script already loaded. Skipping.");return}window.wxrd_injected=!0,console.log("Weixin Reader Inject Script Initializing...");let J=X();J.register(new x);let Z=J.getCurrentAdapter();if(Z)console.log(`[Inject] Detected site: ${Z.name}`);else console.warn("[Inject] No matching adapter found for current site");let $=J.isReaderPage();if(new M,new f,new V,new F,!$)new C;new _,new T,console.log("Weixin Reader Inject Script Loaded (Modular v4 - IPCManager Architecture)")})();
