class I{static instance;adapters=new Map;currentAdapter=null;constructor(){}static getInstance(){if(!I.instance)I.instance=new I;return I.instance}register(q){this.adapters.set(q.id,q),console.log(`[SiteRegistry] Registered adapter: ${q.name} (${q.id})`)}registerAll(q){q.forEach((J)=>this.register(J))}getCurrentAdapter(){if(this.currentAdapter){let q=this.currentAdapter;if("matchesCurrentDomain"in q&&typeof q.matchesCurrentDomain==="function"){if(q.matchesCurrentDomain())return q}}for(let q of this.adapters.values())if("matchesCurrentDomain"in q&&typeof q.matchesCurrentDomain==="function"){if(q.matchesCurrentDomain())return this.currentAdapter=q,console.log(`[SiteRegistry] Detected site: ${q.name}`),q}return this.currentAdapter=null,console.warn("[SiteRegistry] No matching adapter found for current site"),null}getAdapter(q){return this.adapters.get(q)}getAllAdapters(){return Array.from(this.adapters.values())}isReaderPage(){let q=this.getCurrentAdapter();return q?q.isReaderPage():!1}isHomePage(){let q=this.getCurrentAdapter();return q?q.isHomePage():!1}getReaderMenuItems(){let q=this.getCurrentAdapter();if(q&&q.getReaderMenuItems)return q.getReaderMenuItems();return["reader_wide","hide_toolbar","auto_flip"]}}var B=()=>I.getInstance();class x{matchesCurrentDomain(){let q=window.location.hostname;return(Array.isArray(this.domain)?this.domain:[this.domain]).some((Z)=>q===Z||q.endsWith(`.${Z}`))}matchesPath(q){let J=window.location.pathname,Z=window.location.href;if(typeof q==="string")return J.includes(q)||Z.includes(q);else return q.test(J)||q.test(Z)}triggerKey(q){let J=new KeyboardEvent("keydown",{key:q,code:q==="Right"?"ArrowRight":q==="Left"?"ArrowLeft":q,keyCode:q==="Right"?39:q==="Left"?37:0,bubbles:!0,cancelable:!0});document.dispatchEvent(J)}clickElement(q){let J=document.querySelector(q);if(J)return J.click(),!0;return!1}}class b extends x{id="weread";name="微信读书";domain="weread.qq.com";isReaderPage(){return this.matchesPath("/web/reader/")}isHomePage(){let q=window.location.pathname;return q==="/"||q==="/web"||q.startsWith("/web/shelf")}getWideModeCSS(q){if(q)return`
        /* 微信读书 - 宽屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 96% !important;
          max-width: calc(100vw - 224px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 80px) !important;
        }
      `;else return`
        /* 微信读书 - 窄屏模式 */
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent,
        .app_content {
          width: 80% !important;
          max-width: calc(100vw - 424px) !important;
        }
        body:has(.readerControls:not([is-horizontal="true"])) .readerControls {
          margin-left: calc(50vw - 120px) !important;
        }
      `}getToolbarCSS(q){if(q)return`
        /* 微信读书 - 隐藏工具栏 */
        .readerControls {
          display: none !important;
        }
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 124px) !important;
        }
        .app_content {
          max-width: calc(100vw - 124px) !important;
        }
      `;else return`
        /* 微信读书 - 显示工具栏 */
        .readerControls {
          display: block !important;
        }
        .readerTopBar,
        body:has(.readerControls[is-horizontal="true"]) .readerChapterContent {
          max-width: calc(100vw - 224px) !important;
        }
        .app_content {
          max-width: calc(100vw - 224px) !important;
        }
      `}getDarkThemeCSS(){return`
      html, body {
        background-color: #222222 !important;
      }
    `}getLightThemeCSS(){return`
      html, body {
        background-color: #ffffff !important;
      }
    `}nextPage(){this.triggerKey("Right")}prevPage(){this.triggerKey("Left")}isDoubleColumn(){return!!document.querySelector('.readerControls[is-horizontal="true"]')}isAtBottom(){let q=document.documentElement.scrollHeight;return window.innerHeight+window.scrollY>=q-300}getNextChapterSelector(){return".readerFooter_button"}clickNextChapter(){let q=document.querySelector(this.getNextChapterSelector());if(q)q.click()}getReaderMenuItems(){return["reader_wide","hide_toolbar","auto_flip"]}}var G=(q,J)=>{if(window.__TAURI__)return window.__TAURI__.core.invoke(q,J);return console.warn(`[Tauri] Invoke '${q}' failed: API not found`),Promise.resolve({})},O=(q,J)=>{if(window.__TAURI__)return window.__TAURI__.event.listen(q,J);return console.warn(`[Tauri] Listen '${q}' failed: API not found`),Promise.resolve(()=>{})};var H=()=>{return new Promise((q)=>{if(window.__TAURI__){q();return}let J=setInterval(()=>{if(window.__TAURI__)clearInterval(J),q()},10);setTimeout(()=>{clearInterval(J),q()},2000)})},R=async()=>{await H();let q=100,J=50;console.log("[Tauri] Waiting for IPC to be ready...");for(let Z=0;Z<q;Z++)try{await G("get_app_name"),console.log(`[Tauri] IPC ready after ${Z*J}ms`);return}catch($){if(Z<q-1)await new Promise((z)=>setTimeout(z,J))}console.warn(`[Tauri] IPC not ready after ${q*J}ms, continuing anyway`)},N=(q)=>{if(window.__TAURI__)G("log_to_file",{message:q}).catch(()=>{});else console.log(q)};class f{data;version;constructor(q,J=0){this.data=q,this.version=J,this.data._version=this.version}getData(){return{...this.data}}getVersion(){return this.version}tryUpdate(q){let J=this.version+1,Z={...this.data,...q,_version:J};return this.data=Z,this.version=J,{success:!0,version:J,data:this.getData()}}loadFromExternal(q,J){if(J>=this.version)return this.data={...q,_version:J},this.version=J,!0;return!1}isStale(q){return q>this.version}forceSet(q,J){this.data={...q,_version:J},this.version=J}}class K{static instance;lock=null;listeners=new Set;initialized=!1;constructor(){}static getInstance(){if(!K.instance)K.instance=new K;return K.instance}async init(){if(this.initialized)return;try{let q=await G("get_settings")||{},J=q._version||0,Z={_version:J,readerWide:!1,hideToolbar:!1,zoom:0.8,lastPage:!0,autoUpdate:!0,...q,autoFlip:{active:!1,interval:15,keepAwake:!0,...q.autoFlip||{}}};this.lock=new f(Z,J),console.log("[SettingsStore] Initialized optimistic lock with version:",J)}catch(q){console.error("SettingsStore: Failed to load settings",q);let J={_version:0,readerWide:!1,hideToolbar:!1,zoom:0.8,lastPage:!0,autoUpdate:!0,autoFlip:{active:!1,interval:15,keepAwake:!0}};this.lock=new f(J,0)}O("settings-updated",async()=>{if(!this.lock)return;let q=await G("get_settings")||{},J=q._version||0;if(console.log("[SettingsStore] Received settings-updated event, backend version:",J,"local version:",this.lock.getVersion()),this.lock.loadFromExternal(q,J))console.log("[SettingsStore] Loaded newer version from backend:",J),this.notify();else console.log("[SettingsStore] Ignoring older version from backend:",J,"<",this.lock.getVersion())}),this.initialized=!0,this.notify()}get(){return this.lock?this.lock.getData():{}}async update(q){if(!this.lock){console.error("[SettingsStore] Lock not initialized");return}let{_version:J,...Z}=q,$=this.lock.tryUpdate(Z);console.log("[SettingsStore] Update: version",$.version-1,"->",$.version,"partial:",Z);try{await G("save_settings",{settings:$.data,version:$.version}),console.log("[SettingsStore] Saved successfully with version:",$.version)}catch(z){console.error("[SettingsStore] Failed to save settings",z),this.lock.forceSet($.data,$.version-1)}this.notify()}subscribe(q){if(this.listeners.add(q),this.initialized&&this.lock)q(this.lock.getData());return()=>this.listeners.delete(q)}notify(){if(!this.lock)return;let q=this.lock.getData();this.listeners.forEach((J)=>J(q))}}var Q=K.getInstance();class V{siteRegistry=B();currentIsReader=!1;initialized=!1;scrollSaveTimer=null;lastSavedScrollY=0;constructor(){this.init()}async init(){await Q.init(),this.monitorRoute(),this.monitorTitle(),this.monitorScroll()}monitorRoute(){let q=()=>{let $=window.location.href,z=window.location.pathname,j=this.siteRegistry.isReaderPage(),X=this.siteRegistry.getCurrentAdapter();console.log("[IPCManager] Route check:",{url:$,pathname:z,isReader:j,adapter:X?.name||"none",initialized:this.initialized});let Y=this.currentIsReader!==j;if(this.currentIsReader=j,this.handleLastPageSaving(j,$),Y)this.dispatchRouteChanged(j,$,z)};window.addEventListener("popstate",q);let J=history.pushState;history.pushState=function(...$){let z=J.apply(this,$);return q(),z};let Z=history.replaceState;history.replaceState=function(...$){let z=Z.apply(this,$);return q(),z},q()}handleLastPageSaving(q,J){let Z=Q.get();if(Z.lastPage&&q){if(Z.lastReaderUrl!==J)console.log("[IPCManager] Saving reader URL:",J),Q.update({lastReaderUrl:J})}}dispatchRouteChanged(q,J,Z){let $={isReader:q,url:J,pathname:Z};window.dispatchEvent(new CustomEvent("wxrd:route-changed",{detail:$})),console.log("[IPCManager] Dispatching ipc:route-changed",$),window.dispatchEvent(new CustomEvent("ipc:route-changed",{detail:$}))}monitorTitle(){let q=document.querySelector("title");if(q)new MutationObserver(()=>{this.dispatchTitleChanged()}).observe(q,{childList:!0,characterData:!0,subtree:!0}),this.dispatchTitleChanged()}dispatchTitleChanged(){if(document.title&&document.title.trim()!==""){let q={title:document.title};console.log("[IPCManager] Dispatching ipc:title-changed",q),window.dispatchEvent(new CustomEvent("ipc:title-changed",{detail:q}))}}monitorScroll(){window.addEventListener("scroll",()=>{if(!this.currentIsReader)return;if(!Q.get().lastPage)return;let J=this.siteRegistry.getCurrentAdapter();if(!J||J.isDoubleColumn())return;let Z=window.scrollY;if(Math.abs(Z-this.lastSavedScrollY)<50)return;if(this.scrollSaveTimer)clearTimeout(this.scrollSaveTimer);this.scrollSaveTimer=setTimeout(()=>{this.lastSavedScrollY=Z,console.log("[IPCManager] Saving scroll position:",Z),Q.update({scrollPosition:Z})},500)},{passive:!0})}}var F="wxrd_has_restored",L="wxrd_scroll_restored";class A{appName="微信阅读";siteRegistry=B();constructor(){this.init()}async init(){await H();try{this.appName=await G("get_app_name")||"微信阅读"}catch(q){console.error("Failed to get app name:",q)}await Q.init(),window.addEventListener("pagehide",()=>{this.clearAutoFlipOnExit()}),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden")this.clearAutoFlipOnExit()});try{let q=await G("get_settings");console.log("[AppManager] Backend settings:",JSON.stringify(q))}catch(q){console.error("[AppManager] Failed to get backend settings:",q)}await this.restoreLastPage(),this.restoreScrollPosition()}clearAutoFlipOnExit(){let q=Q.get();if(q.autoFlip?.active)console.log("[AppManager] Clearing autoFlip.active on exit"),N("[AppManager] Clearing autoFlip.active on exit"),G("save_settings",{settings:{autoFlip:{active:!1,interval:q.autoFlip.interval||15,keepAwake:q.autoFlip.keepAwake!==!1}}})}async restoreLastPage(){let q=sessionStorage.getItem(F);if(N(`[AppManager] Session flag: ${q}`),q==="true"){N("[AppManager] Already restored in this session, skipping"),console.log("[AppManager] Already restored in this session, skipping");return}let J=Q.get(),Z=this.siteRegistry.isReaderPage(),$=`[AppManager] restoreLastPage check: isReader=${Z}, lastPage=${J.lastPage}, lastReaderUrl=${J.lastReaderUrl}`;if(N($),console.log("[AppManager] restoreLastPage check:",{isReader:Z,lastPage:J.lastPage,lastReaderUrl:J.lastReaderUrl}),!Z&&J.lastPage&&J.lastReaderUrl){let z=`[AppManager] Restoring last page: ${J.lastReaderUrl}`;N(z),console.log("[AppManager] Restoring last page:",J.lastReaderUrl),sessionStorage.setItem(F,"true"),window.location.href=J.lastReaderUrl}else{let z=`[AppManager] Marking as restored (no navigation needed): isReader=${Z}, lastPage=${J.lastPage}, hasUrl=${!!J.lastReaderUrl}`;N(z),console.log("[AppManager] Marking as restored (no navigation needed)"),sessionStorage.setItem(F,"true")}}restoreScrollPosition(){if(sessionStorage.getItem(L)==="true"){console.log("[AppManager] Scroll already restored in this session, skipping");return}let J=Q.get();if(!this.siteRegistry.isReaderPage()||!J.lastPage||!J.scrollPosition){sessionStorage.setItem(L,"true");return}let $=this.siteRegistry.getCurrentAdapter();if(!$||$.isDoubleColumn()){sessionStorage.setItem(L,"true");return}let z=J.scrollPosition;console.log("[AppManager] Planning to restore scroll position:",z),N(`[AppManager] Planning to restore scroll position: ${z}`);let j=0,X=50,Y=()=>{j++;let W=document.documentElement.scrollHeight;if(W>=z){console.log(`[AppManager] Height sufficient (${W} >= ${z}), restoring directly.`),window.scrollTo(0,z),Q.update({scrollPosition:0});return}if(j<X){console.log(`[AppManager] Chasing scroll: height ${W} < target ${z}, scrolling to bottom.`),window.scrollTo(0,W),document.dispatchEvent(new Event("scroll"));try{document.dispatchEvent(new WheelEvent("wheel",{deltaY:100,bubbles:!0}))}catch(M){}setTimeout(Y,100)}else console.log("[AppManager] Max restore attempts reached, giving up."),window.scrollTo(0,z),Q.update({scrollPosition:0})};setTimeout(Y,500),sessionStorage.setItem(L,"true")}}class U{static findAnchorElement(){let q=window.innerWidth/2,J=Math.min(window.innerHeight*0.3,200),Z=document.elementFromPoint(q,J);if(Z)return{element:Z,top:Z.getBoundingClientRect().top};return null}static restoreAnchorPosition(q){if(!q.element.isConnected){console.warn("[PageScroller] Anchor element is detached, cannot restore position");return}q.element.scrollIntoView({behavior:"instant",block:"start"}),window.scrollBy({top:-q.top,behavior:"instant"})}static async preloadChapter(){let q=window.scrollY;console.log("[PageScroller] Starting preload chase");let J=this.findAnchorElement(),Z=20000,$=10,z=0,j=0;while(z<$){if(document.querySelector(".readerFooter"))break;let X=document.documentElement.scrollHeight;if(z>0&&X===j)break;j=X,z++,window.scrollTo(0,X+Z)}if(console.log("[PageScroller] Preload done, bouncing back"),J)this.restoreAnchorPosition(J);else window.scrollTo({top:q,behavior:"instant"})}static waitForNewContent(q){let J=document.documentElement.scrollHeight,Z=0,$=50,z=setInterval(()=>{if(Z++,document.documentElement.scrollHeight!==J)clearInterval(z),console.log("[PageScroller] New content detected"),q();else if(Z>=$)clearInterval(z),console.log("[PageScroller] Timeout waiting for content (no change)")},100)}}class E{isActive=!1;intervalSeconds=30;keepAwake=!1;doubleTimer=null;singleRafId=null;lastFrameTime=0;lastScrollTime=0;accumulatedMove=0;countdown=30;originalTitle=null;appName="微信阅读";elapsedTime=0;siteRegistry=B();isProcessingUpdate=!1;swipeAccumulator=0;swipeThreshold=120;swipeResetTimer=null;swipeCooldown=!1;isReader=!1;bottomTriggered=!1;constructor(){this.init()}async init(){try{this.appName=await G("get_app_name")||"微信阅读"}catch(q){console.error("TurnerManager: Failed to get app name",q)}this.isReader=this.siteRegistry.isReaderPage(),this.initSwipeGesture(),Q.subscribe((q)=>{this.updateState(q)}),window.addEventListener("ipc:route-changed",(q)=>{let J=q.detail.isReader;if(this.isReader=J,console.log("[TurnerManager] Route changed:",{isReader:J,isActive:this.isActive}),!J){if(this.isActive){console.log("[TurnerManager] Stopping auto flip and clearing setting"),this.stopAll();let Z=Q.get();if(Z.autoFlip?.active)Q.update({autoFlip:{...Z.autoFlip,active:!1}})}}})}initSwipeGesture(){window.addEventListener("wheel",this.handleWheel.bind(this),{passive:!1})}handleWheel(q){if(!this.isReader)return;let J=this.siteRegistry.getCurrentAdapter();if(!J||!J.isDoubleColumn())return;let{deltaX:Z,deltaY:$}=q;if(Math.abs(Z)>Math.abs($))q.preventDefault();else return;if(this.swipeCooldown)return;if(this.swipeAccumulator+=Z,this.swipeResetTimer)clearTimeout(this.swipeResetTimer);this.swipeResetTimer=setTimeout(()=>{this.swipeAccumulator=0},250);let j=50;if(this.swipeAccumulator>=j)console.log("[TurnerManager] Swipe left detected, next page"),J.nextPage(),this.swipeAccumulator=0,this.startCooldown();else if(this.swipeAccumulator<=-j)console.log("[TurnerManager] Swipe right detected, prev page"),J.prevPage(),this.swipeAccumulator=0,this.startCooldown()}startCooldown(){this.swipeCooldown=!0,setTimeout(()=>{this.swipeCooldown=!1,this.swipeAccumulator=0},800)}updateState(q){let J=q.autoFlip||{active:!1,interval:15,keepAwake:!0},Z=!!J.active;if(Z&&this.isProcessingUpdate)return;let $=J.interval>0?J.interval:15,z=!!J.keepAwake;if(console.log("[TurnerManager] updateState:",{newActive:Z,newInterval:$,isActive:this.isActive}),!Z){if(this.isActive)this.isProcessingUpdate=!0,this.stopAll(),this.isActive=!1,this.isProcessingUpdate=!1}else if(!this.isActive)this.isProcessingUpdate=!0,this.isActive=!0,this.intervalSeconds=$,this.keepAwake=z,this.start(),setTimeout(()=>{this.isProcessingUpdate=!1},100);else if(this.intervalSeconds!==$||this.keepAwake!==z)this.isProcessingUpdate=!0,this.stopAll(),this.intervalSeconds=$,this.keepAwake=z,this.isActive=!0,this.start(),setTimeout(()=>{this.isProcessingUpdate=!1},100)}start(){let q=this.siteRegistry.getCurrentAdapter();if(!q){console.warn("[TurnerManager] No adapter found");return}if(q.isDoubleColumn())this.startDoubleColumnLogic(q);else this.startSingleColumnLogic(q)}stopAll(){if(this.isActive=!1,this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.originalTitle)document.title=this.originalTitle,this.originalTitle=null;this.elapsedTime=0}startDoubleColumnLogic(q){if(this.doubleTimer)return;if(this.singleRafId)cancelAnimationFrame(this.singleRafId),this.singleRafId=null;if(this.countdown=this.intervalSeconds,!this.originalTitle)this.originalTitle=document.title;this.doubleTimer=setInterval(()=>{if(!q.isDoubleColumn()){this.stopAll(),this.startSingleColumnLogic(q);return}if(document.hidden&&!this.keepAwake)return;if(this.countdown--,document.title=`${this.appName} - 自动翻页 - ${this.countdown} 秒`,this.countdown<=0)q.nextPage(),this.countdown=this.intervalSeconds},1000)}startSingleColumnLogic(q){if(this.singleRafId)return;if(this.doubleTimer)clearInterval(this.doubleTimer),this.doubleTimer=null;if(this.countdown=this.intervalSeconds,this.elapsedTime=0,!this.originalTitle)this.originalTitle=document.title;this.lastFrameTime=performance.now(),this.lastScrollTime=performance.now(),U.preloadChapter().catch(console.error).then(()=>{if(!this.isActive){console.log("[TurnerManager] Preload finished but stopped, aborting RAF");return}console.log("[TurnerManager] Preload complete, starting RAF loop");let J=(Z)=>{if(q.isDoubleColumn()){this.stopAll(),this.startDoubleColumnLogic(q);return}if(!this.isActive){this.singleRafId=null;return}let $=Z-this.lastFrameTime;if(this.lastFrameTime=Z,$>1000)$=16,this.accumulatedMove=0;else if($>100)$=Math.min($,50);if(this.elapsedTime+=$,this.elapsedTime>=1000)this.countdown--,this.elapsedTime-=1000,document.title=`${this.appName} - 自动翻页 - ${this.countdown} 秒`;if(document.hidden&&!this.keepAwake){this.singleRafId=requestAnimationFrame(J);return}let z=Z-this.lastScrollTime;if(z<30){this.singleRafId=requestAnimationFrame(J);return}this.lastScrollTime=Z;let j=window.innerHeight,X=this.intervalSeconds>0?this.intervalSeconds:30,W=j/(X*1000)*z;if(this.accumulatedMove+=W,this.accumulatedMove>=1){let M=Math.floor(this.accumulatedMove);window.scrollBy(0,M),this.accumulatedMove-=M;let v=q.isAtBottom();if(v&&!this.bottomTriggered){if(console.log("[TurnerManager] Reached bottom, triggering next page"),this.bottomTriggered=!0,q.nextPage(),typeof q.clickNextChapter==="function")q.clickNextChapter();this.countdown=this.intervalSeconds,U.waitForNewContent(()=>{U.preloadChapter().catch(console.error)}),setTimeout(()=>{this.bottomTriggered=!1},1200)}else if(!v)this.bottomTriggered=!1}this.singleRafId=requestAnimationFrame(J)};this.singleRafId=requestAnimationFrame(J)})}}class C{isReader=!1;initialized=!1;constructor(){this.init()}async init(){O("menu-action",(q)=>{this.handleMenuAction(q.payload)}),window.addEventListener("ipc:route-changed",(q)=>{this.isReader=q.detail.isReader,this.updateMenuEnabledStatus()}),window.addEventListener("wxrd:route-changed",(q)=>{this.isReader=q.detail.isReader,this.updateMenuEnabledStatus()}),window.addEventListener("ipc:title-changed",(q)=>{console.log("[MenuManager] Title changed:",q.detail.title),this.updateWindowTitle(q.detail.title)}),await R(),this.isReader=this.checkIsReader(),this.initialized=!0,Q.subscribe(async(q)=>{if(q.zoom!==void 0)try{await G("set_zoom",{value:q.zoom})}catch(J){console.error("[MenuManager] set_zoom failed:",J)}await this.syncMenuState(q)}),await this.syncMenuState()}checkIsReader(){let q=window.location.href,J=window.location.pathname;return J.includes("/web/reader/")||q.includes("/web/reader/")||J.startsWith("/reader")||q.includes("reader")}async updateMenuEnabledStatus(){if(!window.__TAURI__)return;try{await G("set_menu_item_enabled",{id:"reader_wide",enabled:this.isReader}),await G("set_menu_item_enabled",{id:"hide_toolbar",enabled:this.isReader}),await G("set_menu_item_enabled",{id:"auto_flip",enabled:this.isReader}),await G("set_menu_item_enabled",{id:"zoom_in",enabled:!0}),await G("set_menu_item_enabled",{id:"zoom_out",enabled:!0}),await G("set_menu_item_enabled",{id:"zoom_reset",enabled:!0})}catch(q){console.error("[MenuManager] Error updating menu enabled status:",q)}}async updateWindowTitle(q){if(!window.__TAURI__)return;try{await G("set_title",{title:q})}catch(J){console.error("[MenuManager] Error setting window title:",J)}}async syncMenuState(q=Q.get()){if(!this.initialized)return;let J=!!q.readerWide,Z=!!q.hideToolbar,$=!!q.autoFlip?.active;await this.updateMenuEnabledStatus();try{await G("update_menu_state",{id:"reader_wide",state:J}),await G("update_menu_state",{id:"hide_toolbar",state:Z}),await G("update_menu_state",{id:"auto_flip",state:$})}catch(z){console.error("[MenuManager] Error updating menu state:",z)}}handleMenuAction(q){let J=Q.get();switch(q){case"reader_wide":{let Z=!J.readerWide,$={readerWide:Z};if(!Z&&J.hideToolbar)$.hideToolbar=!1;Q.update($)}break;case"hide_toolbar":Q.update({hideToolbar:!J.hideToolbar});break;case"auto_flip":{let Z=J.autoFlip||{active:!1,interval:15,keepAwake:!0},$=!Z.active;Q.update({autoFlip:{...Z,active:$}})}break;case"zoom_in":{let Z=J.zoom||1;Z=Math.round((Z+0.1)*10)/10,Q.update({zoom:Z})}break;case"zoom_out":{let Z=J.zoom||1;if(Z=Math.round((Z-0.1)*10)/10,Z<0.1)Z=0.1;Q.update({zoom:Z})}break;case"zoom_reset":Q.update({zoom:1});break}}}function P(q,J){let Z=document.getElementById(q);if(!Z)if(Z=document.createElement("style"),Z.id=q,document.head)document.head.appendChild(Z);else if(document.documentElement)document.documentElement.appendChild(Z);else{let $=new MutationObserver((z)=>{for(let j of z)if(j.addedNodes.length>0){if(document.head){document.head.appendChild(Z),$.disconnect();return}else if(document.documentElement){document.documentElement.appendChild(Z),$.disconnect();return}}});$.observe(document,{childList:!0})}Z.innerHTML=J}function D(q){let J=document.getElementById(q);if(J)J.remove()}class T{constructor(){this.init()}initLinks(){window.open=function(q,J,Z){if(q)window.location.href=q.toString();return null},document.addEventListener("click",(q)=>{let Z=q.target.closest("a");if(Z&&Z.target==="_blank")Z.target="_self"},!0)}shouldEnableDarkMode(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}applyTheme(q){let J=window.self!==window.top,Z=`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,$=`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    `,z=J?`
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `:`
      html {
        filter: invert(1) hue-rotate(180deg) !important;
        background-color: #e0e0e0 !important;
      }
    
      img, video, canvas, svg {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      [style*="background-image"] {
        filter: invert(1) hue-rotate(180deg) !important;
      }
      ::-webkit-scrollbar {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-track {
        background-color: #2c2c2c;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
    `,j="wxrd-dark-mode-filter";if(q)P("wxrd-dark-mode-filter",z);else D("wxrd-dark-mode-filter")}initDarkMode(){this.applyTheme(this.shouldEnableDarkMode()),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(q)=>{this.applyTheme(q.matches)})}init(){this.initLinks(),this.initDarkMode()}}class _{isWide=!1;isHideToolbar=!1;isReader=!1;siteRegistry=B();constructor(){this.init()}async init(){if(this.isReader=this.siteRegistry.isReaderPage(),!this.isReader)console.log("[StyleManager] Starting on non-reader page, clearing any leftover reader styles"),this.clearReaderStyles();this.handleTheme(),Q.subscribe((q)=>{this.updateStyles(q)}),window.addEventListener("ipc:route-changed",(q)=>{let J=this.isReader;if(this.isReader=q.detail.isReader,J&&!this.isReader)console.log("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles()}),window.addEventListener("wxrd:route-changed",(q)=>{let J=this.isReader;if(this.isReader=q.detail.isReader,J&&!this.isReader)console.log("[StyleManager] Leaving reader page, clearing reader styles"),this.clearReaderStyles()})}handleTheme(){let q=(Z)=>{let $=this.siteRegistry.getCurrentAdapter();if($&&$.getDarkThemeCSS&&$.getLightThemeCSS){let z=Z.matches?$.getDarkThemeCSS():$.getLightThemeCSS();P("wxrd-base-bg",z)}else{let z=Z.matches?"html, body { background-color: #222222 !important; }":"html, body { background-color: #ffffff !important; }";P("wxrd-base-bg",z)}},J=window.matchMedia("(prefers-color-scheme: dark)");q(J),J.addEventListener("change",q)}updateStyles(q){let J=!!q.readerWide,Z=!!q.hideToolbar;if(J!==this.isWide||Z!==this.isHideToolbar)this.isWide=J,this.isHideToolbar=Z,this.applyStyles()}applyStyles(){if(!this.isReader){console.log("[StyleManager] Not on reader page, skipping reader styles");return}let q=this.siteRegistry.getCurrentAdapter();if(q){let J=q.getWideModeCSS(this.isWide),Z=q.getToolbarCSS(this.isHideToolbar);P("wxrd-wide-mode",J),P("wxrd-hide-toolbar",Z)}else console.warn("[StyleManager] No adapter found, styles not applied");window.dispatchEvent(new Event("resize"))}clearReaderStyles(){D("wxrd-wide-mode"),D("wxrd-hide-toolbar"),console.log("[StyleManager] Reader styles cleared")}}class w{constructor(){this.init()}init(){}}(function(){if(window.wxrd_injected){console.log("Weixin Reader Inject Script already loaded. Skipping.");return}window.wxrd_injected=!0,console.log("Weixin Reader Inject Script Initializing...");let q=B();q.register(new b);let J=q.getCurrentAdapter();if(J)console.log(`[Inject] Detected site: ${J.name}`);else console.warn("[Inject] No matching adapter found for current site");let Z=q.isReaderPage();if(new V,new C,new A,new E,!Z)new T;new _,new w,console.log("Weixin Reader Inject Script Loaded (Modular v4 - IPCManager Architecture)")})();
